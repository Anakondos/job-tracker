<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Job Tracker</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
      :root {
        --bg: #0b0f17;
        --panel: #111827;
        --panel2: #0f172a;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: rgba(255, 255, 255, 0.1);
        --accent: #60a5fa;
        --danger: #ef4444;
        --ok: #22c55e;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Arial;
        background: var(--bg);
        color: var(--text);
      }
      header {
        padding: 18px 18px 10px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          transparent
        );
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }
      .header-left {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .my-location-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.15s;
        user-select: none;
      }
      .my-location-toggle:hover {
        background: var(--hover);
        border-color: var(--accent);
      }
      .my-location-toggle input {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      .my-location-toggle input:checked + span {
        color: var(--accent);
      }
      .refresh-btn {
        background: var(--card);
        border: 1px solid var(--border);
        color: var(--fg);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        white-space: nowrap;
        transition: all 0.15s;
      }
      .refresh-btn:hover:not(:disabled) {
        background: var(--hover);
        border-color: var(--accent);
      }
      .refresh-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .env-badge {
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .env-badge.dev {
        background: #f59e0b;
        color: #000;
      }
      .env-badge.prod {
        background: #22c55e;
        color: #000;
      }
      /* DEV environment header highlight */
      body.env-dev header {
        border-bottom: 2px solid #f59e0b;
      }
      .sub {
        margin-top: 6px;
        color: var(--muted);
        font-size: 12px;
      }
      /* Tabs */
      .tabs {
        display: flex;
        gap: 0;
        border-bottom: 1px solid var(--border);
        padding: 0 18px;
        background: var(--panel);
      }
      .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        color: var(--muted);
        font-size: 14px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        transition: all 0.15s;
      }
      .tab-btn:hover {
        color: var(--text);
      }
      .tab-btn.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      
      /* Companies table */
      .companies-summary {
        display: flex;
        gap: 20px;
        padding: 16px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 16px;
      }
      .summary-item {
        text-align: center;
      }
      .summary-value {
        font-size: 28px;
        font-weight: 600;
        color: var(--text);
      }
      .summary-label {
        font-size: 12px;
        color: var(--muted);
      }
      .company-row {
        cursor: pointer;
      }
      .company-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .ats-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        background: rgba(255,255,255,0.08);
      }
      .status-ok {
        color: #22c55e;
      }
      .status-error {
        color: #ef4444;
      }
      .status-unknown {
        color: var(--muted);
      }
      .jobs-badge {
        background: var(--accent);
        color: #000;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 600;
      }
      .jobs-badge.zero {
        background: var(--border);
        color: var(--muted);
      }

      .wrap {
        padding: 14px 18px 24px;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 12px;
        align-items: end;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      select,
      input,
      button {
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 10px;
        font-size: 13px;
        outline: none;
      }
      input {
        min-width: 210px;
      }
      select {
        min-width: 160px;
      }
      button {
        cursor: pointer;
      }
      button.primary {
        background: rgba(96, 165, 250, 0.15);
        border-color: rgba(96, 165, 250, 0.35);
      }
      button.primary:hover {
        background: rgba(96, 165, 250, 0.22);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .pill {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
        padding: 8px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--muted);
        display: inline-block;
      }
      .dot.ok {
        background: var(--ok);
      }
      .dot.bad {
        background: var(--danger);
      }

      /* Table */
      .tableWrap {
        margin-top: 14px;
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        background: var(--panel2);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: rgba(255, 255, 255, 0.04);
      }
      th,
      td {
        padding: 10px 10px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        vertical-align: top;
      }
      th {
        text-align: left;
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }
      tr:hover td {
        background: rgba(255, 255, 255, 0.02);
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      .right {
        text-align: right;
      }

      /* Sortable headers */
      th.sortable {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
      }
      th.sortable:hover {
        color: var(--text);
      }
      .sortIcon {
        display: inline-block;
        margin-left: 6px;
        opacity: 0.7;
        font-size: 11px;
      }

      /* Multi-select dropdown */
      .ms {
        position: relative;
        min-width: 180px;
      }
      .msBtn {
        width: 100%;
        text-align: left;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .msBtn .count {
        color: var(--muted);
        font-size: 12px;
      }
      .msMenu {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        min-width: 200px;
        max-height: 280px;
        overflow-y: auto;
        overflow-x: hidden;
        background: #1e2128;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        display: none;
        z-index: 100;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      }
      .ms.open .msMenu {
        display: block;
      }
      .msSearch {
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 6px;
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        font-size: 13px;
      }
      .msItem {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 6px 8px;
        border-radius: 4px;
        cursor: pointer;
      }
      .msItem:hover {
        background: rgba(255, 255, 255, 0.06);
      }
      .msItem input[type="checkbox"] {
        width: 14px;
        height: 14px;
        min-width: 14px;
        margin: 0;
        accent-color: var(--accent);
        cursor: pointer;
      }
      .msItem label {
        cursor: pointer;
        font-size: 13px;
        color: var(--text);
        white-space: nowrap;
      }
      .msItem input[type="checkbox"]:checked + label {
        color: var(--accent);
        font-weight: 500;
      }
      .msFooter {
        display: flex;
        gap: 6px;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid var(--border);
      }
      .msFooter button {
        flex: 1;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
      }
      .ghost {
        opacity: 0.45;
      }
      .checkboxRow {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
      }
      .checkboxRow input {
        min-width: auto;
      }

      /* Status row colors */
      tr[data-status="Applied"] {
        background: rgba(96, 165, 250, 0.1);
      }
      tr[data-status="Interview"] {
        background: rgba(34, 197, 94, 0.15);
      }
      tr[data-status="Offer"] {
        background: rgba(34, 197, 94, 0.25);
      }
      tr[data-status="Rejected"] {
        background: rgba(239, 68, 68, 0.1);
      }
      tr[data-status="Withdrawn"] {
        background: rgba(156, 163, 175, 0.1);
      }
      tr[data-status="Closed"] {
        background: rgba(156, 163, 175, 0.1);
        opacity: 0.7;
      }
      
      .status-icon {
        margin-right: 4px;
        font-size: 10px;
      }

      /* Status select inside table */
      .statusSelect {
        min-width: 120px;
        padding: 7px 8px;
        border-radius: 10px;
        font-size: 12px;
      }

      /* ========== STATUS BAR ========== */
      .status-bar {
        display: flex;
        align-items: center;
        gap: 24px;
        flex-wrap: wrap;
        padding: 8px 0;
      }

      .status-main {
        display: flex;
        align-items: baseline;
        gap: 8px;
      }

      .status-count {
        font-size: 32px;
        font-weight: 700;
        color: var(--accent);
        line-height: 1;
      }

      .status-count.zero {
        color: var(--muted);
      }

      .status-label {
        font-size: 14px;
        color: var(--muted);
      }

      .status-pipeline {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        color: var(--muted);
      }

      .pipe-item {
        padding: 2px 8px;
        background: var(--card);
        border-radius: 4px;
      }

      .pipe-item.active {
        background: var(--accent);
        color: var(--bg);
      }

      .pipe-arrow {
        color: var(--muted);
        opacity: 0.5;
      }

      .status-geo {
        display: flex;
        gap: 8px;
      }

      .geo-badge {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .geo-badge.nc {
        background: #10b98120;
        color: #10b981;
      }

      .geo-badge.neighbor {
        background: #3b82f620;
        color: #3b82f6;
      }

      .geo-badge.remote {
        background: #8b5cf620;
        color: #8b5cf6;
      }

      .geo-badge .geo-count {
        font-weight: 700;
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        width: 400px;
        max-width: 90vw;
      }
      .modal h3 {
        margin: 0 0 16px 0;
        font-size: 18px;
      }
      .modal label {
        display: block;
        margin-bottom: 12px;
      }
      .modal input, .modal select {
        width: 100%;
        padding: 8px 12px;
        margin-top: 4px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--panel);
        font-size: 14px;
        box-sizing: border-box;
      }
      .modal-actions {
        display: flex;
        gap: 8px;
        margin-top: 20px;
        justify-content: flex-end;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-left">
        <h1>Job Tracker <span id="envBadge" class="env-badge"></span></h1>
        <div class="status-bar" id="statusBar">
          <div class="status-pipeline" id="statusPipeline">
            <span class="pipe-item">Not loaded</span>
          </div>
          <div class="status-geo" id="statusGeo"></div>
        </div>
      </div>
      <div class="header-actions">
        <label class="my-location-toggle">
          <input type="checkbox" id="myRolesToggle">
          <span>üíº My Roles</span>
        </label>
        <label class="my-location-toggle">
          <input type="checkbox" id="myLocationToggle">
          <span>üìç My Location</span>
        </label>
        <button class="refresh-btn" id="refreshBtn">üîÑ Refresh from ATS</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="companies">Companies</button>
      <button class="tab-btn" data-tab="jobs">All Jobs</button>
    </div>

    <!-- Companies Tab -->
    <div class="tab-content active" id="tab-companies">
      <div class="wrap">
        <div class="companies-summary" id="companiesSummary">
          <div class="summary-item">
            <div class="summary-value" id="summaryCompanies">‚Äî</div>
            <div class="summary-label">Companies</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="summaryJobs">‚Äî</div>
            <div class="summary-label">Positions</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="summaryNew">‚Äî</div>
            <div class="summary-label">New</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="summaryApplied">‚Äî</div>
            <div class="summary-label">Applied</div>
          </div>
          <button id="addCompanyBtn" class="ghost" style="margin-left: 8px;">+ Add Company</button>
        </div>
        
        <div class="tableWrap">
          <table id="companiesTable">
            <thead>
              <tr>
                <th class="sortable" style="width: 180px" onclick="sortCompanies('company')">Company <span class="sortIcon" id="sortIcon-c-company">‚¨ç</span></th>
                <th class="sortable" style="width: 120px" onclick="sortCompanies('industry')">Industry <span class="sortIcon" id="sortIcon-c-industry">‚¨ç</span></th>
                <th class="sortable" style="width: 100px" onclick="sortCompanies('ats')">ATS <span class="sortIcon" id="sortIcon-c-ats">‚¨ç</span></th>
                <th class="sortable" style="width: 80px" onclick="sortCompanies('jobs_count')">Jobs <span class="sortIcon" id="sortIcon-c-jobs_count">‚¨ç</span></th>
                <th class="sortable" style="width: 60px" onclick="sortCompanies('new_count')">New <span class="sortIcon" id="sortIcon-c-new_count">‚¨ç</span></th>
                <th class="sortable" style="width: 70px" onclick="sortCompanies('applied_count')">Applied <span class="sortIcon" id="sortIcon-c-applied_count">‚¨ç</span></th>
                <th class="sortable" style="width: 100px" onclick="sortCompanies('last_ok')">Status <span class="sortIcon" id="sortIcon-c-last_ok">‚¨ç</span></th>
              </tr>
            </thead>
            <tbody id="companiesBody">
              <tr><td colspan="7" style="text-align:center; padding: 40px; color: var(--muted);">Loading companies...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Jobs Tab -->
    <div class="tab-content" id="tab-jobs">
    <div class="wrap">
      <div class="controls">
        <label>
          Industry (tags)
          <input id="industryFilter" placeholder="e.g., fintech, saas, security" />
        </label>

        <label>
          ATS
          <select id="atsFilter">
            <option value="all">All</option>
            <option value="greenhouse">Greenhouse</option>
            <option value="lever">Lever</option>
            <option value="smartrecruiters">SmartRecruiters</option>
            <option value="ashby">Ashby</option>
          </select>
        </label>

        <label>
          Role
          <select id="roleFilter">
            <option value="all">All</option>
            <option value="product">Product</option>
            <option value="tpm_program">Program/TPM</option>
            <option value="project">Project</option>
            <option value="other">Other (not relevant)</option>
          </select>
        </label>

        <label>
          Status
          <select id="statusFilter">
            <option value="all">All</option>
            <option value="New">New</option>
            <option value="Applied">Applied</option>
            <option value="Interview">Interview</option>
            <option value="Offer">Offer</option>
            <option value="Rejected">Rejected</option>
            <option value="Withdrawn">Withdrawn</option>
            <option value="Closed">Closed</option>
          </select>
        </label>

        <div class="checkboxRow" style="min-width: 280px">
          <div style="display: flex; flex-direction: column; gap: 6px">
            <div style="color: var(--muted); font-size: 12px">Locations</div>
            <div
              style="
                display: flex;
                gap: 14px;
                align-items: center;
                flex-wrap: wrap;
              "
            >
              <label
                style="
                  flex-direction: row;
                  align-items: center;
                  gap: 8px;
                  margin: 0;
                  color: var(--text);
                  font-size: 13px;
                "
              >
                <input type="checkbox" id="includeUS" checked />
                US
              </label>
              <label
                style="
                  flex-direction: row;
                  align-items: center;
                  gap: 8px;
                  margin: 0;
                  color: var(--text);
                  font-size: 13px;
                "
              >
                <input type="checkbox" id="includeNonUS" />
                Non-US
              </label>
              <label
                style="
                  flex-direction: row;
                  align-items: center;
                  gap: 8px;
                  margin: 0;
                  color: var(--text);
                  font-size: 13px;
                "
              >
                <input type="checkbox" id="includeRemoteUSA" checked />
                Remote (USA)
              </label>
            </div>
          </div>
        </div>

        <label>
          Company contains
          <input id="companyFilter" placeholder="e.g., fidelity" />
        </label>

        <label>
          Search (title/location/company)
          <input
            id="searchFilter"
            placeholder="e.g., TPM, product owner, Raleigh"
          />
        </label>

        <!-- Multi-state dropdown -->
        <div class="ms" id="stateMultiSelect">
          <label>States (multi)</label>
          <button class="msBtn" id="stateBtn" type="button">
            <span id="stateBtnText">Select states‚Ä¶</span>
            <span class="count" id="stateBtnCount">0</span>
          </button>
          <div class="msMenu" id="stateMenu">
            <input
              class="msSearch"
              id="stateSearch"
              placeholder="Search..."
            />
            <div id="stateList"></div>
            <div class="msFooter">
              <button type="button" id="stateClear" class="ghost">Clear</button>
              <button type="button" id="stateClose">Done</button>
            </div>
          </div>
        </div>

        <label>
          Cities (comma separated)
          <input id="cityFilter" placeholder="e.g., Raleigh, Charlotte" />
        </label>

        <span class="pill" id="loadPill"
          ><span class="dot" id="loadDot"></span
          ><span id="loadText">Idle</span></span
        >
      </div>

      <div class="tableWrap">
        <table id="jobsTable">
          <thead>
            <tr>
              <th
                class="sortable"
                style="width: 150px"
                onclick="sortTable('company')"
              >
                Company <span class="sortIcon" id="sortIcon-company">‚¨ç</span>
              </th>
              <th
                class="sortable"
                style="width: 140px"
                onclick="sortTable('industry')"
              >
                Industry <span class="sortIcon" id="sortIcon-industry">‚¨ç</span>
              </th>
              <th class="sortable" onclick="sortTable('title')">
                Title <span class="sortIcon" id="sortIcon-title">‚¨ç</span>
              </th>
              <th
                class="sortable"
                style="width: 280px"
                onclick="sortTable('location')"
              >
                Location <span class="sortIcon" id="sortIcon-location">‚¨ç</span>
              </th>
              <th
                class="sortable"
                style="width: 170px"
                onclick="sortTable('updated')"
              >
                Updated <span class="sortIcon" id="sortIcon-updated">‚¨ç</span>
              </th>
              <th
                class="sortable"
                style="width: 120px"
                onclick="sortTable('ats')"
              >
                ATS <span class="sortIcon" id="sortIcon-ats">‚¨ç</span>
              </th>
              <th
                class="sortable"
                style="width: 140px"
                onclick="sortTable('status')"
              >
                Status <span class="sortIcon" id="sortIcon-status">‚¨ç</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <!-- rows -->
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top: 10px">
        Tip: Use "Refresh from ATS" to update jobs. Filters apply instantly on the client.
      </div>
    </div>
    </div> <!-- end tab-jobs -->

    <!-- Add Company Modal -->
    <div class="modal-overlay" id="addCompanyModal">
      <div class="modal">
        <h3>Add Company</h3>
        <label>
          Company Name
          <input type="text" id="newCompanyName" placeholder="e.g., Stripe" />
        </label>
        <label>
          ATS
          <select id="newCompanyAts">
            <option value="greenhouse">Greenhouse</option>
            <option value="lever">Lever</option>
            <option value="smartrecruiters">SmartRecruiters</option>
          </select>
        </label>
        <label>
          Board URL
          <input type="text" id="newCompanyUrl" placeholder="https://boards.greenhouse.io/company" />
        </label>
        <label>
          Industry
          <input type="text" id="newCompanyIndustry" placeholder="e.g., Fintech, SaaS" />
        </label>
        <div class="modal-actions">
          <button class="ghost" id="cancelAddCompany">Cancel</button>
          <button class="primary" id="confirmAddCompany">Add</button>
        </div>
      </div>
    </div>

    <script>
      // ---------- GLOBAL STATE ----------
      let ALL_JOBS_RAW = [];  // All jobs before role filter
      let ALL_JOBS = [];      // Jobs after role filter
      let LAST_LOADED_AT = null;
      let isRefreshing = false;
      let CACHED_STATS = null;  // Pre-computed funnel stats from backend

      // My Roles filter settings
      const MY_ROLES = ['product', 'tpm_program', 'project'];
      let myRolesEnabled = false;
      
      // My Location filter settings
      const MY_LOCATION_STATES = ["NC", "VA", "SC", "GA", "TN"];
      let myLocationEnabled = false;
      
      // Defaults: all locations visible when toggles are off
      let selectedStates = [];
      let includeNonUS = true;
      let includeUS = true;
      let includeRemoteUSA = true;

      // Job status cache: job_key -> status
      let STATUS_MAP = {};

      const debugCounts = {
        afterIndustry: 0,
        afterRole: 0,
        afterLocation: 0,
        afterCompany: 0,
        afterSearch: 0,
        afterState: 0,
        afterCity: 0,
        afterStatus: 0,
      };

      // ---------- SORT STATE ----------
      let CURRENT_SORT = { column: null, asc: true };

      function setSortIcon(col, icon) {
        const el = document.getElementById(`sortIcon-${col}`);
        if (el) el.textContent = icon;
      }

      function resetAllSortIcons() {
        ["company", "industry", "title", "location", "updated", "ats", "status"].forEach(
          (c) => setSortIcon(c, "‚¨ç")
        );
      }

      function updateSortIcons() {
        resetAllSortIcons();
        if (!CURRENT_SORT.column) return;
        setSortIcon(CURRENT_SORT.column, CURRENT_SORT.asc ? "‚ñ≤" : "‚ñº");
      }

      // keepDirection=true when re-applying sort after re-render
      function sortTable(column, keepDirection = false) {
        const tbody = document.querySelector("#jobsTable tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        if (!keepDirection) {
          if (CURRENT_SORT.column === column) {
            CURRENT_SORT.asc = !CURRENT_SORT.asc;
          } else {
            CURRENT_SORT.column = column;
            CURRENT_SORT.asc = true;
          }
        } else {
          CURRENT_SORT.column = column;
        }

        const asc = !!CURRENT_SORT.asc;

        rows.sort((a, b) => {
          const av = a.dataset[column] || "";
          const bv = b.dataset[column] || "";

          if (column === "updated") {
            const ad = Date.parse(av) || 0;
            const bd = Date.parse(bv) || 0;
            return asc ? ad - bd : bd - ad;
          }

          // stable, case-insensitive
          const cmp = av.localeCompare(bv, undefined, { sensitivity: "base" });
          return asc ? cmp : -cmp;
        });

        // re-append in order
        for (const r of rows) tbody.appendChild(r);

        updateSortIcons();
      }

      function applyCurrentSortIfAny() {
        if (CURRENT_SORT.column) {
          sortTable(CURRENT_SORT.column, true);
        } else {
          updateSortIcons();
        }
      }

      // ---------- STATE LIST (US + DC) ----------
      const US_STATES = [
        { code: "AL", name: "Alabama" },
        { code: "AK", name: "Alaska" },
        { code: "AZ", name: "Arizona" },
        { code: "AR", name: "Arkansas" },
        { code: "CA", name: "California" },
        { code: "CO", name: "Colorado" },
        { code: "CT", name: "Connecticut" },
        { code: "DE", name: "Delaware" },
        { code: "FL", name: "Florida" },
        { code: "GA", name: "Georgia" },
        { code: "HI", name: "Hawaii" },
        { code: "ID", name: "Idaho" },
        { code: "IL", name: "Illinois" },
        { code: "IN", name: "Indiana" },
        { code: "IA", name: "Iowa" },
        { code: "KS", name: "Kansas" },
        { code: "KY", name: "Kentucky" },
        { code: "LA", name: "Louisiana" },
        { code: "ME", name: "Maine" },
        { code: "MD", name: "Maryland" },
        { code: "MA", name: "Massachusetts" },
        { code: "MI", name: "Michigan" },
        { code: "MN", name: "Minnesota" },
        { code: "MS", name: "Mississippi" },
        { code: "MO", name: "Missouri" },
        { code: "MT", name: "Montana" },
        { code: "NE", name: "Nebraska" },
        { code: "NV", name: "Nevada" },
        { code: "NH", name: "New Hampshire" },
        { code: "NJ", name: "New Jersey" },
        { code: "NM", name: "New Mexico" },
        { code: "NY", name: "New York" },
        { code: "NC", name: "North Carolina" },
        { code: "ND", name: "North Dakota" },
        { code: "OH", name: "Ohio" },
        { code: "OK", name: "Oklahoma" },
        { code: "OR", name: "Oregon" },
        { code: "PA", name: "Pennsylvania" },
        { code: "RI", name: "Rhode Island" },
        { code: "SC", name: "South Carolina" },
        { code: "SD", name: "South Dakota" },
        { code: "TN", name: "Tennessee" },
        { code: "TX", name: "Texas" },
        { code: "UT", name: "Utah" },
        { code: "VT", name: "Vermont" },
        { code: "VA", name: "Virginia" },
        { code: "WA", name: "Washington" },
        { code: "WV", name: "West Virginia" },
        { code: "WI", name: "Wisconsin" },
        { code: "WY", name: "Wyoming" },
        { code: "DC", name: "District of Columbia" },
      ];

      // ---------- LOCATION NORMALIZATION ----------
      function normalizeLocation(raw) {
        const out = {
          raw: raw || "",
          city: "",
          state: "",
          state_full: "",
          remote: false,
          remote_scope: "",
        };

        const s = (raw || "").toLowerCase();

        // Remote detection (USA)
        if (
          s.includes("remote") &&
          (s.includes("us") || s.includes("usa") || s.includes("united states"))
        ) {
          out.remote = true;
          out.remote_scope = "usa";
        } else if (s.includes("remote")) {
          out.remote = true;
          out.remote_scope = "global";
        }

        // Try to extract state by code or full name from the raw location string.
        for (const st of US_STATES) {
          const code = st.code.toLowerCase();
          const name = st.name.toLowerCase();

          if (
            s.includes(", " + code) ||
            s.endsWith(" " + code) ||
            s.includes(" " + code + " ") ||
            s.includes("(" + code + ")")
          ) {
            out.state = st.code;
            out.state_full = st.name;
            break;
          }
          if (s.includes(name)) {
            out.state = st.code;
            out.state_full = st.name;
            break;
          }
        }

        // City: naive approach: take first token before comma
        if (raw && raw.includes(",")) {
          out.city = raw.split(",")[0].trim();
        } else {
          out.city = "";
        }

        return out;
      }

      function enrichJobsLocationNorm(jobs) {
        for (const j of jobs) {
          // Only normalize if not already present from backend
          if (!j.location_norm) {
            j.location_norm = normalizeLocation(j.location || "");
          }
          // status fallback - Pipeline uses 'status', prefer it over 'application_status'
          if (j.status) {
            // Pipeline job - use status field
            j.application_status = j.status;
          } else if (j.application_status) {
            // Legacy job - use application_status
            j.status = j.application_status;
          } else {
            // No status - default to New
            j.status = "New";
            j.application_status = "New";
          }
        }
        return jobs;
      }

      // ---------- FILTER HELPERS ----------
      function matchStatesInJob(location_norm) {
        if (!location_norm) return false;
        const jobState = (location_norm.state || "").toLowerCase();
        const jobStateFull = (location_norm.state_full || "").toLowerCase();

        return selectedStates.some((selState) => {
          selState = selState.toLowerCase();
          return selState === jobState || selState === jobStateFull;
        });
      }

      function isRemoteUSA(location_norm) {
        if (!location_norm) return false;
        return (
          location_norm.remote === true && location_norm.remote_scope === "usa"
        );
      }

      function isUSHeuristic(job) {
        // Use normalized location if available
        const ln = job.location_norm || {};
        if (ln.state) {
          return true; // Has US state code
        }
        
        // Fallback to text heuristic
        const l = (job.location || "").toLowerCase();
        return (
          l.includes("united states") ||
          l.includes(" usa") ||
          l.includes(" us") ||
          l.includes(", us") ||
          l.includes("remote - us") ||
          l.includes("remote (us)")
        );
      }

      // ---------- MAIN FILTER FUNCTION ----------
      function applyFilters(jobs) {
        const industryFilter = (document.getElementById("industryFilter")?.value || "").trim().toLowerCase();
        const role = document.getElementById("roleFilter").value;
        const status = document.getElementById("statusFilter").value;
        const ats = document.getElementById("atsFilter").value;
        const nonus = includeNonUS;

        const companyFilter = document
          .getElementById("companyFilter")
          .value.trim();

        const cityFilter = document.getElementById("cityFilter").value.trim();

        const search = (document.getElementById("searchFilter")?.value || "")
          .trim()
          .toLowerCase();

        let filtered = jobs;

        // ===== Industry filter by tags =====
        if (industryFilter) {
          filtered = filtered.filter((job) => {
            const jobTags = (job.company_data?.tags || []).map(t => t.toLowerCase());
            return jobTags.some(tag => tag.includes(industryFilter));
          });
        }
        debugCounts.afterIndustry = filtered.length;

        // ===== ATS filter =====
        if (ats !== "all") {
          filtered = filtered.filter((job) => {
            return (job.ats || "").toLowerCase() === ats.toLowerCase();
          });
        }

        // Role filter (uses role_family from backend classification)
        filtered = filtered.filter((job) => {
          if (role === "all") return true;
          const family = job.role_family || "other";
          return family === role;
        });
        debugCounts.afterRole = filtered.length;

        // Location filter (US and Non-US toggles) - always apply
        const us = includeUS;
        filtered = filtered.filter((job) => {
          const isUS = isUSHeuristic(job);
          if (isUS) return us;
          return nonus;
        });
        debugCounts.afterLocation = filtered.length;

        // Company
        filtered = filtered.filter((job) => {
          if (!companyFilter) return true;
          return (job.company || "")
            .toLowerCase()
            .includes(companyFilter.toLowerCase());
        });
        debugCounts.afterCompany = filtered.length;

        // Search
        if (search) {
          filtered = filtered.filter((job) => {
            const h = `${job.title || ""} ${job.location || ""} ${
              job.company || ""
            }`.toLowerCase();
            return h.includes(search);
          });
        }
        debugCounts.afterSearch = filtered.length;

        // City (comma-separated)
        if (cityFilter) {
          const cities = cityFilter
            .toLowerCase()
            .split(",")
            .map((c) => c.trim())
            .filter(Boolean);
          filtered = filtered.filter((job) => {
            const ln = job.location_norm;
            if (!ln) return false;
            const city = (ln.city || "").toLowerCase();
            return cities.includes(city);
          });
        }
        debugCounts.afterCity = filtered.length;

        // States + Remote(USA) independent toggles
        const hasStateFilter = selectedStates.length > 0;
        const hasRemoteFilter = !!includeRemoteUSA;
        if (hasStateFilter || hasRemoteFilter) {
          filtered = filtered.filter((job) => {
            const ln = job.location_norm;
            const isUS = isUSHeuristic(job);
            
            // If Non-US job and Include Non-US is on, skip state filter
            if (!isUS && nonus) {
              return true;
            }
            
            const okState = hasStateFilter ? matchStatesInJob(ln) : false;
            const okRemote = hasRemoteFilter ? isRemoteUSA(ln) : false;
            return okState || okRemote || (!hasStateFilter && !hasRemoteFilter);
          });
        }
        debugCounts.afterState = filtered.length;

        // Status filter (last stage)
        filtered = filtered.filter((job) => {
          if (status === "all") return true;
          const st = job.application_status || "New";
          return st === status;
        });
        debugCounts.afterStatus = filtered.length;

        return filtered;
      }

      function computeGeoSummary(jobs) {
        let nc = 0;
        let neighbor = 0;
        let remote = 0;

        for (const j of jobs) {
          const ln = j.location_norm || {};
          const st = (ln.state || "").toUpperCase();
          if (isRemoteUSA(ln)) {
            remote += 1;
            continue;
          }
          if (st === "NC") {
            nc += 1;
            continue;
          }
          if (["VA", "SC", "GA", "TN"].includes(st)) {
            neighbor += 1;
            continue;
          }
        }
        return { nc, neighbor, remote };
      }

      function updateStatus(latestFilteredJobs = null) {
        const statusPipeline = document.getElementById("statusPipeline");
        const statusGeo = document.getElementById("statusGeo");

        // Pipeline visualization - use cached stats if available
        if (CACHED_STATS || LAST_LOADED_AT || ALL_JOBS_RAW.length > 0) {
          // Use cached stats from backend for Total/Role/US/MyArea
          const totalRaw = CACHED_STATS?.total || ALL_JOBS_RAW.length;
          const roleCount = CACHED_STATS?.role || filterRelevantRoles(ALL_JOBS_RAW).length;
          const usCount = CACHED_STATS?.us || 0;
          const myAreaCount = CACHED_STATS?.my_area || 0;
          
          // Get shown count from filtered jobs (live count)
          const shownCount = latestFilteredJobs ? latestFilteredJobs.length : ALL_JOBS.length;
          
          const steps = [
            { label: "Total", count: totalRaw },
            { label: "Role", count: roleCount },
            { label: "US", count: usCount },
            { label: "My Area", count: myAreaCount },
            { label: "Shown", count: shownCount },
          ];

          let pipelineHtml = '';
          steps.forEach((step, i) => {
            if (i > 0) pipelineHtml += '<span class="pipe-arrow">‚Üí</span>';
            const isActive = step.count > 0 && step.count < steps[Math.max(0, i-1)]?.count;
            pipelineHtml += `<span class="pipe-item${isActive ? ' active' : ''}">${step.label}: ${step.count}</span>`;
          });
          statusPipeline.innerHTML = pipelineHtml;
        } else {
          statusPipeline.innerHTML = '<span class="pipe-item">Not loaded</span>';
        }

        // Geo badges
        if (LAST_LOADED_AT && Array.isArray(latestFilteredJobs)) {
          const g = computeGeoSummary(latestFilteredJobs);
          statusGeo.innerHTML = `
            <span class="geo-badge nc"><span class="geo-count">${g.nc}</span> NC</span>
            <span class="geo-badge neighbor"><span class="geo-count">${g.neighbor}</span> Neighbor</span>
            <span class="geo-badge remote"><span class="geo-count">${g.remote}</span> Remote</span>
          `;
        } else {
          statusGeo.innerHTML = '';
        }
      }

      async function persistStatus(jobId, status) {
        try {
          const res = await fetch("/pipeline/status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ job_id: jobId, status: status }),
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return data.ok;
        } catch (e) {
          console.error(e);
          alert("Failed to save status. Check server logs.");
          return false;
        }
      }

      function renderJobs(jobs) {
        const tbody = document.querySelector("#jobsTable tbody");
        tbody.innerHTML = "";

        for (const job of jobs) {
          const row = document.createElement("tr");
          const url = job.job_url || job.url || "#";
          const jobKey = job.job_key || url || "";

          const st = job.application_status || "New";
          
          // Get tags for industry column
          const tags = job.company_data?.tags || [];
          const tagsStr = tags.join(", ");

          // dataset for sorting (case-insensitive)
          row.dataset.company = (job.company || "").trim();
          row.dataset.industry = tagsStr;
          row.dataset.title = (job.title || "").trim();
          row.dataset.location = (job.location || "").trim();
          row.dataset.updated = (job.updated_at || "").trim();
          row.dataset.ats = (job.ats || "").trim();
          row.dataset.status = (st || "New").trim();

          row.innerHTML = `
        <td>${escapeHtml(job.company || "")}</td>
        <td class="muted" style="font-size: 11px;">${escapeHtml(tagsStr)}</td>
        <td><a href="${escapeAttr(
          url
        )}" target="_blank" rel="noopener">${escapeHtml(
            job.title || ""
          )}</a></td>
        <td>${escapeHtml(job.location || "")}</td>
        <td>${escapeHtml(job.updated_at || "")}</td>
        <td>${escapeHtml(job.ats || "")}</td>
        <td>
          <select class="statusSelect" data-jobkey="${escapeAttr(jobKey)}">
            ${["New", "Applied", "Interview", "Offer", "Rejected", "Withdrawn", "Closed"]
              .map(
                (x) => {
                  const icons = {
                    "New": "‚ö™",
                    "Applied": "üì§",
                    "Interview": "üéØ",
                    "Offer": "üéâ",
                    "Rejected": "‚ùå",
                    "Withdrawn": "üîô",
                    "Closed": "üîí"
                  };
                  return `<option value="${x}" ${x === st ? "selected" : ""}>${icons[x] || ""} ${x}</option>`;
                }
              )
              .join("")}
          </select>
        </td>
      `;
          tbody.appendChild(row);

          const sel = row.querySelector("select.statusSelect");
          sel.addEventListener("change", async (e) => {
            const newStatus = e.target.value;
            const jobId = job.id;  // Use job.id for Pipeline
            const oldStatus = st;

            // optimistic update
            job.application_status = newStatus;
            job.status = newStatus;  // Pipeline uses 'status' field
            row.dataset.status = newStatus;

            const ok = await persistStatus(jobId, newStatus);
            if (!ok) {
              // revert
              e.target.value = oldStatus;
              job.application_status = oldStatus;
              job.status = oldStatus;
              row.dataset.status = oldStatus;
            } else {
              // if status filter active, re-render
              const filtered = applyFilters(ALL_JOBS);
              renderJobs(filtered);
            }
          });
        }

        updateStatus(jobs);
        applyCurrentSortIfAny();
      }

      function escapeHtml(s) {
        return (s || "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      function escapeAttr(s) {
        return (s || "").replace(/"/g, "&quot;");
      }

      // ---------- LOADING ----------
      async function loadJobsOnce() {
        const ats = document.getElementById("atsFilter").value;

        setLoading(true, "Loading‚Ä¶");
        try {
          // Always load ALL jobs, filter locally by profile/ats
          const url = `/jobs?profile=all&ats_filter=all&role_filter=all&location_filter=all`;

          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          ALL_JOBS = enrichJobsLocationNorm(data.jobs || []);
          LAST_LOADED_AT = new Date().toLocaleString();

          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);

          setLoading(false, "Loaded");
        } catch (e) {
          console.error(e);
          ALL_JOBS = [];
          LAST_LOADED_AT = null;
          renderJobs([]);
          setLoading(false, "Error");
          alert(
            "Failed to load jobs. Check terminal logs (uvicorn) and /jobs endpoint."
          );
        }
      }

      // Fast load: stats + pipeline jobs only
      async function loadJobsFromCache() {
        // Don't load if jobs already loaded
        if (ALL_JOBS_RAW.length > 0) {
          console.log("loadJobsFromCache skipped - jobs already loaded");
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
          return;
        }
        
        console.log("loadJobsFromCache started");
        setLoading(true, "Loading‚Ä¶");
        try {
          // 1. Load funnel stats (tiny ~100 bytes)
          const statsRes = await fetch("/stats");
          if (statsRes.ok) {
            CACHED_STATS = await statsRes.json();
            console.log("Stats loaded:", CACHED_STATS);
          }
          
          // 2. Load Pipeline jobs only (not full cache)
          const res = await fetch("/pipeline/all");
          console.log("fetch done, status:", res.status);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          console.log("got pipeline jobs:", data.count);
          
          // Store pipeline jobs
          ALL_JOBS_RAW = enrichJobsLocationNorm(data.jobs || []);
          ALL_JOBS = myRolesEnabled ? filterRelevantRoles(ALL_JOBS_RAW) : ALL_JOBS_RAW;
          LAST_LOADED_AT = new Date().toLocaleString();

          const filtered = applyFilters(ALL_JOBS);
          console.log("filtered jobs:", filtered.length);
          renderJobs(filtered);
          updateStatus(filtered);  // Update header stats

          setLoading(false, "Loaded");
          console.log("loadJobsFromCache done");
        } catch (e) {
          console.error("loadJobsFromCache error:", e);
          setLoading(false, "Error");
        }
      }

      function setLoading(isLoading, text) {
        const dot = document.getElementById("loadDot");
        const label = document.getElementById("loadText");

        label.textContent = text;

        dot.classList.remove("ok", "bad");
        if (isLoading) dot.classList.add("bad");
        if (!isLoading && (text === "Loaded" || text === "Updated")) dot.classList.add("ok");
        if (!isLoading && text === "Error") dot.classList.add("bad");
      }

      // ---------- MULTI-SELECT UI ----------
      function syncStateButton() {
        const text = document.getElementById("stateBtnText");
        const cnt = document.getElementById("stateBtnCount");
        cnt.textContent = String(selectedStates.length);
        if (selectedStates.length === 0) {
          text.textContent = "Select states‚Ä¶";
        } else if (selectedStates.length <= 3) {
          text.textContent = selectedStates.join(", ");
        } else {
          text.textContent =
            selectedStates.slice(0, 3).join(", ") +
            ` +${selectedStates.length - 3}`;
        }
      }

      function renderStateList(filterText = "") {
        const list = document.getElementById("stateList");
        list.innerHTML = "";

        const q = (filterText || "").trim().toLowerCase();

        const items = US_STATES.filter((st) => {
          if (!q) return true;
          return (
            st.code.toLowerCase().includes(q) ||
            st.name.toLowerCase().includes(q)
          );
        });

        for (const st of items) {
          const div = document.createElement("div");
          div.className = "msItem";
          const checked = selectedStates.includes(st.code);
          const checkId = `state-${st.code}`;
          div.innerHTML = `
        <input type="checkbox" id="${checkId}" ${checked ? "checked" : ""} />
        <label for="${checkId}">${st.code} ‚Äî ${st.name}</label>
      `;
          div.addEventListener("click", (ev) => {
            ev.preventDefault();

            const key = st.code;

            if (selectedStates.includes(key)) {
              selectedStates = selectedStates.filter((x) => x !== key);
            } else {
              selectedStates.push(key);
            }

            syncStateButton();
            renderStateList(document.getElementById("stateSearch").value);

            if (ALL_JOBS.length > 0) {
              const filtered = applyFilters(ALL_JOBS);
              renderJobs(filtered);
            }
          });
          list.appendChild(div);
        }
      }

      function openStateMenu() {
        document.getElementById("stateMultiSelect").classList.add("open");
        renderStateList(document.getElementById("stateSearch").value);
      }
      function closeStateMenu() {
        document.getElementById("stateMultiSelect").classList.remove("open");
      }

      // ---------- EVENTS ----------

      const filterIds = [
        "roleFilter",
        "statusFilter",
        "companyFilter",
        "searchFilter",
        "cityFilter",
        "industryFilter",
        "atsFilter",
      ];
      for (const id of filterIds) {
        const el = document.getElementById(id);
        if (!el) continue;
        el.addEventListener("change", () => {
          // All filters now apply locally (no server reload)
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          } else {
            updateStatus();
          }
        });
        el.addEventListener("input", () => {
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          }
        });
      }

      document
        .getElementById("includeUS")
        .addEventListener("change", (e) => {
          includeUS = !!e.target.checked;
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          }
        });

      document
        .getElementById("includeNonUS")
        .addEventListener("change", (e) => {
          includeNonUS = !!e.target.checked;
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          }
        });

      document
        .getElementById("includeRemoteUSA")
        .addEventListener("change", (e) => {
          includeRemoteUSA = !!e.target.checked;
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          }
        });

      // Multi-select open/close
      document.getElementById("stateBtn").addEventListener("click", () => {
        const ms = document.getElementById("stateMultiSelect");
        if (ms.classList.contains("open")) closeStateMenu();
        else openStateMenu();
      });
      document
        .getElementById("stateClose")
        .addEventListener("click", closeStateMenu);
      document.getElementById("stateClear").addEventListener("click", () => {
        selectedStates = [];
        syncStateButton();
        renderStateList(document.getElementById("stateSearch").value);
        if (ALL_JOBS.length > 0) {
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
        }
      });
      document.getElementById("stateSearch").addEventListener("input", (e) => {
        renderStateList(e.target.value);
      });

      document.addEventListener("click", (e) => {
        const ms = document.getElementById("stateMultiSelect");
        if (!ms.contains(e.target)) {
          closeStateMenu();
        }
      });

      // Init defaults
      document.getElementById("includeUS").checked = includeUS;
      document.getElementById("includeNonUS").checked = includeNonUS;
      document.getElementById("includeRemoteUSA").checked = includeRemoteUSA;

      syncStateButton();
      renderStateList("");
      updateStatus();
      updateSortIcons();

      // ========== TABS & COMPANIES ==========
      
      let COMPANIES_DATA = [];
      let companiesSortCol = "jobs_count";
      let companiesSortDir = "desc";
      
      // Tab switching
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          
          // Update buttons
          document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          
          // Update content
          document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
          document.getElementById(`tab-${tab}`).classList.add("active");
          
          // Update status bar based on tab
          if (tab === "companies") {
            // Header stays the same - universal funnel
            if (ALL_JOBS.length > 0) {
              updateStatus();
            }
          } else if (tab === "jobs") {
            if (ALL_JOBS_RAW.length > 0) {
              // Jobs already loaded - just filter and render
              const filtered = applyFilters(ALL_JOBS);
              renderJobs(filtered);
            } else {
              // No jobs loaded yet - load from cache
              loadJobsFromCache();
            }
          }
        });
      });
      
      // Load companies
      async function loadCompanies() {
        try {
          const res = await fetch(`/companies?profile=all&my_roles=${myRolesEnabled}&my_location=${myLocationEnabled}`);
          const data = await res.json();
          COMPANIES_DATA = data.companies || [];
          
          // Update summary
          document.getElementById("summaryCompanies").textContent = data.count || 0;
          document.getElementById("summaryJobs").textContent = data.summary?.total_jobs || 0;
          document.getElementById("summaryNew").textContent = data.summary?.total_new || 0;
          document.getElementById("summaryApplied").textContent = data.summary?.total_applied || 0;
          
          renderCompanies(COMPANIES_DATA);
          updateCompanySortIcons();
          
          // Update header status if we have jobs loaded
          if (ALL_JOBS.length > 0) {
            updateStatus();
          }
        } catch (err) {
          console.error("Failed to load companies:", err);
          document.getElementById("companiesBody").innerHTML = 
            `<tr><td colspan="7" style="text-align:center; padding: 40px; color: #ef4444;">Failed to load companies</td></tr>`;
        }
      }
      
      function sortCompanies(col) {
        if (companiesSortCol === col) {
          companiesSortDir = companiesSortDir === "asc" ? "desc" : "asc";
        } else {
          companiesSortCol = col;
          // Default: desc for numbers, asc for text
          companiesSortDir = ["jobs_count", "new_count", "applied_count", "last_ok"].includes(col) ? "desc" : "asc";
        }
        
        const sorted = [...COMPANIES_DATA].sort((a, b) => {
          let va = a[col] ?? "";
          let vb = b[col] ?? "";
          
          // Status column (boolean: false=error first, then true=ok, then null=unknown)
          if (col === "last_ok") {
            const order = { false: 2, true: 1, null: 0 };
            const oa = order[String(va)] ?? 0;
            const ob = order[String(vb)] ?? 0;
            return companiesSortDir === "asc" ? oa - ob : ob - oa;
          }
          
          // Numeric columns
          if (typeof va === "number" && typeof vb === "number") {
            return companiesSortDir === "asc" ? va - vb : vb - va;
          }
          
          // String columns
          va = String(va).toLowerCase();
          vb = String(vb).toLowerCase();
          if (va < vb) return companiesSortDir === "asc" ? -1 : 1;
          if (va > vb) return companiesSortDir === "asc" ? 1 : -1;
          return 0;
        });
        
        updateCompanySortIcons();
        renderCompanies(sorted);
      }
      
      function updateCompanySortIcons() {
        const cols = ["company", "industry", "ats", "jobs_count", "new_count", "applied_count", "last_ok"];
        cols.forEach(c => {
          const icon = document.getElementById(`sortIcon-c-${c}`);
          if (icon) {
            if (c === companiesSortCol) {
              icon.textContent = companiesSortDir === "asc" ? "‚ñ≤" : "‚ñº";
            } else {
              icon.textContent = "‚¨ç";
            }
          }
        });
      }
      
      function renderCompanies(companies) {
        const tbody = document.getElementById("companiesBody");
        
        if (!companies.length) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 40px; color: var(--muted);">No companies found</td></tr>`;
          return;
        }
        
        tbody.innerHTML = companies.map(c => {
          const statusIcon = c.last_ok === true ? '‚úÖ' : 
                            c.last_ok === false ? '‚ùå' : '‚Äî';
          const statusClass = c.last_ok === true ? 'status-ok' : 
                              c.last_ok === false ? 'status-error' : 'status-unknown';
          const errorTip = c.last_error ? ` title="${c.last_error}"` : '';
          
          const jobsBadgeClass = c.jobs_count > 0 ? 'jobs-badge' : 'jobs-badge zero';
          
          return `
            <tr class="company-row" data-company="${c.company}">
              <td><strong>${c.company}</strong></td>
              <td style="color: var(--muted); font-size: 12px;">${c.industry || c.tags?.join(', ') || ''}</td>
              <td><span class="ats-badge">${c.ats}</span></td>
              <td><span class="${jobsBadgeClass}">${c.jobs_count}</span></td>
              <td>${c.new_count || 0}</td>
              <td>${c.applied_count || 0}</td>
              <td class="${statusClass}"${errorTip}>${statusIcon}</td>
            </tr>
          `;
        }).join('');
        
        // Add click handlers
        tbody.querySelectorAll(".company-row").forEach(row => {
          row.addEventListener("click", () => {
            const company = row.dataset.company;
            showJobsForCompany(company);
          });
        });
      }
      
      function showJobsForCompany(company) {
        // Set company filter
        document.getElementById("companyFilter").value = company;
        
        // Switch to Jobs tab
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelector('[data-tab="jobs"]').classList.add("active");
        
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        document.getElementById("tab-jobs").classList.add("active");
        
        // If jobs already loaded, filter. Otherwise load from cache.
        if (ALL_JOBS_RAW.length > 0) {
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
        } else {
          loadJobsFromCache();
        }
      }
      
      // Filter jobs to only relevant roles (Product, TPM, Program, Project)
      function filterRelevantRoles(jobs) {
        const relevantRoles = ['product', 'tpm_program', 'project'];
        return jobs.filter(j => relevantRoles.includes(j.role_family));
      }
      
      async function backgroundRefresh() {
        if (isRefreshing) return; // Prevent double refresh
        isRefreshing = true;
        
        const btn = document.getElementById("refreshBtn");
        btn.disabled = true;
        btn.textContent = "‚è≥ Updating...";
        
        // Also update Load jobs indicator
        setLoading(true, "Refreshing ATS...");
        
        try {
          // Fetch fresh jobs from ATS (this updates cache + stats)
          const res = await fetch("/jobs?profile=all&refresh=true");
          const data = await res.json();
          
          // Reload stats (now updated by backend)
          const statsRes = await fetch("/stats");
          if (statsRes.ok) {
            CACHED_STATS = await statsRes.json();
            console.log("Stats refreshed:", CACHED_STATS);
          }
          
          // Reload pipeline jobs
          const pipelineRes = await fetch("/pipeline/all");
          const pipelineData = await pipelineRes.json();
          
          // Store pipeline jobs
          ALL_JOBS_RAW = enrichJobsLocationNorm(pipelineData.jobs || []);
          ALL_JOBS = myRolesEnabled ? filterRelevantRoles(ALL_JOBS_RAW) : ALL_JOBS_RAW;
          
          // Re-render if on Jobs tab
          const jobsTabActive = document.getElementById("tab-jobs").classList.contains("active");
          if (jobsTabActive) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
            updateStatus(filtered);  // Update header with new stats
          } else {
            updateStatus(null);  // Update header even if not on Jobs tab
          }
          
          // Reload companies stats
          await loadCompanies();
          btn.textContent = "‚úÖ Updated";
          setLoading(false, "Updated");
          setTimeout(() => {
            btn.textContent = "üîÑ Refresh from ATS";
            setLoading(false, "Loaded");
          }, 2000);
        } catch (err) {
          console.error("Background refresh failed:", err);
          btn.textContent = "‚ö†Ô∏è Refresh failed";
          setLoading(false, "Error");
          setTimeout(() => {
            btn.textContent = "üîÑ Refresh from ATS";
          }, 3000);
        } finally {
          btn.disabled = false;
          isRefreshing = false;
        }
      }
      
      // Refresh button - parses fresh from ATS
      document.getElementById("refreshBtn").addEventListener("click", backgroundRefresh);
      
      // My Roles toggle
      document.getElementById("myRolesToggle").addEventListener("change", (e) => {
        myRolesEnabled = e.target.checked;
        console.log("My Roles toggled:", myRolesEnabled);
        
        // Update ALL_JOBS based on toggle
        if (ALL_JOBS_RAW.length > 0) {
          ALL_JOBS = myRolesEnabled ? filterRelevantRoles(ALL_JOBS_RAW) : ALL_JOBS_RAW;
        }
        
        // Re-render current tab
        const jobsTabActive = document.getElementById("tab-jobs").classList.contains("active");
        if (jobsTabActive) {
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          }
        } else {
          // On Companies tab - reload with new filter
          loadCompanies();
        }
        
        // Update status bar
        updateStatus();
      });
      
      // My Location toggle
      document.getElementById("myLocationToggle").addEventListener("change", (e) => {
        myLocationEnabled = e.target.checked;
        console.log("My Location toggled:", myLocationEnabled);
        applyMyLocationFilter();
        
        // Re-render current tab
        const jobsTabActive = document.getElementById("tab-jobs").classList.contains("active");
        console.log("Jobs tab active:", jobsTabActive);
        
        if (jobsTabActive) {
          // Just re-filter existing jobs, don't reload
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          }
        } else {
          // On Companies tab - reload with new my_location param
          console.log("Reloading companies with my_location=", myLocationEnabled);
          loadCompanies();
        }
      });
      
      function applyMyLocationFilter() {
        if (myLocationEnabled) {
          // Apply My Location settings
          selectedStates = [...MY_LOCATION_STATES];
          includeUS = true;
          includeNonUS = false;
          includeRemoteUSA = true;
        } else {
          // Show everything
          selectedStates = [];
          includeUS = true;
          includeNonUS = true;
          includeRemoteUSA = true;
        }
        
        // Update UI checkboxes
        document.getElementById("includeUS").checked = includeUS;
        document.getElementById("includeNonUS").checked = includeNonUS;
        document.getElementById("includeRemoteUSA").checked = includeRemoteUSA;
        
        // Update states UI
        syncStateButton();
      }
      
      // Load environment info
      async function loadEnv() {
        try {
          const res = await fetch("/env");
          const data = await res.json();
          const env = data.env || "PROD";
          const badge = document.getElementById("envBadge");
          badge.textContent = env;
          badge.classList.add(env.toLowerCase());
          if (env === "DEV") {
            document.body.classList.add("env-dev");
            document.title = "[DEV] Job Tracker";
          }
        } catch (e) {
          console.error("Failed to load env:", e);
        }
      }
      
      // Load data on page load
      loadEnv();
      loadCompanies();
      loadJobsFromCache();  // Load jobs for header stats

      // Add Company Modal
      const modal = document.getElementById("addCompanyModal");
      
      document.getElementById("addCompanyBtn").addEventListener("click", () => {
        modal.classList.add("open");
        document.getElementById("newCompanyName").focus();
      });
      
      document.getElementById("cancelAddCompany").addEventListener("click", () => {
        modal.classList.remove("open");
        clearAddCompanyForm();
      });
      
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.remove("open");
          clearAddCompanyForm();
        }
      });
      
      function clearAddCompanyForm() {
        document.getElementById("newCompanyName").value = "";
        document.getElementById("newCompanyUrl").value = "";
        document.getElementById("newCompanyIndustry").value = "";
        document.getElementById("newCompanyAts").value = "greenhouse";
      }
      
      document.getElementById("confirmAddCompany").addEventListener("click", async () => {
        const name = document.getElementById("newCompanyName").value.trim();
        const ats = document.getElementById("newCompanyAts").value;
        const board_url = document.getElementById("newCompanyUrl").value.trim();
        const industry = document.getElementById("newCompanyIndustry").value.trim();
        
        if (!name || !board_url) {
          alert("Please fill in Company Name and Board URL");
          return;
        }
        
        const btn = document.getElementById("confirmAddCompany");
        btn.disabled = true;
        btn.textContent = "Adding...";
        
        try {
          const res = await fetch("/companies", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, ats, board_url, industry, tags: [] })
          });
          const data = await res.json();
          
          if (data.status === "ok") {
            modal.classList.remove("open");
            clearAddCompanyForm();
            await loadCompanies();
          } else {
            alert(data.error || "Failed to add company");
          }
        } catch (err) {
          console.error(err);
          alert("Failed to add company");
        } finally {
          btn.disabled = false;
          btn.textContent = "Add";
        }
      });
    </script>
  </body>
</html>
