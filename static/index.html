<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Job Tracker</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
      :root {
        --bg: #0b0f17;
        --panel: #111827;
        --panel2: #0f172a;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: rgba(255, 255, 255, 0.1);
        --accent: #60a5fa;
        --danger: #ef4444;
        --ok: #22c55e;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Arial;
        background: var(--bg);
        color: var(--text);
      }
      header {
        padding: 18px 18px 10px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          transparent
        );
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }
      .header-left {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .my-location-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.15s;
        user-select: none;
      }
      .my-location-toggle:hover {
        background: var(--hover);
        border-color: var(--accent);
      }
      .my-location-toggle input {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      .my-location-toggle input:checked + span {
        color: var(--accent);
      }
      .refresh-btn {
        background: var(--card);
        border: 1px solid var(--border);
        color: var(--fg);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        white-space: nowrap;
        transition: all 0.15s;
      }
      .refresh-btn:hover:not(:disabled) {
        background: var(--hover);
        border-color: var(--accent);
      }
      .refresh-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .env-badge {
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .env-badge.dev {
        background: #f59e0b;
        color: #000;
      }
      .env-badge.prod {
        background: #22c55e;
        color: #000;
      }
      /* DEV environment header highlight */
      body.env-dev header {
        border-bottom: 2px solid #f59e0b;
      }
      .sub {
        margin-top: 6px;
        color: var(--muted);
        font-size: 12px;
      }
      /* Tabs */
      .tabs {
        display: flex;
        gap: 0;
        border-bottom: 1px solid var(--border);
        padding: 0 18px;
        background: var(--panel);
      }
      .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        color: var(--muted);
        font-size: 14px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        transition: all 0.15s;
      }
      .tab-btn:hover {
        color: var(--text);
      }
      .tab-btn.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block !important;
      }
      
      /* Force Review tab visibility when active */
      #tab-review.active,
      #tab-review.active .wrap,
      #tab-review.active .tableWrap,
      #tab-review.active #reviewTable {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
        overflow: visible !important;
      }
      
      /* Companies table */
      .companies-summary {
        display: flex;
        gap: 20px;
        padding: 16px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 16px;
      }
      
      /* Pipeline table */
      #jobsTable td, #jobsTable th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 8px 12px !important;
      }
      #jobsTable th:first-child, #jobsTable td:first-child {
        text-align: center;
        overflow: visible;
      }
      #jobsTable input[type="checkbox"] {
        width: 14px !important;
        height: 14px !important;
        min-width: 14px !important;
        max-width: 14px !important;
        margin: 6px !important;
        padding: 0 !important;
        display: inline-block !important;
        cursor: pointer;
      }
      /* ID column - first column */
      #jobsTable td:nth-child(1), #jobsTable th:nth-child(1) {
        width: 75px !important;
        max-width: 75px !important;
        padding-left: 12px !important;
      }
      #pipelineFilterJobId {
        width: 50px !important;
        max-width: 50px !important;
        min-width: 50px !important;
      }
      #pipelineFilterCompany {
        width: 110px !important;
        max-width: 110px !important;
        min-width: 110px !important;
      }
      #pipelineFilterTitle {
        width: 180px !important;
        max-width: 180px !important;
        min-width: 180px !important;
      }
      #pipelineFilterLocation {
        width: 100px !important;
        max-width: 100px !important;
        min-width: 100px !important;
      }
      #pipelineFilterUpdated {
        width: 90px !important;
        max-width: 90px !important;
        min-width: 90px !important;
      }
      #pipelineFilterAts {
        width: 70px !important;
        max-width: 70px !important;
        min-width: 70px !important;
      }
      #pipelineFilterStatus {
        width: 65px !important;
        max-width: 65px !important;
        min-width: 65px !important;
      }
      #pipelineFilterFolder {
        width: 30px !important;
        max-width: 30px !important;
        min-width: 30px !important;
      }
      /* Checkbox column - second column */
      #jobsTable td:nth-child(2), #jobsTable th:nth-child(2) {
        width: 40px !important;
        max-width: 40px !important;
        text-align: center;
        padding: 8px 4px !important;
      }
      /* Company column - third column */
      #jobsTable td:nth-child(3), #jobsTable th:nth-child(3) {
        width: 120px !important;
        max-width: 120px !important;
      }
      /* Title column - fourth column */
      #jobsTable td:nth-child(4), #jobsTable th:nth-child(4) {
        width: auto !important;
        max-width: none !important;
      }
      /* Location column - fifth column */
      #jobsTable td:nth-child(5), #jobsTable th:nth-child(5) {
        width: 130px !important;
        max-width: 130px !important;
      }
      /* Updated column - sixth column */
      #jobsTable td:nth-child(6), #jobsTable th:nth-child(6) {
        width: 110px !important;
        max-width: 110px !important;
      }
      /* ATS column - seventh column */
      #jobsTable td:nth-child(7), #jobsTable th:nth-child(7) {
        width: 80px !important;
        max-width: 80px !important;
      }
      /* Status column - eighth column */
      #jobsTable td:nth-child(8), #jobsTable th:nth-child(8) {
        width: 85px !important;
        max-width: 85px !important;
        overflow: visible !important;
      }
      /* Folder column - ninth column */
      #jobsTable td:nth-child(9), #jobsTable th:nth-child(9) {
        width: 35px !important;
        max-width: 35px !important;
        text-align: center;
        overflow: visible !important;
        text-overflow: clip !important;
      }
      /* Actions column - tenth column */
      #jobsTable td:nth-child(10), #jobsTable th:nth-child(10) {
        width: 90px !important;
        max-width: 90px !important;
        overflow: visible !important;
        text-overflow: clip !important;
      }
      
      .summary-item {
        text-align: center;
      }
      .summary-value {
        font-size: 28px;
        font-weight: 600;
        color: var(--text);
      }
      .summary-label {
        font-size: 12px;
        color: var(--muted);
      }
      .company-row {
        cursor: pointer;
      }
      .company-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .ats-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        background: rgba(255,255,255,0.08);
      }
      .status-ok {
        color: #22c55e;
      }
      .status-error {
        color: #ef4444;
      }
      .status-disabled {
        color: #f59e0b;
      }
      .status-unknown {
        color: var(--muted);
      }
      .jobs-badge {
        background: var(--accent);
        color: #000;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 600;
      }
      .jobs-badge.zero {
        background: var(--border);
        color: var(--muted);
      }

      /* Column filters for Companies table */
      .filter-row th {
        padding: 4px 6px;
        background: rgba(255, 255, 255, 0.02);
      }
      .column-filter {
        width: 100%;
        padding: 4px 6px;
        font-size: 11px;
        border-radius: 4px;
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--text);
        box-sizing: border-box;
      }
      .column-filter:focus {
        border-color: var(--accent);
        outline: none;
      }
      .column-filter::placeholder {
        color: var(--muted);
        opacity: 0.6;
      }

      .wrap {
        padding: 14px 18px 24px;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 12px;
        align-items: end;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      select,
      input,
      button {
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 10px;
        font-size: 13px;
        outline: none;
      }
      input {
        min-width: 210px;
      }
      select {
        min-width: 160px;
      }
      button {
        cursor: pointer;
      }
      button.primary {
        background: rgba(96, 165, 250, 0.15);
        border-color: rgba(96, 165, 250, 0.35);
      }
      button.primary:hover {
        background: rgba(96, 165, 250, 0.22);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .pill {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
        padding: 8px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--muted);
        display: inline-block;
      }
      .dot.ok {
        background: var(--ok);
      }
      .dot.bad {
        background: var(--danger);
      }

      /* Table */
      .tableWrap {
        margin-top: 14px;
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        background: var(--panel2);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: rgba(255, 255, 255, 0.04);
      }
      th,
      td {
        padding: 10px 10px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        vertical-align: top;
      }
      th {
        text-align: left;
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }
      tr:hover td {
        background: rgba(255, 255, 255, 0.02);
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      .right {
        text-align: right;
      }

      /* Sortable headers */
      th.sortable {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
      }
      th.sortable:hover {
        color: var(--text);
      }
      .sortIcon {
        display: inline-block;
        margin-left: 6px;
        opacity: 0.7;
        font-size: 11px;
      }

      /* Multi-select dropdown */
      .ms {
        position: relative;
        min-width: 180px;
      }
      .msBtn {
        width: 100%;
        text-align: left;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .msBtn .count {
        color: var(--muted);
        font-size: 12px;
      }
      .msMenu {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        min-width: 200px;
        max-height: 280px;
        overflow-y: auto;
        overflow-x: hidden;
        background: #1e2128;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        display: none;
        z-index: 100;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      }
      .ms.open .msMenu {
        display: block;
      }
      .msSearch {
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 6px;
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        font-size: 13px;
      }
      .msItem {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 6px 8px;
        border-radius: 4px;
        cursor: pointer;
      }
      .msItem:hover {
        background: rgba(255, 255, 255, 0.06);
      }
      .msItem input[type="checkbox"] {
        width: 14px;
        height: 14px;
        min-width: 14px;
        margin: 0;
        accent-color: var(--accent);
        cursor: pointer;
      }
      .msItem label {
        cursor: pointer;
        font-size: 13px;
        color: var(--text);
        white-space: nowrap;
      }
      .msItem input[type="checkbox"]:checked + label {
        color: var(--accent);
        font-weight: 500;
      }
      .msFooter {
        display: flex;
        gap: 6px;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid var(--border);
      }
      .msFooter button {
        flex: 1;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
      }
      .ghost {
        opacity: 0.45;
      }
      .checkboxRow {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
      }
      .checkboxRow input {
        min-width: auto;
      }

      /* Status row colors */
      tr[data-status="Selected"] {
        background: rgba(251, 191, 36, 0.15);
      }
      tr[data-status="Ready"] {
        background: rgba(16, 185, 129, 0.15);
      }
      tr[data-status="Applied"] {
        background: rgba(96, 165, 250, 0.1);
      }
      tr[data-status="Interview"] {
        background: rgba(34, 197, 94, 0.15);
      }
      tr[data-status="Offer"] {
        background: rgba(34, 197, 94, 0.25);
      }
      tr[data-status="Rejected"] {
        background: rgba(239, 68, 68, 0.1);
      }
      tr[data-status="Withdrawn"] {
        background: rgba(156, 163, 175, 0.1);
      }
      tr[data-status="Closed"] {
        background: rgba(156, 163, 175, 0.1);
        opacity: 0.7;
      }
      
      .status-icon {
        margin-right: 4px;
        font-size: 10px;
      }

      /* Status select inside table */
      .statusSelect {
        min-width: 80px;
        padding: 5px 6px;
        border-radius: 8px !important;
        font-size: 11px;
      }
      
      .addToPipelineBtn {
        background: #2a5a3a;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 14px;
      }
      .addToPipelineBtn:hover {
        background: #3a7a4a;
      }
      
      .applyBtn {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 4px;
      }
      .applyBtn:hover {
        background: #2563eb;
      }
      .applyBtn:disabled {
        background: #6b7280;
        cursor: not-allowed;
      }

      /* ========== STATUS BAR ========== */
      .status-bar {
        display: flex;
        align-items: center;
        gap: 24px;
        flex-wrap: wrap;
        padding: 8px 0;
      }

      .status-main {
        display: flex;
        align-items: baseline;
        gap: 8px;
      }

      .status-count {
        font-size: 32px;
        font-weight: 700;
        color: var(--accent);
        line-height: 1;
      }

      .status-count.zero {
        color: var(--muted);
      }

      .status-label {
        font-size: 14px;
        color: var(--muted);
      }

      .status-pipeline {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        color: var(--muted);
      }

      .pipe-item {
        padding: 2px 8px;
        background: var(--card);
        border-radius: 4px;
      }

      .pipe-item.active {
        background: var(--accent);
        color: var(--bg);
      }

      .pipe-arrow {
        color: var(--muted);
        opacity: 0.5;
      }

      .status-geo {
        display: flex;
        gap: 8px;
      }

      .geo-badge {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .geo-badge.nc {
        background: #10b98120;
        color: #10b981;
      }

      .geo-badge.neighbor {
        background: #3b82f620;
        color: #3b82f6;
      }

      .geo-badge.remote {
        background: #8b5cf620;
        color: #8b5cf6;
      }

      .geo-badge .geo-count {
        font-weight: 700;
      }

      /* Modal */
      /* Modal for Add Job */
      #addJobModal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      #addJobModal .modal-content {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        width: 500px;
        max-width: 90vw;
      }
      #addJobModal h3 {
        margin: 0 0 8px 0;
        font-size: 18px;
      }
      #addJobModal input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--panel);
        font-size: 14px;
        box-sizing: border-box;
        color: var(--text);
      }
      #addJobModal input:focus {
        border-color: var(--accent);
        outline: none;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        width: 400px;
        max-width: 90vw;
      }
      .modal h3 {
        margin: 0 0 16px 0;
        font-size: 18px;
      }
      .modal label {
        display: block;
        margin-bottom: 12px;
      }
      .modal input, .modal select {
        width: 100%;
        padding: 8px 12px;
        margin-top: 4px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--panel);
        font-size: 14px;
        box-sizing: border-box;
      }
      .modal-actions {
        display: flex;
        gap: 8px;
        margin-top: 20px;
        justify-content: flex-end;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-left" style="position: relative;">
        <h1>Job Tracker <span id="envBadge" class="env-badge"></span></h1>
        <div class="status-bar" id="statusBar">
          <div class="status-pipeline" id="statusPipeline">
            <span class="pipe-item">Not loaded</span>
          </div>
          <div class="status-geo" id="statusGeo"></div>
        </div>
        <div id="staleWarning" style="display: none; background: #78350f; color: #fbbf24; padding: 6px 12px; border-radius: 6px; font-size: 12px; margin-top: 6px;">
          ‚ö†Ô∏è Data is <span id="staleAge">0</span>h old ‚Äî click <strong>Refresh from ATS</strong> to update
        </div>
        <div id="daemonStatus" style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); margin-top: 6px; cursor: pointer;" onclick="toggleRefreshLog()" title="Click to see refresh log">
          <span id="daemonIndicator" style="width: 8px; height: 8px; border-radius: 50%; background: #6b7280;"></span>
          <span id="daemonText">Auto-refresh: Loading...</span>
          <span style="font-size: 10px; opacity: 0.6;">‚ñº</span>
        </div>
        <!-- Refresh Log Panel -->
        <div id="refreshLogPanel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 300px; overflow-y: auto; background: var(--panel); border: 1px solid var(--border); border-radius: 0 0 8px 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; margin-top: 4px;">
          <div style="padding: 8px 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--panel);">
            <span style="font-weight: 500; font-size: 13px;">üîÑ Refresh Progress</span>
            <span id="refreshLogSummary" style="font-size: 12px; color: var(--muted);">0/0 companies</span>
          </div>
          <div id="refreshLogList" style="padding: 4px 0; font-size: 12px; font-family: monospace;"></div>
        </div>
      </div>
      <div class="header-actions">
        <button class="refresh-btn" id="refreshBtn">üîÑ Refresh from ATS</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn" data-tab="companies">Companies</button>
      <button class="tab-btn active" data-tab="jobs">Pipeline</button>
      <button class="tab-btn" data-tab="answers">Answers</button>
    </div>

    <!-- Companies Tab -->
    <div class="tab-content" id="tab-companies">
      <div class="wrap">
        <div class="companies-summary" id="companiesSummary">
          <div class="summary-item">
            <div class="summary-value" id="summaryCompanies">‚Äî</div>
            <div class="summary-label">Companies</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="summaryJobs">‚Äî</div>
            <div class="summary-label">Positions</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="summaryNew">‚Äî</div>
            <div class="summary-label">New</div>
          </div>
          <div class="summary-item">
            <div class="summary-value" id="summaryApplied">‚Äî</div>
            <div class="summary-label">Applied</div>
          </div>
          <button id="addCompanyBtn" class="ghost" style="margin-left: 8px;">+ Add Company</button>
          <button id="syncToProdBtn" class="ghost" style="margin-left: 8px; display: none;">üîÑ Sync to PROD</button>
        </div>

        <!-- Stats by Date -->
        <div id="statsByDateSection" style="margin-top: 16px; margin-bottom: 16px;">
          <h3 style="margin-bottom: 12px; color: var(--text); font-size: 14px;">üìä Jobs by Date</h3>
          <div style="overflow-x: auto;">
            <table id="statsByDateTable" style="width: 100%; font-size: 12px;">
              <thead>
                <tr style="background: var(--card);">
                  <th style="text-align: left; padding: 8px;">Date</th>
                  <th style="text-align: right; padding: 8px;">Total</th>
                  <th style="text-align: right; padding: 8px; color: #10b981;">Primary</th>
                  <th style="text-align: right; padding: 8px; color: #3b82f6;">Adjacent</th>
                  <th style="text-align: right; padding: 8px; color: #f59e0b;">Unknown</th>
                  <th style="text-align: right; padding: 8px; color: #ef4444;">Excluded</th>
                  <th style="text-align: right; padding: 8px; color: #3b82f6;">US</th>
                  <th style="text-align: right; padding: 8px; color: #10b981;">NC</th>
                  <th style="text-align: right; padding: 8px; color: #8b5cf6;">Neighbor</th>
                  <th style="text-align: right; padding: 8px; color: #6366f1;">Remote</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="10" style="text-align:center; padding: 20px; color: var(--muted);">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <div id="statsLastRefresh" style="margin-top: 8px; font-size: 11px; color: var(--muted);"></div>
        </div>

        <div class="tableWrap">
          <table id="companiesTable">
            <thead>
              <tr>
                <th class="sortable" style="width: 180px" onclick="sortCompanies('company')">Company <span class="sortIcon" id="sortIcon-c-company">‚¨ç</span></th>
                <th class="sortable" style="width: 80px" onclick="sortCompanies('industry')">Industry <span class="sortIcon" id="sortIcon-c-industry">‚¨ç</span></th>
                <th class="sortable" style="width: 80px" onclick="sortCompanies('ats')">ATS <span class="sortIcon" id="sortIcon-c-ats">‚¨ç</span></th>
                <th class="sortable" style="width: 80px" onclick="sortCompanies('total_jobs')" title="Total jobs from ATS">Total <span class="sortIcon" id="sortIcon-c-total_jobs">‚¨ç</span></th>
                <th class="sortable" style="width: 80px" onclick="sortCompanies('jobs_count')" title="PM/TPM jobs in pipeline">Jobs <span class="sortIcon" id="sortIcon-c-jobs_count">‚¨ç</span></th>
                <th class="sortable" style="width: 60px" onclick="sortCompanies('new_count')">New <span class="sortIcon" id="sortIcon-c-new_count">‚¨ç</span></th>
                <th class="sortable" style="width: 70px" onclick="sortCompanies('applied_count')">Applied <span class="sortIcon" id="sortIcon-c-applied_count">‚¨ç</span></th>
                <th class="sortable" style="width: 80px" onclick="sortCompanies('last_ok')">Status <span class="sortIcon" id="sortIcon-c-last_ok">‚¨ç</span></th>
                <th class="sortable" style="width: 75px" onclick="sortCompanies('last_checked')">Updated <span class="sortIcon" id="sortIcon-c-last_checked">‚¨ç</span></th>
                <th style="width: 60px">Actions</th>
              </tr>
              <tr class="filter-row">
                <th><input type="text" id="filterCompany" placeholder="Filter..." class="column-filter"></th>
                <th><input type="text" id="filterIndustry" placeholder="Filter..." class="column-filter"></th>
                <th>
                  <select id="filterAts" class="column-filter">
                    <option value="">All</option>
                    <option value="greenhouse">greenhouse</option>
                    <option value="lever">lever</option>
                    <option value="workday">workday</option>
                    <option value="smartrecruiters">smartrecruiters</option>
                    <option value="ashby">ashby</option>
                  </select>
                </th>
                <th></th>
                <th><input type="number" id="filterJobsMin" placeholder="Min" class="column-filter" style="width: 50px"></th>
                <th></th>
                <th></th>
                <th>
                  <select id="filterStatus" class="column-filter">
                    <option value="">All</option>
                    <option value="ok">‚úÖ OK</option>
                    <option value="error">‚ùå Error</option>
                    <option value="disabled">‚è∏Ô∏è Disabled</option>
                  </select>
                </th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="companiesBody">
              <tr><td colspan="10" style="text-align:center; padding: 40px; color: var(--muted);">Loading companies...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Jobs Tab -->
    <div class="tab-content active" id="tab-jobs">
    <div class="wrap">
      <div class="controls">
        <span class="pill" id="loadPill"><span class="dot" id="loadDot"></span><span id="loadText">Idle</span></span>
      </div>
      
      <!-- Quick Filters Row -->
      <div id="quickFilters" style="display: flex; gap: 8px; align-items: center; margin: 12px 0; padding: 12px; background: var(--panel); border-radius: 8px; flex-wrap: wrap;">
        <!-- Quick Filter Buttons -->
        <div style="display: flex; gap: 6px; margin-right: 16px;">
          <button class="quick-filter-btn" data-filter="new-week" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel2); color: var(--text); cursor: pointer; font-size: 12px; white-space: nowrap;">üî• New this week</button>
          <button class="quick-filter-btn" data-filter="to-apply" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel2); color: var(--text); cursor: pointer; font-size: 12px; white-space: nowrap;">üìã To Apply</button>
          <button class="quick-filter-btn" data-filter="applied" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel2); color: var(--text); cursor: pointer; font-size: 12px; white-space: nowrap;">üì§ Applied</button>
          <button class="quick-filter-btn active" data-filter="all" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--accent); color: white; cursor: pointer; font-size: 12px; white-space: nowrap;">All</button>
        </div>
        
        <!-- Date Range -->
        <select id="dateRangeFilter" class="column-filter" style="width: 120px; font-size: 12px; padding: 6px;">
          <option value="7">Last 7 days</option>
          <option value="14">Last 2 weeks</option>
          <option value="30">Last month</option>
          <option value="90">Last 3 months</option>
          <option value="all" selected>All time</option>
        </select>
        
        <!-- Location Category -->
        <select id="locationCategoryFilter" class="column-filter" style="width: 90px; font-size: 12px; padding: 6px;">
          <option value="all" selected>All Loc</option>
          <option value="us">US Only</option>
          <option value="remote">Remote</option>
          <option value="nonus">Non-US</option>
        </select>
        
        <!-- States Multi-select -->
        <div class="ms" id="stateMultiSelect" style="min-width: 100px;">
          <button class="msBtn column-filter" id="stateBtn" type="button" style="width: 100%; text-align: left; padding: 6px 8px;">
            <span id="stateBtnText" style="font-size: 12px;">States...</span>
            <span class="count" id="stateBtnCount" style="font-size: 11px;">0</span>
          </button>
          <div class="msMenu" id="stateMenu">
            <input class="msSearch" id="stateSearch" placeholder="Search..." />
            <div id="stateList"></div>
            <div class="msFooter">
              <button type="button" id="stateClear" class="ghost">Clear</button>
              <button type="button" id="stateClose">Done</button>
            </div>
          </div>
        </div>
        
        <!-- Search -->
        <div style="flex: 1; min-width: 200px;">
          <input type="text" id="globalSearchFilter" placeholder="üîç Search company, title..." style="width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 12px;">
        </div>
        
        <!-- ATS Filter -->
        <select id="pipelineFilterAtsQuick" class="column-filter" style="width: 100px; font-size: 12px; padding: 6px;">
          <option value="">All ATS</option>
          <option value="greenhouse">Greenhouse</option>
          <option value="lever">Lever</option>
          <option value="smartrecruiters">SmartRecr.</option>
          <option value="workday">Workday</option>
          <option value="ashby">Ashby</option>
          <option value="manual">üìå Manual</option>
        </select>
        
        <!-- Clear All -->
        <button id="clearFiltersBtn" class="ghost" style="padding: 6px 10px; font-size: 11px; color: var(--muted);" title="Clear all filters">‚úï Clear</button>
        
        <!-- Add Job Button -->
        <button id="addJobBtn" class="ghost" style="padding: 6px 12px; background: var(--accent); color: white; margin-left: auto;">+ Add Job</button>
      </div>
      
      <!-- Bulk Actions Toolbar -->
      <div id="bulkActionsBar" style="display: none; align-items: center; gap: 12px; margin: 8px 0; padding: 10px 16px; background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%); border-radius: 8px; border: 1px solid #3b5998;">
        <span id="selectedCount" style="font-weight: 600; color: #93c5fd;">0 selected</span>
        <div style="height: 20px; width: 1px; background: #4b6a9b;"></div>
        
        <!-- Engine Selection -->
        <div style="display: flex; align-items: center; gap: 6px;">
          <span style="font-size: 12px; color: #93c5fd;">Engine:</span>
          <select id="fillerEngineSelect" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #4b6a9b; background: #1e3a5f; color: white; font-size: 12px;">
            <option value="v6" selected>V6 (AI + Simple)</option>
            <option value="v5">V5 (Full Features)</option>
          </select>
        </div>
        
        <div style="height: 20px; width: 1px; background: #4b6a9b;"></div>
        
        <!-- Actions -->
        <button id="bulkApplyBtn" style="padding: 6px 14px; border-radius: 6px; border: none; background: #16a34a; color: white; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
          üöÄ <span>Apply Selected</span>
        </button>
        
        <button id="bulkOpenUrlsBtn" style="padding: 6px 14px; border-radius: 6px; border: none; background: #6366f1; color: white; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
          üîó <span>Open URLs</span>
        </button>
        
        <div style="flex: 1;"></div>
        
        <button id="bulkClearBtn" style="padding: 4px 10px; border-radius: 4px; border: 1px solid #4b6a9b; background: transparent; color: #93c5fd; cursor: pointer; font-size: 12px;">
          ‚úï Clear Selection
        </button>
      </div>
      
      <!-- Pagination Row -->
      <div id="pipelinePagination" style="display: flex; align-items: center; justify-content: space-between; margin: 8px 0; padding: 8px 0; border-bottom: 1px solid var(--border);">
        
        <div style="color: var(--muted); font-size: 13px;">
          Showing <span id="paginationStart">0</span>-<span id="paginationEnd">0</span> of <span id="paginationTotal">0</span> jobs
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <button id="paginationPrev" class="ghost" style="padding: 6px 12px;" disabled>‚óÄ Prev</button>
          <span style="color: var(--muted); font-size: 13px;">Page <span id="paginationCurrent">1</span> of <span id="paginationPages">1</span></span>
          <button id="paginationNext" class="ghost" style="padding: 6px 12px;" disabled>Next ‚ñ∂</button>
          <select id="paginationSize" class="column-filter" style="width: 80px; margin-left: 12px;">
            <option value="25">25</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="250">250</option>
          </select>
        </div>
      </div>

      <div class="tableWrap">
        <div style="overflow-x: auto;"><table id="jobsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th style="text-align: center;">‚úì</th>
              <th class="sortable" onclick="sortTable('company')">
                Company <span class="sortIcon" id="sortIcon-company">‚¨ç</span>
              </th>
              <th class="sortable" onclick="sortTable('title')">
                Title <span class="sortIcon" id="sortIcon-title">‚¨ç</span>
              </th>
              <th class="sortable" onclick="sortTable('location')">
                Location <span class="sortIcon" id="sortIcon-location">‚¨ç</span>
              </th>
              <th class="sortable" onclick="sortTable('updated')">
                Updated <span class="sortIcon" id="sortIcon-updated">‚¨ç</span>
              </th>
              <th class="sortable" onclick="sortTable('ats')">
                ATS <span class="sortIcon" id="sortIcon-ats">‚¨ç</span>
              </th>
              <th class="sortable" onclick="sortTable('status')">
                Status <span class="sortIcon" id="sortIcon-status">‚¨ç</span>
              </th>
              <th>üìÅ</th>
              <th>Actions</th>
            </tr>
            <tr class="filter-row">
              <th><input type="text" id="pipelineFilterJobId" placeholder="..." class="column-filter" style="width: 60px;"></th>
              <th style="text-align: center;">
                <input type="checkbox" id="selectAllJobs" title="Select all">
              </th>
              <th><input type="text" id="pipelineFilterCompany" placeholder="..." class="column-filter" style="width: 100%;"></th>
              <th><input type="text" id="pipelineFilterTitle" placeholder="..." class="column-filter" style="width: 100%;"></th>
              <th><input type="text" id="pipelineFilterLocation" placeholder="..." class="column-filter" style="width: 100%;"></th>
              <th><input type="text" id="pipelineFilterUpdated" placeholder="..." class="column-filter" style="width: 100%;"></th>
              <th>
                <select id="pipelineFilterAts" class="column-filter" style="width: 100%;">
                  <option value="">-</option>
                  <option value="greenhouse">GH</option>
                  <option value="lever">Lever</option>
                  <option value="workday">WD</option>
                  <option value="smartrecruiters">SR</option>
                  <option value="ashby">Ashby</option>
                  <option value="manual">üìå</option>
                </select>
              </th>
              <th>
                <select id="pipelineFilterStatus" class="column-filter" style="width: 100%;">
                  <option value="all">-</option>
                  <option value="New">New</option>
                  <option value="Selected">Sel</option>
                  <option value="Ready">Rdy</option>
                  <option value="Applied">App</option>
                  <option value="Interview">Int</option>
                </select>
              </th>
              <th>
                <select id="pipelineFilterFolder" class="column-filter" style="width: 100%;">
                  <option value="all">-</option>
                  <option value="yes">‚úì</option>
                  <option value="no">‚úó</option>
                </select>
              </th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- rows -->
          </tbody>
        </table>
      </div></div>

    </div> <!-- end wrap -->
    </div> <!-- end tab-jobs -->

    <!-- Review Tab (Unknown + Excluded jobs) -->
    <div class="tab-content" id="tab-review">
      <div class="wrap">
      <div class="filter-row" style="margin-bottom: 15px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <label>
          Category
          <select id="reviewCategoryFilter">
            <option value="unknown" selected>Unknown (needs review)</option>
            <option value="excluded">Excluded (Engineers, Sales...)</option>
            <option value="all">All Non-Relevant</option>
          </select>
        </label>
        
        <label>
          Search
          <input type="text" id="reviewSearchFilter" placeholder="title, company..." style="width: 200px;">
        </label>
        
        <button id="addSelectedBtn" class="ghost" style="background: #2a5a3a; color: white;" disabled>
          ‚ûï Add Selected (0)
        </button>
        
        <span id="reviewStatus" class="muted"></span>
      </div>
      
      <div class="tableWrap">
      <table id="reviewTable">
        <thead>
          <tr>
            <th style="width: 40px;"><input type="checkbox" id="reviewSelectAll" title="Select all"></th>
            <th class="sortable" style="width: 120px" data-sort="company">Company <span class="sortIcon">‚¨ç</span></th>
            <th class="sortable" data-sort="title">Title <span class="sortIcon">‚¨ç</span></th>
            <th class="sortable" style="width: 200px" data-sort="location">Location <span class="sortIcon">‚¨ç</span></th>
            <th style="width: 120px">Role Reason</th>
            <th style="width: 75px">Pipeline</th>
          </tr>
          <tr class="filter-row">
            <th></th>
            <th><input type="text" id="reviewFilterCompany" placeholder="Filter..." class="column-filter"></th>
            <th><input type="text" id="reviewFilterTitle" placeholder="Filter..." class="column-filter"></th>
            <th><input type="text" id="reviewFilterLocation" placeholder="Filter..." class="column-filter"></th>
            <th></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- Review jobs will be loaded here -->
        </tbody>
      </table>
      </div> <!-- end tableWrap -->
      
      <div class="muted" style="margin-top: 10px">
        Tip: Select jobs and click "Add Selected" to add them to your Pipeline.
      </div>
      </div> <!-- end wrap -->
    </div> <!-- end tab-review -->

    <!-- Answers Tab -->
    <div class="tab-content" id="tab-answers">
      <h3 style="margin: 0 0 16px 0;">Answer Library</h3>
      
      <!-- Personal Info -->
      <div class="card" style="margin-bottom: 16px; padding: 16px;">
        <h4 style="margin: 0 0 12px 0; color: var(--accent);">Personal Info</h4>
        <div id="personalInfo" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;"></div>
      </div>
      
      <!-- Demographics -->
      <div class="card" style="margin-bottom: 16px; padding: 16px;">
        <h4 style="margin: 0 0 12px 0; color: var(--accent);">Demographics (EEO)</h4>
        <div id="demographicsInfo" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;"></div>
      </div>
      
      <!-- Education -->
      <div class="card" style="margin-bottom: 16px; padding: 16px;">
        <h4 style="margin: 0 0 12px 0; color: var(--accent);">Education</h4>
        <div id="educationInfo"></div>
      </div>
      
      <!-- Employment -->
      <div class="card" style="margin-bottom: 16px; padding: 16px;">
        <h4 style="margin: 0 0 12px 0; color: var(--accent);">Employment History</h4>
        <div id="employmentInfo"></div>
      </div>
      
      <!-- Answers -->
      <div class="card" style="padding: 16px;">
        <h4 style="margin: 0 0 12px 0; color: var(--accent);">Common Questions</h4>
        <div id="answersList"></div>
      </div>
    </div> <!-- end tab-answers -->

    <!-- Cover Letter Modal -->
    <div id="coverLetterModal" class="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:200;">
      <div class="modal-content" style="background:var(--card); border:1px solid var(--border); border-radius:12px; padding:24px; width:700px; max-width:90vw; max-height:85vh; overflow-y:auto;">
        <h3 style="margin:0 0 16px 0;">üìù Generate Cover Letter</h3>
        <div style="display:grid; gap:12px; margin-bottom:16px;">
          <div style="display:flex; gap:12px;">
            <label style="flex:1;">Company <input type="text" id="clCompany" style="width:100%; margin-top:4px;"></label>
            <label style="flex:1;">Position <input type="text" id="clPosition" style="width:100%; margin-top:4px;"></label>
          </div>
          <label>Role Type
            <select id="clRoleFamily" style="width:100%; margin-top:4px; padding:8px;">
              <option value="product">Product Manager</option>
              <option value="tpm_program">TPM / Delivery Lead</option>
              <option value="project">Project Manager</option>
              <option value="po">Product Owner</option>
              <option value="scrum">Scrum Master</option>
            </select>
          </label>
          <label>Job Description (optional - helps AI generate better mission statement)
            <textarea id="clDescription" rows="4" style="width:100%; margin-top:4px;" placeholder="Paste job description here..."></textarea>
          </label>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="clCancel" class="ghost">Cancel</button>
          <button id="clGenerate" style="background:var(--accent); color:white;">üöÄ Generate</button>
        </div>
        <div id="clResult" style="margin-top:16px; display:none;">
          <div style="display:flex; gap:12px; margin-bottom:12px;">
            <div style="flex:1; padding:12px; background:var(--panel); border-radius:8px;">
              <div style="font-size:11px; color:var(--muted);">üìÑ Template Used</div>
              <div id="clTemplateName" style="font-weight:500;"></div>
            </div>
            <div style="flex:1; padding:12px; background:var(--panel); border-radius:8px;">
              <div style="font-size:11px; color:var(--muted);">üìÅ Saved To</div>
              <div id="clFolderName" style="font-weight:500; font-size:12px;"></div>
            </div>
          </div>
          <div style="margin-bottom:12px; padding:12px; background:#1a4d1a; border-radius:8px;">
            <div style="font-size:11px; color:#86efac; margin-bottom:4px;">üéØ AI-Generated Company Mission</div>
            <div id="clMission" style="color:#bbf7d0; font-style:italic;"></div>
          </div>
          <details style="margin-bottom:12px;">
            <summary style="cursor:pointer; color:var(--muted);">Preview Full Letter</summary>
            <pre id="clOutput" style="background:var(--panel); padding:16px; border-radius:8px; white-space:pre-wrap; font-size:12px; margin-top:8px; max-height:300px; overflow-y:auto;"></pre>
          </details>
          <div style="display:flex; gap:8px;">
            <button id="clOpenFolder" style="background:#3b82f6; color:white; border:none; border-radius:6px; padding:8px 16px; cursor:pointer;">üìÅ Open in Finder</button>
            <button id="clCopy" style="background:var(--accent); color:white; border:none; border-radius:6px; padding:8px 16px; cursor:pointer;">üìã Copy Text</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Add Job Modal -->
    <div id="addJobModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <h3>Add Job to Pipeline</h3>
        <p style="color: var(--muted); font-size: 13px; margin-bottom: 16px;">Paste a job URL from any supported ATS (Greenhouse, Lever, Workday, SmartRecruiters, Ashby)</p>
        
        <label style="display: block; margin-bottom: 12px;">
          Job URL *
          <input type="url" id="addJobUrl" placeholder="https://boards.greenhouse.io/company/jobs/12345" style="width: 100%; margin-top: 4px;">
        </label>
        
        <div id="addJobStatus" style="margin: 12px 0; padding: 8px; border-radius: 4px; display: none;"></div>
        
        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
          <button type="button" id="addJobCancel" class="ghost">Cancel</button>
          <button type="button" id="addJobSubmit" style="background: var(--accent); color: white;">Add Job</button>
        </div>
      </div>
    </div>


    <!-- Application Preparation Modal - NEW VERSION -->
    <div id="jobAnalysisModal" class="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:200; overflow:auto;">
      <div class="modal-content" style="background:var(--card); position:absolute; top:20px; left:20px; right:20px; bottom:20px; border-radius:12px; overflow:hidden; display:flex; max-width: 900px; margin: 0 auto;">
        
        <!-- Left Panel: Analysis -->
        <div style="flex: 1; min-width: 300px; padding: 20px; border-right: 1px solid var(--border); overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">üìã Application Preparation</h3>
            <button onclick="closeAnalysisModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">√ó</button>
          </div>
          
          <!-- Job Info -->
          <div style="margin-bottom: 20px; padding: 16px; background: var(--bg); border-radius: 8px;">
            <div style="font-size: 18px; font-weight: 600;" id="analysisCompanyName">Company</div>
            <div style="font-size: 14px; color: var(--muted);" id="analysisPositionName">Position</div>
          </div>
          
          <!-- Loading State -->
          <div id="prepareLoading" style="text-align: center; padding: 40px;">
            <div style="font-size: 24px; margin-bottom: 16px;">‚è≥</div>
            <div style="color: var(--muted);">Analyzing job with AI...</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 8px;">This may take 10-15 seconds</div>
          </div>
          
          <!-- Existing Files Choice -->
          <div id="existingFilesChoice" style="display: none; padding: 20px; background: var(--bg); border-radius: 8px; border: 2px solid #8b5cf6;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">‚úÖ Found existing application files!</div>
            <div style="margin-bottom: 16px; font-size: 14px;">
              <div id="existingFolderInfo" style="cursor: pointer; color: var(--muted);" onclick="openExistingFolder()"></div>
              <div id="existingCvInfo" style="margin-top: 8px; cursor: pointer;" onclick="openExistingCv()"></div>
              <div id="existingClInfo" style="margin-top: 4px; cursor: pointer;" onclick="openExistingCl()"></div>
              <div id="existingDateInfo" style="margin-top: 8px; font-style: italic; color: var(--muted);"></div>
            </div>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
              <button onclick="openExistingFolder()" style="flex: 1; padding: 8px; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 12px;">
                üìÇ Open Folder
              </button>
              <button id="btnOpenExistingCv" onclick="openExistingCv()" style="flex: 1; padding: 8px; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 12px;">
                üìÑ Open CV
              </button>
              <button id="btnOpenExistingCl" onclick="openExistingCl()" style="flex: 1; padding: 8px; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 12px;">
                üìù Open Letter
              </button>
            </div>
            <div style="display: flex; gap: 12px;">
              <button id="btnUseExisting" onclick="useExistingFiles()" style="flex: 1; padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                ‚úÖ Use Existing Files
              </button>
              <button id="btnRegenerate" onclick="regenerateFiles()" style="flex: 1; padding: 12px; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 14px;">
                üîÑ Regenerate with AI
              </button>
            </div>
          </div>
          
          <!-- Results (hidden initially) -->
          <div id="prepareResults" style="display: none;">
            
            <!-- Match Score Card -->
            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
              <div style="flex: 1; padding: 16px; background: var(--bg); border-radius: 8px; text-align: center;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">Match Score</div>
                <div id="prepMatchScore" style="font-size: 28px; font-weight: bold; color: #10b981;">--</div>
              </div>
              <div style="flex: 1; padding: 16px; background: var(--bg); border-radius: 8px; text-align: center;">
                <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">Fit Level</div>
                <div id="prepFitLevel" style="font-size: 16px; font-weight: 500;">--</div>
              </div>
            </div>
            
            <!-- AI Summary -->
            <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); border-radius: 8px;">
              <div style="font-size: 11px; color: #a5b4fc; margin-bottom: 6px;">üß† AI Analysis</div>
              <div id="prepSummary" style="font-size: 13px; color: #e0e7ff; line-height: 1.5;"></div>
            </div>
            
            <!-- Matching Experience -->
            <div id="prepMatchingSection" style="margin-bottom: 16px;">
              <div style="font-size: 12px; color: #10b981; font-weight: 500; margin-bottom: 8px;">‚úÖ Your Matching Experience</div>
              <div id="prepMatching" style="font-size: 12px;"></div>
            </div>
            
            <!-- Gaps -->
            <div id="prepGapsSection" style="margin-bottom: 16px; display: none;">
              <div style="font-size: 12px; color: #f59e0b; font-weight: 500; margin-bottom: 8px;">‚ö†Ô∏è Potential Gaps</div>
              <div id="prepGaps" style="font-size: 12px;"></div>
            </div>
            
            <!-- Red Flags -->
            <div id="prepRedFlagsSection" style="margin-bottom: 16px; display: none;">
              <div style="font-size: 12px; color: #ef4444; font-weight: 500; margin-bottom: 8px;">üö® Red Flags</div>
              <div id="prepRedFlags" style="font-size: 12px;"></div>
            </div>
            
            <!-- CV Decision -->
            <div style="margin-bottom: 16px; padding: 12px; background: var(--bg); border-radius: 8px;">
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 6px;">üìÑ CV Decision</div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span id="prepCvBadge" style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">BASE</span>
                <span id="prepCvReason" style="font-size: 12px; color: var(--muted);"></span>
              </div>
              <div id="prepKeywordsAdded" style="margin-top: 8px; font-size: 11px; display: none;">
                <span style="color: #10b981;">Keywords added:</span> <span id="prepKeywordsList"></span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Right Panel: Documents -->
        <div id="rightPanelDocs" style="width: 280px; flex-shrink: 0; padding: 16px; background: var(--bg); display: flex; flex-direction: column; overflow-y: auto;">
          <h4 style="margin: 0 0 20px 0;">üìÅ Documents</h4>
          
          <!-- CV Card -->
          <div style="margin-bottom: 16px; padding: 16px; background: var(--card); border-radius: 8px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <div style="font-size: 12px; color: var(--muted);">üìÑ CV</div>
                <div id="prepCvFilename" style="font-size: 13px; font-weight: 500; margin-top: 4px;">--</div>
              </div>
              <span id="prepCvStatus" style="padding: 2px 8px; background: #10b981; color: white; border-radius: 4px; font-size: 10px;">Ready</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <button id="btnOpenCv" onclick="openPreparedFile('cv')" style="flex: 1; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" disabled>üìÇ Open</button>
              <button id="btnOpenCvFolder" onclick="openPreparedFile('folder')" style="flex: 1; padding: 8px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 11px;" disabled>üìÅ Folder</button>
            </div>
          </div>
          
          <!-- Cover Letter Card -->
          <div style="margin-bottom: 16px; padding: 16px; background: var(--card); border-radius: 8px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <div style="font-size: 12px; color: var(--muted);">üìù Cover Letter</div>
                <div id="prepClFilename" style="font-size: 13px; font-weight: 500; margin-top: 4px;">--</div>
              </div>
              <span id="prepClStatus" style="padding: 2px 8px; background: #10b981; color: white; border-radius: 4px; font-size: 10px;">Ready</span>
            </div>
            <button id="btnOpenCl" onclick="openPreparedFile('cover_letter')" style="width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" disabled>üìÇ Open Cover Letter</button>
          </div>
          
          <!-- Cover Letter Preview -->
          <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">Cover Letter Preview</div>
            <div id="prepClPreview" style="flex: 1; padding: 12px; background: var(--card); border-radius: 8px; border: 1px solid var(--border); overflow-y: auto; font-size: 12px; line-height: 1.6; white-space: pre-wrap;">Generating...</div>
          </div>
          
          <!-- Actions -->
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
            <!-- Engine Selection -->
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 10px; background: var(--bg); border-radius: 6px;">
              <span style="font-size: 13px; color: var(--muted);">Form Filler:</span>
              <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                <input type="radio" name="fillerEngine" value="v6" checked style="accent-color: #16a34a;">
                <span style="font-size: 13px;">V6 (AI + Simple)</span>
              </label>
              <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                <input type="radio" name="fillerEngine" value="v5" style="accent-color: #3b82f6;">
                <span style="font-size: 13px;">V5 (Full Features)</span>
              </label>
            </div>
            
            <button id="btnStartApplication" onclick="startApplication()" style="width: 100%; padding: 14px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;" disabled>
              üöÄ Start Application
            </button>
            <div style="text-align: center; margin-top: 8px;">
              <button onclick="closeAnalysisModal()" style="background: none; border: none; color: var(--muted); cursor: pointer; font-size: 12px;">Cancel</button>
            </div>
          </div>
        </div>
        
      </div>
    </div>

    <!-- Prepare Result Modal -->
    <div id="prepareResultModal" class="modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:200;">
      <div class="modal-content" style="background:var(--card); border:1px solid var(--border); border-radius:12px; padding:24px; max-width:700px; max-height:85vh; overflow-y:auto;">
        <div class="modal-header">
          <h3>‚úÖ Application Prepared</h3>
          <button class="modal-close" onclick="closePrepareModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom: 16px;">
            <strong id="prepareCompanyName"></strong> - <span id="preparePositionName"></span>
          </div>
          <div style="display: flex; gap: 16px; margin-bottom: 16px;">
            <div style="flex: 1; padding: 12px; background: var(--card); border-radius: 8px;">
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">üìÑ CV</div>
              <div id="prepareCvName" style="font-weight: 500;"></div>
            </div>
            <div style="flex: 1; padding: 12px; background: var(--card); border-radius: 8px;">
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">üìù Template</div>
              <div id="prepareTemplateName" style="font-weight: 500;"></div>
            </div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">üéØ Company Mission (AI Generated)</div>
            <div id="prepareMission" style="padding: 12px; background: var(--card); border-radius: 8px; font-style: italic;"></div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">üìÅ Folder</div>
            <div id="prepareFolderPath" style="padding: 8px; background: var(--card); border-radius: 4px; font-family: monospace; font-size: 11px; word-break: break-all;"></div>
          </div>
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button onclick="openPrepareFolder()" style="background: #3b82f6; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">üìÅ Open in Finder</button>
            <button onclick="closePrepareModal()" style="background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 8px 16px; cursor: pointer;">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Company Modal -->
    <div class="modal-overlay" id="addCompanyModal">
      <div class="modal">
        <h3>Add Company</h3>
        <label>
          Company Name
          <input type="text" id="newCompanyName" placeholder="e.g., Stripe" />
        </label>
        <label>
          ATS
          <select id="newCompanyAts">
            <option value="greenhouse">Greenhouse</option>
            <option value="lever">Lever</option>
            <option value="smartrecruiters">SmartRecruiters</option>
            <option value="ashby">Ashby</option>
            <option value="workday">Workday</option>
          </select>
        </label>
        <label>
          Board URL
          <input type="text" id="newCompanyUrl" placeholder="https://boards.greenhouse.io/company" />
        </label>
        <label>
          Industry
          <input type="text" id="newCompanyIndustry" placeholder="e.g., Fintech, SaaS" />
        </label>
        <div class="modal-actions">
          <button class="ghost" id="cancelAddCompany">Cancel</button>
          <button class="primary" id="confirmAddCompany">Add</button>
        </div>
      </div>
    </div>

    <!-- Refresh Progress Bar (fixed at top) -->
    <div id="refreshModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 8px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
      <div style="max-width: 1200px; margin: 0 auto;">
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="font-weight: 500;">üîÑ Refreshing</span>
          <div style="flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
            <div id="refreshProgressFill" style="height: 100%; width: 0%; background: var(--accent); transition: width 0.2s;"></div>
          </div>
          <span id="refreshProgressText" style="font-size: 13px; color: var(--muted); min-width: 250px;">Starting...</span>
          <button id="closeRefreshModal" class="ghost" style="display: none; padding: 4px 12px;">‚úï</button>
        </div>
        <div id="refreshSummary" style="display: none; margin-top: 8px; font-size: 13px;"></div>
        <div id="refreshLog" style="display: none;"></div>
      </div>
    </div>

    <script>
      // ---------- DATE FORMATTING ----------
      function formatDateWithAge(isoDate) {
        if (!isoDate) return "‚Äî";
        
        try {
          const date = new Date(isoDate);
          if (isNaN(date.getTime())) return isoDate;
          
          const now = new Date();
          const diffMs = now - date;
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          const diffMins = Math.floor(diffMs / (1000 * 60));
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          
          // Format date: "Dec 19, 10:45"
          const month = date.toLocaleDateString('en-US', { month: 'short' });
          const day = date.getDate();
          const hours = date.getHours().toString().padStart(2, '0');
          const mins = date.getMinutes().toString().padStart(2, '0');
          const dateStr = `${month} ${day}, ${hours}:${mins}`;
          
          // Age indicator
          let ageStr;
          if (diffMins < 1) {
            ageStr = "now";
          } else if (diffMins < 60) {
            ageStr = `${diffMins}m`;
          } else if (diffHours < 24) {
            ageStr = `${diffHours}h`;
          } else if (diffDays === 1) {
            ageStr = "1d";
          } else if (diffDays <= 7) {
            ageStr = `${diffDays}d`;
          } else if (diffDays <= 30) {
            const weeks = Math.floor(diffDays / 7);
            ageStr = `${weeks}w`;
          } else {
            ageStr = "30d+";
          }
          
          return `${dateStr} (${ageStr})`;
        } catch (e) {
          return isoDate;
        }
      }

      // ---------- GLOBAL STATE ----------
      let ALL_JOBS_RAW = [];  // All jobs before role filter
      let ALL_JOBS = [];      // Jobs after role filter
      let LAST_LOADED_AT = null;
      let isRefreshing = false;
      let CACHED_STATS = null;  // Pre-computed funnel stats from backend
      
      // Pagination state
      let pipelinePage = 1;
      let pipelinePageSize = 50;
      let pipelineFilteredJobs = []; // Current filtered jobs for pagination

      // My Roles filter settings
      const MY_ROLES = ['product', 'tpm_program', 'project'];
      let myRolesEnabled = true;
      
      // My Location filter settings
      const MY_LOCATION_STATES = ["NC", "VA", "SC", "GA", "TN"];
      let myLocationEnabled = false;
      
      // Defaults: all locations visible when toggles are off
      let selectedStates = [];
      let locationCategory = "us"; // all, us, remote, nonus - default to US
      
      // Quick Filters
      let activeQuickFilter = "all"; // new-week, to-apply, applied, all
      let dateRangeDays = "all"; // 7, 14, 30, 90, or 'all'
      let globalSearchText = "";
      // Job status cache: job_key -> status
      let STATUS_MAP = {};

      const debugCounts = {
        afterIndustry: 0,
        afterRole: 0,
        afterLocation: 0,
        afterCompany: 0,
        afterSearch: 0,
        afterState: 0,
        afterCity: 0,
        afterStatus: 0,
      };

      // ---------- SORT STATE ----------
      let CURRENT_SORT = { column: null, asc: true };

      function setSortIcon(col, icon) {
        const el = document.getElementById(`sortIcon-${col}`);
        if (el) el.textContent = icon;
      }

      function resetAllSortIcons() {
        ["company", "industry", "title", "location", "updated", "ats", "status"].forEach(
          (c) => setSortIcon(c, "‚¨ç")
        );
      }

      function updateSortIcons() {
        resetAllSortIcons();
        if (!CURRENT_SORT.column) return;
        setSortIcon(CURRENT_SORT.column, CURRENT_SORT.asc ? "‚ñ≤" : "‚ñº");
      }

      // keepDirection=true when re-applying sort after re-render
      function sortTable(column, keepDirection = false) {
        const tbody = document.querySelector("#jobsTable tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        if (!keepDirection) {
          if (CURRENT_SORT.column === column) {
            CURRENT_SORT.asc = !CURRENT_SORT.asc;
          } else {
            CURRENT_SORT.column = column;
            CURRENT_SORT.asc = true;
          }
        } else {
          CURRENT_SORT.column = column;
        }

        const asc = !!CURRENT_SORT.asc;

        rows.sort((a, b) => {
          const av = a.dataset[column] || "";
          const bv = b.dataset[column] || "";

          if (column === "updated") {
            const ad = Date.parse(av) || 0;
            const bd = Date.parse(bv) || 0;
            return asc ? ad - bd : bd - ad;
          }

          // stable, case-insensitive
          const cmp = av.localeCompare(bv, undefined, { sensitivity: "base" });
          return asc ? cmp : -cmp;
        });

        // re-append in order
        for (const r of rows) tbody.appendChild(r);

        updateSortIcons();
      }

      function applyCurrentSortIfAny() {
        if (CURRENT_SORT.column) {
          sortTable(CURRENT_SORT.column, true);
        } else {
          updateSortIcons();
        }
      }

      // ---------- STATE LIST (US + DC) ----------
      const US_STATES = [
        { code: "AL", name: "Alabama" },
        { code: "AK", name: "Alaska" },
        { code: "AZ", name: "Arizona" },
        { code: "AR", name: "Arkansas" },
        { code: "CA", name: "California" },
        { code: "CO", name: "Colorado" },
        { code: "CT", name: "Connecticut" },
        { code: "DE", name: "Delaware" },
        { code: "FL", name: "Florida" },
        { code: "GA", name: "Georgia" },
        { code: "HI", name: "Hawaii" },
        { code: "ID", name: "Idaho" },
        { code: "IL", name: "Illinois" },
        { code: "IN", name: "Indiana" },
        { code: "IA", name: "Iowa" },
        { code: "KS", name: "Kansas" },
        { code: "KY", name: "Kentucky" },
        { code: "LA", name: "Louisiana" },
        { code: "ME", name: "Maine" },
        { code: "MD", name: "Maryland" },
        { code: "MA", name: "Massachusetts" },
        { code: "MI", name: "Michigan" },
        { code: "MN", name: "Minnesota" },
        { code: "MS", name: "Mississippi" },
        { code: "MO", name: "Missouri" },
        { code: "MT", name: "Montana" },
        { code: "NE", name: "Nebraska" },
        { code: "NV", name: "Nevada" },
        { code: "NH", name: "New Hampshire" },
        { code: "NJ", name: "New Jersey" },
        { code: "NM", name: "New Mexico" },
        { code: "NY", name: "New York" },
        { code: "NC", name: "North Carolina" },
        { code: "ND", name: "North Dakota" },
        { code: "OH", name: "Ohio" },
        { code: "OK", name: "Oklahoma" },
        { code: "OR", name: "Oregon" },
        { code: "PA", name: "Pennsylvania" },
        { code: "RI", name: "Rhode Island" },
        { code: "SC", name: "South Carolina" },
        { code: "SD", name: "South Dakota" },
        { code: "TN", name: "Tennessee" },
        { code: "TX", name: "Texas" },
        { code: "UT", name: "Utah" },
        { code: "VT", name: "Vermont" },
        { code: "VA", name: "Virginia" },
        { code: "WA", name: "Washington" },
        { code: "WV", name: "West Virginia" },
        { code: "WI", name: "Wisconsin" },
        { code: "WY", name: "Wyoming" },
        { code: "DC", name: "District of Columbia" },
      ];

      // ---------- LOCATION NORMALIZATION ----------
      function normalizeLocation(raw) {
        const out = {
          raw: raw || "",
          city: "",
          state: "",
          state_full: "",
          remote: false,
          remote_scope: "",
        };

        const s = (raw || "").toLowerCase();

        // Remote detection (USA)
        if (
          s.includes("remote") &&
          (s.includes("us") || s.includes("usa") || s.includes("united states"))
        ) {
          out.remote = true;
          out.remote_scope = "usa";
        } else if (s.includes("remote")) {
          out.remote = true;
          out.remote_scope = "global";
        }

        // Try to extract state by code or full name from the raw location string.
        for (const st of US_STATES) {
          const code = st.code.toLowerCase();
          const name = st.name.toLowerCase();

          if (
            s.includes(", " + code) ||
            s.endsWith(" " + code) ||
            s.includes(" " + code + " ") ||
            s.includes("(" + code + ")")
          ) {
            out.state = st.code;
            out.state_full = st.name;
            break;
          }
          if (s.includes(name)) {
            out.state = st.code;
            out.state_full = st.name;
            break;
          }
        }

        // City: naive approach: take first token before comma
        if (raw && raw.includes(",")) {
          out.city = raw.split(",")[0].trim();
        } else {
          out.city = "";
        }

        return out;
      }

      function enrichJobsLocationNorm(jobs) {
        for (const j of jobs) {
          // Only normalize if not already present from backend
          if (!j.location_norm) {
            j.location_norm = normalizeLocation(j.location || "");
          }
          // status fallback - Pipeline uses 'status' (lowercase), convert to Title Case for UI
          if (j.status) {
            // Capitalize first letter for UI display
            j.application_status = j.status.charAt(0).toUpperCase() + j.status.slice(1);
          } else if (j.application_status) {
            // Legacy job - use application_status
            j.status = j.application_status.toLowerCase();
          } else {
            // No status - default to New
            j.status = "new";
            j.application_status = "New";
          }
        }
        return jobs;
      }

      // ---------- FILTER HELPERS ----------
      function matchStatesInJob(location_norm) {
        if (!location_norm) return false;
        const jobState = (location_norm.state || "").toLowerCase();
        const jobStateFull = (location_norm.state_full || "").toLowerCase();

        return selectedStates.some((selState) => {
          selState = selState.toLowerCase();
          return selState === jobState || selState === jobStateFull;
        });
      }

      function isRemoteUSA(location_norm) {
        if (!location_norm) return false;
        return (
          location_norm.remote === true && location_norm.remote_scope === "usa"
        );
      }

      function isUSHeuristic(job) {
        // Use normalized location if available
        const ln = job.location_norm || {};
        if (ln.state) {
          return true; // Has US state code
        }
        // Check states array (for multi-location jobs)
        if (ln.states && ln.states.length > 0) {
          return true; // Has US states
        }
        
        // Fallback to text heuristic
        const l = (job.location || "").toLowerCase();
        return (
          l.includes("united states") ||
          l.includes(" usa") ||
          l.includes(" us") ||
          l.includes(", us") ||
          l.includes("remote - us") ||
          l.includes("remote (us)")
        );
      }

      // ---------- MAIN FILTER FUNCTION ----------
      function applyFilters(jobs) {
        const status = document.getElementById("pipelineFilterStatus")?.value || "all";
        let filtered = jobs;

        // 1. Quick Filter (status-based presets)
        if (activeQuickFilter === "new-week") {
          // New jobs only + force 7 days date range
          filtered = filtered.filter(j => {
            const st = (j.application_status || j.status || "new").toLowerCase();
            return st === "new";
          });
          // Override date range to 7 days for "new this week"
          const weekAgo = new Date();
          weekAgo.setDate(weekAgo.getDate() - 7);
          filtered = filtered.filter(j => {
            const jobDate = new Date(j.updated_at || j.first_seen || j.last_seen || 0);
            return jobDate >= weekAgo;
          });
        } else if (activeQuickFilter === "to-apply") {
          filtered = filtered.filter(j => {
            const st = (j.application_status || j.status || "new").toLowerCase();
            return ["new", "selected", "ready"].includes(st);
          });
          // Apply date range filter for "to-apply"
          if (dateRangeDays !== "all") {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(dateRangeDays));
            filtered = filtered.filter(j => {
              const jobDate = new Date(j.updated_at || j.first_seen || j.last_seen || 0);
              return jobDate >= cutoffDate;
            });
          }
        } else if (activeQuickFilter === "applied") {
          filtered = filtered.filter(j => {
            const st = (j.application_status || j.status || "new").toLowerCase();
            return ["applied", "interview", "offer"].includes(st);
          });
          // No date filter for applied - show all
        } else {
          // "all" - apply date range filter
          if (dateRangeDays !== "all") {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(dateRangeDays));
            filtered = filtered.filter(j => {
              const jobDate = new Date(j.updated_at || j.first_seen || j.last_seen || 0);
              return jobDate >= cutoffDate;
            });
          }
        }

        // 3. Location filter by category
        filtered = filtered.filter((job) => {
          const ln = job.location_norm || {};
          const isUS = isUSHeuristic(job);
          const isRemote = ln.remote === true;
          
          switch (locationCategory) {
            case "all": return true;
            case "us": return isUS;
            case "remote": return isRemote;
            case "nonus": return !isUS && !isRemote;
            default: return true;
          }
        });
        debugCounts.afterLocation = filtered.length;

        // 4. States filter (only if states selected)
        const hasStateFilter = selectedStates.length > 0;
        if (hasStateFilter) {
          filtered = filtered.filter((job) => {
            const ln = job.location_norm;
            const isUS = isUSHeuristic(job);
            
            if (!isUS && locationCategory === "nonus") {
              return true;
            }
            
            const remoteScope = ln?.remote_scope?.toLowerCase() || '';
            if (ln?.remote && ['usa', 'us', 'global', ''].includes(remoteScope)) {
              return true;
            }
            
            return matchStatesInJob(ln);
          });
        }
        debugCounts.afterState = filtered.length;

        // 5. Global Search filter
        if (globalSearchText) {
          const search = globalSearchText.toLowerCase();
          filtered = filtered.filter(j => {
            const company = (j.company || "").toLowerCase();
            const title = (j.title || "").toLowerCase();
            const location = (j.location || "").toLowerCase();
            return company.includes(search) || title.includes(search) || location.includes(search);
          });
        }

        // 6. ATS filter (quick)
        const atsQuick = document.getElementById("pipelineFilterAtsQuick")?.value || "";
        if (atsQuick) {
          filtered = filtered.filter(j => atsQuick === "manual" ? j.source === "onboard" : j.ats === atsQuick);
        }

        // 7. Status filter (from old dropdown, keep for compatibility)
        filtered = filtered.filter((job) => {
          if (status === "all") return true;
          const st = job.application_status || job.status || "New";
          return st === status;
        });
        debugCounts.afterStatus = filtered.length;

        // 8. Pipeline column filters (additional inline filters)
        if (pipelineFilters.company) {
          filtered = filtered.filter(j => 
            (j.company || "").toLowerCase().includes(pipelineFilters.company.toLowerCase())
          );
        }
        if (pipelineFilters.title) {
          filtered = filtered.filter(j => 
            (j.title || "").toLowerCase().includes(pipelineFilters.title.toLowerCase())
          );
        }
        if (pipelineFilters.location) {
          filtered = filtered.filter(j => 
            (j.location || "").toLowerCase().includes(pipelineFilters.location.toLowerCase())
          );
        }
        if (pipelineFilters.ats) {
          filtered = filtered.filter(j => pipelineFilters.ats === "manual" ? j.source === "onboard" : j.ats === pipelineFilters.ats);
        }
        if (pipelineFilters.updated) {
          const search = pipelineFilters.updated.toLowerCase();
          filtered = filtered.filter(j => {
            const updated = (j.updated_at || j.first_seen || "").toLowerCase();
            return updated.includes(search);
          });
        }
        if (pipelineFilters.jobId) {
          const searchId = pipelineFilters.jobId.toLowerCase();
          filtered = filtered.filter(j => {
            const atsJobId = (j.ats_job_id || "").toString().toLowerCase();
            const jobId = (j.id || "").toString().toLowerCase();
            return atsJobId.includes(searchId) || jobId.includes(searchId);
          });
        }
        
        // Filter by folder
        if (pipelineFilters.folder === "yes") {
          filtered = filtered.filter(j => j.folder_path);
        } else if (pipelineFilters.folder === "no") {
          filtered = filtered.filter(j => !j.folder_path);
        }

        return filtered;
      }

      function computeGeoSummary(jobs) {
        let nc = 0;
        let neighbor = 0;
        let remote = 0;

        for (const j of jobs) {
          const ln = j.location_norm || {};
          const st = (ln.state || "").toUpperCase();
          if (isRemoteUSA(ln)) {
            remote += 1;
            continue;
          }
          if (st === "NC") {
            nc += 1;
            continue;
          }
          if (["VA", "SC", "GA", "TN"].includes(st)) {
            neighbor += 1;
            continue;
          }
        }
        return { nc, neighbor, remote };
      }

      function updateStatus(latestFilteredJobs = null) {
        const statusPipeline = document.getElementById("statusPipeline");
        const statusGeo = document.getElementById("statusGeo");

        // Pipeline visualization - simplified: Total | My Roles | Shown
        if (CACHED_STATS || LAST_LOADED_AT || ALL_JOBS_RAW.length > 0) {
          // Total from cache (all parsed jobs)
          const totalRaw = CACHED_STATS?.total || ALL_JOBS_RAW.length;
          // My Roles from jobs.json (already filtered by role)
          const myRolesCount = ALL_JOBS.length;
          // Shown after location/search filters
          const shownCount = latestFilteredJobs ? latestFilteredJobs.length : ALL_JOBS.length;
          
          statusPipeline.innerHTML = `
            <span class="pipe-item">Total: ${totalRaw}</span>
            <span class="pipe-arrow">‚Üí</span>
            <span class="pipe-item">My Roles: ${myRolesCount}</span>
            <span class="pipe-arrow">‚Üí</span>
            <span class="pipe-item active">Shown: ${shownCount}</span>
          `;
        } else {
          statusPipeline.innerHTML = '<span class="pipe-item">Not loaded</span>';
        }

        // Geo badges
        if (LAST_LOADED_AT && Array.isArray(latestFilteredJobs)) {
          const g = computeGeoSummary(latestFilteredJobs);
          statusGeo.innerHTML = `
            <span class="geo-badge nc"><span class="geo-count">${g.nc}</span> NC</span>
            <span class="geo-badge neighbor"><span class="geo-count">${g.neighbor}</span> Neighbor</span>
            <span class="geo-badge remote"><span class="geo-count">${g.remote}</span> Remote</span>
          `;
        } else {
          statusGeo.innerHTML = '';
        }
      }

      async function persistStatus(jobId, status) {
        try {
          const res = await fetch("/pipeline/status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ job_id: jobId, status: status }),
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          return data.ok;
        } catch (e) {
          console.error(e);
          alert("Failed to save status. Check server logs.");
          return false;
        }
      }

      function renderJobs(jobs) {
        // Store filtered jobs for pagination
        pipelineFilteredJobs = jobs;
        
        // Calculate pagination
        const totalJobs = jobs.length;
        const totalPages = Math.ceil(totalJobs / pipelinePageSize) || 1;
        
        // Ensure current page is valid
        if (pipelinePage > totalPages) pipelinePage = totalPages;
        if (pipelinePage < 1) pipelinePage = 1;
        
        const startIdx = (pipelinePage - 1) * pipelinePageSize;
        const endIdx = Math.min(startIdx + pipelinePageSize, totalJobs);
        const pageJobs = jobs.slice(startIdx, endIdx);
        
        // Update pagination UI
        document.getElementById("paginationStart").textContent = totalJobs > 0 ? startIdx + 1 : 0;
        document.getElementById("paginationEnd").textContent = endIdx;
        document.getElementById("paginationTotal").textContent = totalJobs;
        document.getElementById("paginationCurrent").textContent = pipelinePage;
        document.getElementById("paginationPages").textContent = totalPages;
        
        document.getElementById("paginationPrev").disabled = pipelinePage <= 1;
        document.getElementById("paginationNext").disabled = pipelinePage >= totalPages;
        
        const tbody = document.querySelector("#jobsTable tbody");
        tbody.innerHTML = "";

        for (const job of pageJobs) {
          const row = document.createElement("tr");
          const url = job.job_url || job.url || "#";
          const jobKey = job.job_key || url || "";

          const st = job.application_status || "New";
          
          // Get tags for industry column
          const tags = job.company_data?.tags || [];
          const tagsStr = tags.join(", ");

          // dataset for sorting (case-insensitive)
          // Ensure updated_at is a string (could be Date object or dict)
          const updatedAtRaw = typeof job.updated_at === 'string' 
            ? job.updated_at 
            : (job.updated_at ? String(job.updated_at) : "");
          
          // Format date for display (Dec 19, 3d ago)
          const updatedAtStr = formatDateWithAge(updatedAtRaw);
          
          row.dataset.company = (job.company || "").trim();
          row.dataset.industry = tagsStr;
          row.dataset.title = (job.title || "").trim();
          row.dataset.location = (job.location || "").trim();
          row.dataset.updated = updatedAtRaw.trim(); // Use raw ISO for sorting
          row.dataset.ats = job.source === "onboard" ? "manual" : (job.ats || "").trim();
          row.dataset.status = (st || "New").trim();
          row.dataset.jobId = job.id || "";
          row.dataset.atsJobId = job.ats_job_id || "";
          row.dataset.url = url;

          // Determine role category for showing Add to Pipeline button
          const roleCategory = job.role_category || (job.role_excluded ? 'excluded' : (job.role_id ? 'primary' : 'unknown'));
          const showAddButton = ['unknown', 'excluded'].includes(roleCategory);
          const inPipeline = job.in_pipeline || job.status; // Job is already in pipeline if has status
          const isManual = job.source === 'manual';
          const isOnboarded = job.source === 'onboard' || job.source === 'manual_onboard';
          const sourceIcon = isOnboarded ? '<span title="User added via onboarding" style="margin-left: 4px;">üìå</span>' : '';
          
          row.innerHTML = `
        <td style="font-size: 10px; font-family: monospace; color: var(--muted); cursor: pointer;" title="Click to copy: ${escapeAttr(job.ats_job_id || job.id || '')}" onclick="navigator.clipboard.writeText('${escapeAttr(job.ats_job_id || job.id || '')}'); this.style.color='#22c55e'; setTimeout(() => this.style.color='var(--muted)', 500);">${escapeHtml((job.ats_job_id || job.id || '').toString().slice(-8))}</td>
        <td style="text-align: center;">
          <input type="checkbox" class="jobCheckbox" data-jobkey="${escapeAttr(jobKey)}" data-url="${escapeAttr(url)}" data-company="${escapeAttr(job.company || '')}" data-title="${escapeAttr(job.title || '')}" data-ats="${escapeAttr(job.ats || '')}" data-status="${escapeAttr(st)}">
        </td>
        <td>${escapeHtml(job.company || "")}</td>
        <td><a href="${escapeAttr(
          url
        )}" target="_blank" rel="noopener">${escapeHtml(
            job.title || ""
          )}</a>${sourceIcon}</td>
        <td>${escapeHtml(job.location || "")}</td>
        <td>${escapeHtml(updatedAtStr)}</td>
        <td>${job.source === "onboard" ? "üìå manual" : escapeHtml(job.ats || "")}</td>
        <td>
          <select class="statusSelect" data-jobkey="${escapeAttr(jobKey)}">
            ${["New", "Selected", "Ready", "Applied", "Interview", "Offer", "Rejected", "Withdrawn", "Closed"]
              .map(
                (x) => {
                  const icons = {
                    "New": "‚ö™",
                    "Selected": "üìã",
                    "Ready": "‚úÖ",
                    "Applied": "üì§",
                    "Interview": "üéØ",
                    "Offer": "üéâ",
                    "Rejected": "‚ùå",
                    "Withdrawn": "üîô",
                    "Closed": "üîí"
                  };
                  return `<option value="${x}" ${x === st ? "selected" : ""}>${icons[x] || ""} ${x}</option>`;
                }
              )
              .join("")}
          </select>
        </td>
        <td style="text-align: center; padding: 2px;">
          ${job.folder_path ? `<button class="openFolderBtn" data-folder="${escapeAttr(job.folder_path)}" title="Open documents folder" style="background:none; border:none; cursor:pointer; font-size:16px;">üìÅ</button>` : ''}
        </td>
        <td>
          ${st === 'Selected'
            ? `<button class="prepareBtn" data-jobkey="${escapeAttr(jobKey)}" data-company="${escapeAttr(job.company || '')}" data-position="${escapeAttr(job.title || '')}" data-joburl="${escapeAttr(url)}" title="Prepare CV & Cover Letter" style="background:#b45309; color:white; border:none; border-radius:4px; padding:2px 8px; cursor:pointer; font-size:12px;">üì¶ Prepare</button>`
            : ''}
          ${showAddButton && !inPipeline 
            ? `<button class="addToPipelineBtn" data-jobid="${escapeAttr(job.id || '')}" title="Add to Pipeline">‚ûï</button>`
            : ''}
          ${isManual
            ? `<button class="removeFromPipelineBtn" data-jobid="${escapeAttr(job.id || '')}" title="Remove from Pipeline" style="background: #5a2a2a; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px;">‚úñ</button>`
            : ''}
        </td>
      `;
          tbody.appendChild(row);

          const sel = row.querySelector("select.statusSelect");
          sel.addEventListener("change", async (e) => {
            const newStatus = e.target.value;
            const jobId = job.id;  // Use job.id for Pipeline
            const oldStatus = st;

            // optimistic update
            job.application_status = newStatus;
            job.status = newStatus;  // Pipeline uses 'status' field
            row.dataset.status = newStatus;

            const ok = await persistStatus(jobId, newStatus);  // Keep original case
            if (!ok) {
              // revert
              e.target.value = oldStatus;
              job.application_status = oldStatus;
              job.status = oldStatus;
              row.dataset.status = oldStatus;
            } else {
              // Update status in ALL_JOBS arrays too
              const updateJobInArray = (arr, id, status) => {
                const found = arr.find(j => j.id === id);
                if (found) {
                  found.status = status;
                  found.application_status = status;
                }
              };
              updateJobInArray(ALL_JOBS, jobId, newStatus);
              updateJobInArray(ALL_JOBS_RAW, jobId, newStatus);
              
              // Refresh to show/hide buttons based on new status
              const filtered = applyFilters(ALL_JOBS);
              renderJobs(filtered);
            }
          });
          
          // Add to Pipeline button handler
          const addBtn = row.querySelector(".addToPipelineBtn");
          if (addBtn) {
            addBtn.addEventListener("click", async (e) => {
              const jobId = e.target.dataset.jobid;
              if (!jobId) return;
              
              try {
                const res = await fetch("/pipeline/add", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ job: job })
                });
                
                if (res.ok) {
                  // Mark as added
                  job.in_pipeline = true;
                  job.status = "New";
                  e.target.remove(); // Remove button
                  alert(`Added "${job.title}" to Pipeline`);
                } else {
                  alert("Failed to add to pipeline");
                }
              } catch (err) {
                console.error("Add to pipeline error:", err);
                alert("Error adding to pipeline");
              }
            });
          }
          
          // Remove from Pipeline button handler (for manual jobs)
          const removeBtn = row.querySelector(".removeFromPipelineBtn");
          if (removeBtn) {
            removeBtn.addEventListener("click", async (e) => {
              const jobId = e.target.dataset.jobid;
              if (!jobId) return;
              
              if (!confirm(`Remove "${job.title}" from Pipeline?`)) return;
              
              try {
                const res = await fetch(`/pipeline/remove/${jobId}`, {
                  method: "DELETE"
                });
                
                if (res.ok) {
                  // Remove row from table
                  row.remove();
                  // Update ALL_JOBS
                  const idx = ALL_JOBS.findIndex(j => j.id === jobId);
                  if (idx >= 0) ALL_JOBS.splice(idx, 1);
                  // Also from ALL_JOBS_RAW
                  const idxRaw = ALL_JOBS_RAW.findIndex(j => j.id === jobId);
                  if (idxRaw >= 0) ALL_JOBS_RAW.splice(idxRaw, 1);
                } else {
                  alert("Failed to remove from pipeline");
                }
              } catch (err) {
                console.error("Remove from pipeline error:", err);
                alert("Error removing from pipeline");
              }
            });
          }
          
          // Cover Letter button handler
          const clBtn = row.querySelector(".coverLetterBtn");
          if (clBtn) {
            clBtn.addEventListener("click", async (e) => {
              const company = e.target.dataset.company;
              const position = e.target.dataset.position;
              const jobUrl = e.target.dataset.joburl;
              
              document.getElementById('clCompany').value = company || '';
              document.getElementById('clPosition').value = position || '';
              document.getElementById('clDescription').value = '';
              document.getElementById('clResult').style.display = 'none';
              document.getElementById('clSaveStatus').textContent = '';
              document.getElementById('coverLetterModal').style.display = 'flex';
              
              // Auto-fetch job description if URL available
              if (jobUrl) {
                document.getElementById('clDescription').value = '‚è≥ Loading job description...';
                document.getElementById('clDescription').disabled = true;
                
                try {
                  const res = await fetch('/fetch-job-description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: jobUrl })
                  });
                  const data = await res.json();
                  
                  if (data.ok && data.description) {
                    document.getElementById('clDescription').value = data.description;
                  } else {
                    document.getElementById('clDescription').value = '';
                    document.getElementById('clDescription').placeholder = 'Could not fetch JD. Paste manually if needed.';
                  }
                } catch (err) {
                  document.getElementById('clDescription').value = '';
                  console.error('Failed to fetch JD:', err);
                } finally {
                  document.getElementById('clDescription').disabled = false;
                }
              }
            });
          }
          
          // Prepare button handler (Selected status)
          const prepareBtn = row.querySelector(".prepareBtn");
          if (prepareBtn) {
            prepareBtn.addEventListener("click", async (e) => {
              const jobKey = e.target.dataset.jobkey;
              const company = e.target.dataset.company;
              const position = e.target.dataset.position;
              const jobUrl = e.target.dataset.joburl;
              const roleFamily = job.role_family || 'product';
              
              e.target.disabled = true;
              e.target.textContent = "‚è≥ Preparing...";
              
              try {
                // 1. Fetch JD
                let jd = '';
                if (jobUrl) {
                  const jdRes = await fetch('/fetch-job-description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: jobUrl })
                  });
                  const jdData = await jdRes.json();
                  if (jdData.ok) jd = jdData.description;
                }
                
                // 2. Select CV
                const cvRes = await fetch('/select-cv', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ job_title: position })
                });
                const cvData = await cvRes.json();
                const cvFilename = cvData.filename || '';
                
                // 3. Generate Cover Letter (from template + AI mission)
                const clRes = await fetch('/generate-cover-letter', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ 
                    company, 
                    position, 
                    job_description: jd,
                    role_family: roleFamily
                  })
                });
                const clData = await clRes.json();
                
                // 4. Copy CV to application folder
                if (cvFilename) {
                  await fetch('/save-cover-letter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company, position, cv_filename: cvFilename })
                  });
                }
                
                // 5. Update status to Ready with folder path
                const folderPath = clData.folder_path || '';
                await fetch('/pipeline/status', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ job_id: jobKey, status: 'Ready', folder_path: folderPath })
                });
                showPrepareResult(company, position, cvFilename, clData);
                
                // Update local job status and refresh
                job.status = 'Ready';
                job.folder_path = clData.folder_path || '';
                job.application_status = 'Ready';
                const filtered = applyFilters(ALL_JOBS);
                renderJobs(filtered);
                
              } catch (err) {
                console.error('Prepare error:', err);
                alert('Error preparing application: ' + err.message);
                e.target.disabled = false;
                e.target.textContent = 'üì¶ Prepare';
              }
            });
          }
          

          // Open folder button handler
          const openFolderBtn = row.querySelector(".openFolderBtn");
          if (openFolderBtn) {
            openFolderBtn.addEventListener("click", async (e) => {
              const folderPath = e.target.dataset.folder;
              if (folderPath) {
                try {
                  await fetch("/open-folder", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ path: folderPath })
                  });
                } catch (err) {
                  console.error("Failed to open folder:", err);
                }
              }
            });
          }

          // Apply button handler - Now with JD Analysis first
          const applyBtn = row.querySelector(".applyBtn");
          if (applyBtn) {
            applyBtn.addEventListener("click", async (e) => {
              const jobUrl = e.target.dataset.joburl;
              const jobTitle = e.target.dataset.jobtitle;
              const company = job.company || '';
              const roleFamily = job.role_family || 'product';
              
              if (!jobUrl) return;
              
              e.target.disabled = true;
              e.target.textContent = "üîç Checking...";
              
              try {
                // 1. Check existing files FIRST (fast!)
                const checkRes = await fetch('/check-existing-application', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ job_title: jobTitle, company: company })
                });
                const existingData = await checkRes.json();
                
                e.target.textContent = "üìù Apply";
                e.target.disabled = false;
                
                if (existingData.exists) {
                  // Show modal with existing files immediately
                  showPrepareModalWithExisting(company, jobTitle, jobUrl, roleFamily, job, existingData);
                  return;
                }
                
                // 2. No existing files - need to fetch JD
                e.target.disabled = true;
                e.target.textContent = "üîç Loading JD...";
                
                let jd = '';
                const jdRes = await fetch('/fetch-job-description', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ url: jobUrl })
                });
                const jdData = await jdRes.json();
                if (jdData.ok) jd = jdData.description || '';
                
                e.target.textContent = "üìù Apply";
                e.target.disabled = false;
                
                // 3. Show modal for new application
                showPrepareModalNew(company, jobTitle, jobUrl, jd, roleFamily, job);
                
              } catch (err) {
                console.error("Error:", err);
                alert("Error: " + err.message);
                e.target.textContent = "üìù Apply";
                e.target.disabled = false;
              }
            });
          }
        }

        updateStatus(jobs);
        applyCurrentSortIfAny();
      }

      function escapeHtml(s) {
        return (s || "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      function escapeAttr(s) {
        return (s || "").replace(/"/g, "&quot;");
      }

      // ---------- REVIEW TAB FUNCTIONS ----------
      let reviewPage = 1;
      let reviewTotalPages = 1;
      let reviewTotal = 0;
      const REVIEW_PAGE_SIZE = 100;
      let reviewSort = { col: null, dir: 'asc' };
      let reviewSelectedJobs = new Map(); // jobId -> job object
      let currentReviewJobs = []; // Current page jobs for reference
      
      async function loadReviewJobs(page = 1) {
        console.log("loadReviewJobs called, page:", page);
        const statusEl = document.getElementById("reviewStatus");
        statusEl.textContent = "Loading...";
        
        const category = document.getElementById("reviewCategoryFilter").value;
        const search = document.getElementById("reviewSearchFilter").value || "";
        
        try {
          const url = `/jobs/review?category=${encodeURIComponent(category)}&search=${encodeURIComponent(search)}&page=${page}&limit=${REVIEW_PAGE_SIZE}`;
          console.log("Fetching:", url);
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          
          const data = await res.json();
          console.log("Review data:", data.jobs?.length, "jobs, total:", data.total);
          
          if (data.error) {
            statusEl.textContent = data.error;
            return;
          }
          
          reviewPage = data.page;
          reviewTotalPages = data.total_pages;
          reviewTotal = data.total;
          currentReviewJobs = data.jobs;
          
          // Apply client-side sort if active
          if (reviewSort.col) {
            sortReviewJobsLocally();
          } else {
            renderReviewJobs(currentReviewJobs);
          }
          updateReviewPagination(data);
          
        } catch (err) {
          console.error("Failed to load review jobs:", err);
          statusEl.textContent = "Error loading jobs";
        }
      }
      
      function sortReviewJobsLocally() {
        const col = reviewSort.col;
        const dir = reviewSort.dir;
        
        const sorted = [...currentReviewJobs].sort((a, b) => {
          let valA = (a[col] || '').toLowerCase();
          let valB = (b[col] || '').toLowerCase();
          
          if (valA < valB) return dir === 'asc' ? -1 : 1;
          if (valA > valB) return dir === 'asc' ? 1 : -1;
          return 0;
        });
        
        renderReviewJobs(sorted);
      }
      
      function renderReviewJobs(jobs) {
        console.log("renderReviewJobs called, jobs:", jobs?.length);
        const tbody = document.querySelector("#reviewTable tbody");
        console.log("tbody found:", tbody);
        if (!tbody) {
          console.error("tbody not found!");
          return;
        }
        tbody.innerHTML = "";
        
        // Update select all checkbox
        document.getElementById("reviewSelectAll").checked = false;
        
        for (const job of jobs) {
          const row = document.createElement("tr");
          const url = job.job_url || job.url || "#";
          const reason = job.role_reason || job.role_exclude_reason || "No match";
          const isSelected = reviewSelectedJobs.has(job.id);
          const inPipeline = job.in_pipeline;
          
          // Grey out row if already in pipeline
          if (inPipeline) {
            row.style.opacity = "0.5";
          }
          
          row.innerHTML = `
            <td><input type="checkbox" class="reviewJobCheck" data-jobid="${escapeAttr(job.id || '')}" ${isSelected ? 'checked' : ''} ${inPipeline ? 'disabled' : ''}></td>
            <td>${escapeHtml(job.company || "")}</td>
            <td><a href="${escapeAttr(url)}" target="_blank" rel="noopener">${escapeHtml(job.title || "")}</a></td>
            <td>${escapeHtml(job.location || "")}</td>
            <td class="muted" style="font-size: 11px;">${escapeHtml(reason)}</td>
            <td>${inPipeline ? '<span style="color: #4a9;">‚úÖ Added</span>' : ''}</td>
          `;
          tbody.appendChild(row);
          
          // Checkbox handler (only for non-pipeline jobs)
          if (!inPipeline) {
            const checkbox = row.querySelector(".reviewJobCheck");
            checkbox.addEventListener("change", (e) => {
              if (e.target.checked) {
                reviewSelectedJobs.set(job.id, job);
              } else {
                reviewSelectedJobs.delete(job.id);
              }
              updateAddSelectedButton();
            });
          }
        }
      }
      
      function updateAddSelectedButton() {
        const btn = document.getElementById("addSelectedBtn");
        const count = reviewSelectedJobs.size;
        btn.textContent = `‚ûï Add Selected (${count})`;
        btn.disabled = count === 0;
      }
      
      function updateReviewPagination(data) {
        const statusEl = document.getElementById("reviewStatus");
        const start = (data.page - 1) * data.limit + 1;
        const end = Math.min(data.page * data.limit, data.total);
        
        statusEl.innerHTML = `
          Showing ${start}-${end} of ${data.total} jobs
          &nbsp;&nbsp;
          <button class="ghost" ${!data.has_prev ? 'disabled' : ''} onclick="loadReviewJobs(${data.page - 1})">‚óÄ Prev</button>
          &nbsp; Page ${data.page} of ${data.total_pages} &nbsp;
          <button class="ghost" ${!data.has_next ? 'disabled' : ''} onclick="loadReviewJobs(${data.page + 1})">Next ‚ñ∂</button>
        `;
      }
      
      async function addSelectedToPipeline() {
        if (reviewSelectedJobs.size === 0) return;
        
        const btn = document.getElementById("addSelectedBtn");
        btn.disabled = true;
        btn.textContent = "Adding...";
        
        let successCount = 0;
        let errorCount = 0;
        
        for (const [jobId, job] of reviewSelectedJobs) {
          try {
            const res = await fetch("/pipeline/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ job: job })
            });
            
            if (res.ok) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (err) {
            errorCount++;
          }
        }
        
        // Clear selection and refresh
        reviewSelectedJobs.clear();
        updateAddSelectedButton();
        
        alert(`Added ${successCount} jobs to Pipeline` + (errorCount > 0 ? `, ${errorCount} errors` : ''));
        
        // Reload current page
        loadReviewJobs(reviewPage);
      }

      // ---------- LOADING ----------
      async function loadJobsOnce() {
        setLoading(true, "Loading‚Ä¶");
        try {
          // Always load ALL jobs, filter locally by profile/ats
          const url = `/jobs?profile=all&ats_filter=all&role_filter=all&location_filter=all`;

          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          ALL_JOBS = enrichJobsLocationNorm(data.jobs || []);
          LAST_LOADED_AT = new Date().toLocaleString();

          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);

          setLoading(false, "Loaded");
        } catch (e) {
          console.error(e);
          ALL_JOBS = [];
          LAST_LOADED_AT = null;
          renderJobs([]);
          setLoading(false, "Error");
          alert(
            "Failed to load jobs. Check terminal logs (uvicorn) and /jobs endpoint."
          );
        }
      }

      // Show/hide stale data warning
      function updateStaleWarning() {
        const warning = document.getElementById("staleWarning");
        const ageSpan = document.getElementById("staleAge");
        
        if (CACHED_STATS && CACHED_STATS.is_stale) {
          ageSpan.textContent = Math.round(CACHED_STATS.age_hours);
          warning.style.display = "block";
        } else {
          warning.style.display = "none";
        }
      }

      // Daemon status polling
      let refreshLogVisible = false;
      
      function toggleRefreshLog() {
        const panel = document.getElementById("refreshLogPanel");
        refreshLogVisible = !refreshLogVisible;
        panel.style.display = refreshLogVisible ? "block" : "none";
        if (refreshLogVisible) {
          updateRefreshLog();
        }
      }
      
      function updateRefreshLog() {
        // Will be populated by updateDaemonStatus
      }
      
      function renderRefreshLog(log, total, current) {
        const list = document.getElementById("refreshLogList");
        const summary = document.getElementById("refreshLogSummary");
        
        if (!list) return;
        
        summary.textContent = `${log.length}/${total} companies`;
        
        if (log.length === 0) {
          list.innerHTML = '<div style="padding: 12px; color: var(--muted); text-align: center;">Waiting for refresh to start...</div>';
          return;
        }
        
        // Show current company being processed at top if any
        let html = '';
        if (current) {
          html += `<div style="padding: 6px 12px; background: rgba(245, 158, 11, 0.2); border-left: 3px solid #f59e0b;">
            üîÑ <strong>${current}</strong> ‚Äî processing...
          </div>`;
        }
        
        // Show log entries in reverse order (newest first)
        const reversedLog = [...log].reverse();
        for (const entry of reversedLog) {
          const icon = entry.ok ? '‚úÖ' : '‚ùå';
          const jobsText = entry.ok ? `${entry.jobs} jobs` : entry.error || 'error';
          const addedText = entry.jobs_added > 0 ? ` <span style="color: #22c55e;">(+${entry.jobs_added} new)</span>` : '';
          const atsColor = getAtsColor(entry.ats);
          
          html += `<div style="padding: 4px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px;">
            <span style="width: 20px;">${icon}</span>
            <span style="min-width: 35px; color: var(--muted);">${entry.index}/${entry.total}</span>
            <span style="min-width: 120px; font-weight: 500;">${entry.company}</span>
            <span style="padding: 1px 6px; border-radius: 3px; font-size: 10px; background: ${atsColor};">${entry.ats}</span>
            <span style="color: ${entry.ok ? 'var(--text)' : '#ef4444'};">${jobsText}${addedText}</span>
          </div>`;
        }
        
        list.innerHTML = html;
      }
      
      function getAtsColor(ats) {
        const colors = {
          'greenhouse': 'rgba(34, 197, 94, 0.3)',
          'lever': 'rgba(59, 130, 246, 0.3)',
          'workday': 'rgba(249, 115, 22, 0.3)',
          'ashby': 'rgba(168, 85, 247, 0.3)',
          'smartrecruiters': 'rgba(236, 72, 153, 0.3)'
        };
        return colors[ats] || 'rgba(255,255,255,0.1)';
      }
      
      async function updateDaemonStatus() {
        const indicator = document.getElementById("daemonIndicator");
        const text = document.getElementById("daemonText");
        
        try {
          const res = await fetch("/daemon/status");
          const status = await res.json();
          
          if (status.running) {
            if (status.current_company) {
              // Currently parsing
              indicator.style.background = "#f59e0b";  // amber - working
              const progress = `${status.companies_refreshed_this_cycle || status.current_index + 1}/${status.companies_in_cycle}`;
              const newJobs = status.jobs_added_this_cycle > 0 ? ` | +${status.jobs_added_this_cycle} new` : '';
              text.textContent = `üîÑ Refreshing: ${status.current_company} (${progress})${newJobs}`;
            } else if (status.last_company) {
              // Idle between batches
              indicator.style.background = "#22c55e";  // green - active
              const ago = status.last_updated ? formatTimeAgo(status.last_updated) : '';
              const newJobs = status.jobs_added_this_cycle > 0 ? ` | +${status.jobs_added_this_cycle} new` : '';
              const progress = `${status.companies_refreshed_this_cycle}/${status.companies_in_cycle}`;
              text.textContent = `‚úÖ Cycle ${status.cycle_count}: ${progress} ${ago}${newJobs}`;
            } else {
              indicator.style.background = "#22c55e";
              text.textContent = `‚úÖ Auto-refresh ON | Starting...`;
            }
          } else if (status.enabled) {
            indicator.style.background = "#3b82f6";  // blue - waiting
            text.textContent = `‚è≥ Auto-refresh: Starting...`;
          } else {
            indicator.style.background = "#6b7280";  // gray - disabled
            // Show if locked by another machine
            if (status.locked_by) {
              text.textContent = `üîí Daemon locked by: ${status.locked_by}`;
              indicator.style.background = "#f59e0b";  // amber - locked by other
            } else {
              text.textContent = `‚è∏Ô∏è Auto-refresh: OFF`;
            }
          }
          
          // Update refresh log if visible
          if (refreshLogVisible && status.refresh_log) {
            renderRefreshLog(status.refresh_log, status.companies_in_cycle, status.current_company);
          }
        } catch (e) {
          indicator.style.background = "#ef4444";  // red - error
          text.textContent = `‚ùå Auto-refresh: Error`;
        }
      }
      
      function formatTimeAgo(isoDate) {
        if (!isoDate) return '';
        try {
          const date = new Date(isoDate);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          
          if (diffMins < 1) return '(just now)';
          if (diffMins < 60) return `(${diffMins}m ago)`;
          const diffHours = Math.floor(diffMins / 60);
          return `(${diffHours}h ago)`;
        } catch (e) {
          return '';
        }
      }
      
      // Poll daemon status every 5 seconds
      setInterval(updateDaemonStatus, 5000);
      updateDaemonStatus();  // Initial call

      // Fast load: stats + pipeline jobs only
      async function loadJobsFromCache(forceReload = false) {
        // Don't load if jobs already loaded (unless force)
        if (!forceReload && ALL_JOBS_RAW.length > 0) {
          console.log("loadJobsFromCache skipped - jobs already loaded");
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
          return;
        }
        
        console.log("loadJobsFromCache started");
        setLoading(true, "Loading‚Ä¶");
        try {
          // 1. Load funnel stats (tiny ~100 bytes)
          const statsRes = await fetch("/stats");
          if (statsRes.ok) {
            CACHED_STATS = await statsRes.json();
            console.log("Stats loaded:", CACHED_STATS);
            updateStaleWarning();
          }
          
          // 2. Load Pipeline jobs only (not full cache)
          const res = await fetch("/pipeline/all");
          console.log("fetch done, status:", res.status);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          console.log("got pipeline jobs:", data.count);
          
          // Debug: check for manual jobs
          const manualJobs = (data.jobs || []).filter(j => j.source === 'onboard');
          console.log("manual (onboard) jobs:", manualJobs.length, manualJobs.map(j => j.company));
          
          // Store pipeline jobs
          ALL_JOBS_RAW = enrichJobsLocationNorm(data.jobs || []);
          ALL_JOBS = myRolesEnabled ? filterRelevantRoles(ALL_JOBS_RAW) : ALL_JOBS_RAW;
          LAST_LOADED_AT = new Date().toLocaleString();

          const filtered = applyFilters(ALL_JOBS);
          console.log("filtered jobs:", filtered.length);
          renderJobs(filtered);
          updateStatus(filtered);  // Update header stats

          setLoading(false, "Loaded");
          console.log("loadJobsFromCache done");
        } catch (e) {
          console.error("loadJobsFromCache error:", e);
          setLoading(false, "Error");
        }
      }

      function setLoading(isLoading, text) {
        const dot = document.getElementById("loadDot");
        const label = document.getElementById("loadText");

        label.textContent = text;

        dot.classList.remove("ok", "bad");
        if (isLoading) dot.classList.add("bad");
        if (!isLoading && (text === "Loaded" || text === "Updated")) dot.classList.add("ok");
        if (!isLoading && text === "Error") dot.classList.add("bad");
      }

      // ---------- MULTI-SELECT UI ----------
      function syncStateButton() {
        const text = document.getElementById("stateBtnText");
        const cnt = document.getElementById("stateBtnCount");
        cnt.textContent = String(selectedStates.length);
        if (selectedStates.length === 0) {
          text.textContent = "Select states‚Ä¶";
        } else if (selectedStates.length <= 3) {
          text.textContent = selectedStates.join(", ");
        } else {
          text.textContent =
            selectedStates.slice(0, 3).join(", ") +
            ` +${selectedStates.length - 3}`;
        }
      }

      function renderStateList(filterText = "") {
        const list = document.getElementById("stateList");
        list.innerHTML = "";

        const q = (filterText || "").trim().toLowerCase();

        const items = US_STATES.filter((st) => {
          if (!q) return true;
          return (
            st.code.toLowerCase().includes(q) ||
            st.name.toLowerCase().includes(q)
          );
        });

        for (const st of items) {
          const div = document.createElement("div");
          div.className = "msItem";
          const checked = selectedStates.includes(st.code);
          const checkId = `state-${st.code}`;
          div.innerHTML = `
        <input type="checkbox" id="${checkId}" ${checked ? "checked" : ""} />
        <label for="${checkId}">${st.code} ‚Äî ${st.name}</label>
      `;
          div.addEventListener("click", (ev) => {
            ev.preventDefault();

            const key = st.code;

            if (selectedStates.includes(key)) {
              selectedStates = selectedStates.filter((x) => x !== key);
            } else {
              selectedStates.push(key);
            }

            syncStateButton();
            renderStateList(document.getElementById("stateSearch").value);

            if (ALL_JOBS.length > 0) {
              const filtered = applyFilters(ALL_JOBS);
              renderJobs(filtered);
            }
          });
          list.appendChild(div);
        }
      }

      function openStateMenu() {
        document.getElementById("stateMultiSelect").classList.add("open");
        renderStateList(document.getElementById("stateSearch").value);
      }
      function closeStateMenu() {
        document.getElementById("stateMultiSelect").classList.remove("open");
      }

      // ---------- EVENTS ----------

      const filterIds = [
        "pipelineFilterStatus",
      ];
      for (const id of filterIds) {
        const el = document.getElementById(id);
        if (!el) continue;
        el.addEventListener("change", () => {
          // All filters now apply locally (no server reload)
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          } else {
            updateStatus();
          }
        });
        el.addEventListener("input", () => {
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          }
        });
      }

      document
        .getElementById("locationCategoryFilter")
        .addEventListener("change", (e) => {
          locationCategory = e.target.value;
          if (ALL_JOBS.length > 0) {
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          }
        });

      // Multi-select open/close
      document.getElementById("stateBtn").addEventListener("click", () => {
        const ms = document.getElementById("stateMultiSelect");
        if (ms.classList.contains("open")) closeStateMenu();
        else openStateMenu();
      });
      document
        .getElementById("stateClose")
        .addEventListener("click", closeStateMenu);
      document.getElementById("stateClear").addEventListener("click", () => {
        selectedStates = [];
        syncStateButton();
        renderStateList(document.getElementById("stateSearch").value);
        if (ALL_JOBS.length > 0) {
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
        }
      });
      document.getElementById("stateSearch").addEventListener("input", (e) => {
        renderStateList(e.target.value);
      });

      document.addEventListener("click", (e) => {
        const ms = document.getElementById("stateMultiSelect");
        if (!ms.contains(e.target)) {
          closeStateMenu();
        }
      });

      // Init defaults
      document.getElementById("locationCategoryFilter").value = locationCategory;
      
      

      syncStateButton();
      renderStateList("");
      updateStatus();
      updateSortIcons();

      // ========== TABS & COMPANIES ==========
      
      let COMPANIES_DATA = [];
      let companiesSortCol = "jobs_count";
      let companiesSortDir = "desc";
      
      // Company column filters state
      let companyFilters = {
        company: "",
        industry: "",
        ats: "",
        jobsMin: 0,
        status: ""
      };
      
      // Pipeline column filters state
      let pipelineFilters = {
        company: "",
        industry: "",
        title: "",
        location: "",
        ats: "",
        jobId: "",
        updated: "",
        folder: "all"
      };
      
      // Review column filters state
      let reviewFilters = {
        company: "",
        title: "",
        location: ""
      };
      
      function filterCompanies(companies) {
        return companies.filter(c => {
          // Company name filter
          if (companyFilters.company && !c.company.toLowerCase().includes(companyFilters.company.toLowerCase())) {
            return false;
          }
          
          // Industry/tags filter
          if (companyFilters.industry) {
            const tags = (c.tags || []).join(" ").toLowerCase() + " " + (c.industry || "").toLowerCase();
            if (!tags.includes(companyFilters.industry.toLowerCase())) {
              return false;
            }
          }
          
          // ATS filter
          if (companyFilters.ats && c.ats !== companyFilters.ats) {
            return false;
          }
          
          // Jobs min filter
          if (companyFilters.jobsMin > 0 && (c.jobs_count || 0) < companyFilters.jobsMin) {
            return false;
          }
          
          // Status filter
          if (companyFilters.status) {
            if (companyFilters.status === "ok" && c.last_ok !== true) return false;
            if (companyFilters.status === "error" && c.last_ok !== false) return false;
            if (companyFilters.status === "disabled" && c.last_ok !== "disabled") return false;
          }
          
          return true;
        });
      }
      
      function applyCompanyFilters() {
        const filtered = filterCompanies(COMPANIES_DATA);
        renderCompanies(filtered);
      }
      
      // ---------- REVIEW TAB EVENT LISTENERS ----------
      document.getElementById("reviewCategoryFilter").addEventListener("change", () => {
        reviewSelectedJobs.clear();
        updateAddSelectedButton();
        loadReviewJobs(1); // Reset to page 1 on filter change
      });
      
      // Debounce search input
      let reviewSearchTimeout;
      document.getElementById("reviewSearchFilter").addEventListener("input", () => {
        clearTimeout(reviewSearchTimeout);
        reviewSearchTimeout = setTimeout(() => {
          reviewSelectedJobs.clear();
          updateAddSelectedButton();
          loadReviewJobs(1); // Reset to page 1 on search
        }, 300); // Wait 300ms after typing stops
      });
      
      // Select All checkbox
      document.getElementById("reviewSelectAll").addEventListener("change", (e) => {
        const checkboxes = document.querySelectorAll(".reviewJobCheck");
        checkboxes.forEach(cb => {
          cb.checked = e.target.checked;
          const jobId = cb.dataset.jobid;
          const job = currentReviewJobs.find(j => j.id === jobId);
          if (e.target.checked && job) {
            reviewSelectedJobs.set(jobId, job);
          } else {
            reviewSelectedJobs.delete(jobId);
          }
        });
        updateAddSelectedButton();
      });
      
      // Add Selected button
      document.getElementById("addSelectedBtn").addEventListener("click", addSelectedToPipeline);
      
      // Column sorting for Review table
      document.querySelectorAll("#reviewTable th.sortable").forEach(th => {
        th.addEventListener("click", () => {
          const col = th.dataset.sort;
          
          // Toggle direction or set new column
          if (reviewSort.col === col) {
            reviewSort.dir = reviewSort.dir === 'asc' ? 'desc' : 'asc';
          } else {
            reviewSort.col = col;
            reviewSort.dir = 'asc';
          }
          
          // Update sort icons
          document.querySelectorAll("#reviewTable th.sortable .sortIcon").forEach(icon => {
            icon.textContent = '‚¨ç';
          });
          th.querySelector(".sortIcon").textContent = reviewSort.dir === 'asc' ? '‚¨Ü' : '‚¨á';
          
          // Sort locally
          sortReviewJobsLocally();
        });
      });
      
      // Tab switching
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          
          // Save to localStorage
          localStorage.setItem('activeTab', tab);
          
          // Update buttons
          document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          
          // Update content
          document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
          document.getElementById(`tab-${tab}`).classList.add("active");
          
          // Update status bar based on tab
          if (tab === "companies") {
            // Header stays the same - universal funnel
            if (ALL_JOBS.length > 0) {
              updateStatus();
            }
          } else if (tab === "jobs") {
            if (ALL_JOBS_RAW.length > 0) {
              // Jobs already loaded - just filter and render
              const filtered = applyFilters(ALL_JOBS);
              renderJobs(filtered);
            } else {
              // No jobs loaded yet - load from cache
              loadJobsFromCache();
            }
          } else if (tab === "review") {
            // Review tab - auto-load first page
            loadReviewJobs(1);
          } else if (tab === "answers") {
            // Answers tab - load answer library
            if (!answerLibrary.personal) loadAnswerLibrary();
          }
        });
      });
      
      // Load companies

      // === Stats by Date functions ===
      async function loadStatsByDate() {
        try {
          const res = await fetch("/stats/by-date?days=14");
          const data = await res.json();
          if (data.error) return;
          renderStatsByDate(data.dates, data.last_refresh);
        } catch (e) {
          console.error("Failed to load stats by date:", e);
        }
      }
      
      function renderStatsByDate(dates, lastRefresh) {
        const tbody = document.querySelector("#statsByDateTable tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        
        for (const d of dates) {
          const row = document.createElement("tr");
          const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
          const dateObj = new Date(d.date + "T00:00:00");
          const dateFormatted = months[dateObj.getMonth()] + " " + dateObj.getDate();
          
          row.innerHTML = 
            '<td style="padding: 6px 8px; font-weight: 500;">' + dateFormatted + '</td>' +
            '<td style="padding: 6px 8px; text-align: right;">' + d.total + '</td>' +
            '<td style="padding: 6px 8px; text-align: right;"><a href="#" class="stats-link" data-filter="primary" data-date="' + d.date + '" style="color: #10b981;">' + d.primary + '</a></td>' +
            '<td style="padding: 6px 8px; text-align: right;"><a href="#" class="stats-link" data-filter="adjacent" data-date="' + d.date + '" style="color: #3b82f6;">' + d.adjacent + '</a></td>' +
            '<td style="padding: 6px 8px; text-align: right;"><a href="#" class="stats-link" data-filter="unknown" data-date="' + d.date + '" style="color: #f59e0b;">' + d.unknown + '</a></td>' +
            '<td style="padding: 6px 8px; text-align: right;"><a href="#" class="stats-link" data-filter="excluded" data-date="' + d.date + '" style="color: #ef4444;">' + d.excluded + '</a></td>' +
            '<td style="padding: 6px 8px; text-align: right;"><a href="#" class="stats-link" data-filter="us" data-date="' + d.date + '" style="color: #3b82f6;">' + d.us + '</a></td>' +
            '<td style="padding: 6px 8px; text-align: right;"><a href="#" class="stats-link" data-filter="nc" data-date="' + d.date + '" style="color: #10b981;">' + d.nc + '</a></td>' +
            '<td style="padding: 6px 8px; text-align: right;"><a href="#" class="stats-link" data-filter="neighbor" data-date="' + d.date + '" style="color: #8b5cf6;">' + d.neighbor + '</a></td>' +
            '<td style="padding: 6px 8px; text-align: right;"><a href="#" class="stats-link" data-filter="remote" data-date="' + d.date + '" style="color: #6366f1;">' + d.remote + '</a></td>';
          tbody.appendChild(row);
        }
        
        if (lastRefresh) {
          const mins = Math.floor((new Date() - new Date(lastRefresh)) / 60000);
          let ago = mins < 60 ? mins + " min ago" : Math.floor(mins / 60) + "h ago";
          document.getElementById("statsLastRefresh").textContent = "Last refresh: " + ago;
        }
        
        document.querySelectorAll(".stats-link").forEach(function(link) {
          link.addEventListener("click", function(e) {
            e.preventDefault();
            var filter = e.target.dataset.filter;
            var date = e.target.dataset.date;
            openFilteredView(filter, date);
          });
        });
      }
      
      function openFilteredView(filter, date) {
        // Switch tab
        var tabName = (filter === "unknown" || filter === "excluded") ? "review" : "jobs";
        document.querySelectorAll(".tab-btn").forEach(function(btn) {
          btn.classList.toggle("active", btn.dataset.tab === tabName);
        });
        document.querySelectorAll(".tab-content").forEach(function(c) {
          c.classList.toggle("active", c.id === "tab-" + tabName);
        });
        
        // Build URL - use pipeline endpoint
        var url = "/pipeline/all?date=" + date;
        if (filter === "primary" || filter === "adjacent" || filter === "unknown" || filter === "excluded") {
          url += "&category=" + filter;
        } else if (filter === "us" || filter === "nc" || filter === "neighbor" || filter === "remote") {
          url += "&location=" + filter;
        }
        
        // Load and display
        fetch(url)
          .then(function(res) { return res.json(); })
          .then(function(data) {
            var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            var dateObj = new Date(date + "T00:00:00");
            var dateLabel = months[dateObj.getMonth()] + " " + dateObj.getDate();
            
            if (tabName === "jobs") {
              ALL_JOBS = enrichJobsLocationNorm(data.jobs || []);
              pipelineFilteredJobs = ALL_JOBS;
              pipelinePage = 1;
              renderJobs(pipelineFilteredJobs);
              document.getElementById("statusPipeline").innerHTML = 
                '<span class="pipe-item active">üìÖ ' + dateLabel + ': ' + (data.count || data.jobs?.length || 0) + ' ' + filter + ' jobs</span>';
            } else {
              renderReviewJobs(data.jobs || []);
              var statusEl = document.getElementById("reviewStatus");
              if (statusEl) statusEl.innerHTML = 'üìÖ ' + dateLabel + ': ' + (data.count || data.jobs?.length || 0) + ' ' + filter + ' jobs';
            }
          })
          .catch(function(e) { console.error("Failed to load:", e); });
      }


      // === Application Preparation Modal (NEW) ===
      let currentPrepData = null;
      let prepareResult = null;
      
      function closeAnalysisModal() {
        document.getElementById('jobAnalysisModal').style.display = 'none';
        currentPrepData = null;
        prepareResult = null;
      }
      
      // Show modal with existing files (fast path - no API calls needed)
      function showPrepareModalWithExisting(company, position, jobUrl, roleFamily, jobData, existingData) {
        console.log('[PrepareModal] Fast path - existing files found');
        currentPrepData = { company, position, jobUrl, jd: '', roleFamily, jobData };
        window._pendingExistingData = existingData;
        
        // Show modal
        document.getElementById('analysisCompanyName').textContent = company;
        document.getElementById('analysisPositionName').textContent = position;
        document.getElementById('prepareLoading').style.display = 'none';
        document.getElementById('prepareResults').style.display = 'none';
        document.getElementById('existingFilesChoice').style.display = 'block';
        document.getElementById('rightPanelDocs').style.opacity = '0.3';
        document.getElementById('rightPanelDocs').style.pointerEvents = 'none';
        document.getElementById('jobAnalysisModal').style.display = 'flex';
        
        // Populate info
        document.getElementById('existingFolderInfo').textContent = 'üìÅ Folder: ' + existingData.folder_name;
        document.getElementById('existingCvInfo').textContent = 'üìÑ CV: ' + (existingData.cv_filename || 'Will use Base CV');
        document.getElementById('existingClInfo').textContent = 'üìù Cover Letter: ' + (existingData.cover_letter_filename || 'Not found');
        document.getElementById('existingDateInfo').textContent = 'üìÖ Created: ' + existingData.created_at;
      }
      
      // Show modal for new application (need to generate)
      function showPrepareModalNew(company, position, jobUrl, jd, roleFamily, jobData) {
        console.log('[PrepareModal] New application - will generate');
        currentPrepData = { company, position, jobUrl, jd, roleFamily, jobData };
        
        // Show modal with loading
        document.getElementById('analysisCompanyName').textContent = company;
        document.getElementById('analysisPositionName').textContent = position;
        document.getElementById('prepareLoading').style.display = 'block';
        document.getElementById('prepareResults').style.display = 'none';
        document.getElementById('existingFilesChoice').style.display = 'none';
        document.getElementById('rightPanelDocs').style.opacity = '1';
        document.getElementById('rightPanelDocs').style.pointerEvents = 'auto';
        document.getElementById('jobAnalysisModal').style.display = 'flex';
        
        // Reset right panel
        document.getElementById('prepCvFilename').textContent = 'Generating...';
        document.getElementById('prepClFilename').textContent = 'Generating...';
        document.getElementById('prepClPreview').textContent = 'Generating with AI...';
        document.getElementById('btnOpenCv').disabled = true;
        document.getElementById('btnOpenCvFolder').disabled = true;
        document.getElementById('btnOpenCl').disabled = true;
        document.getElementById('btnStartApplication').disabled = true;
        
        // Start generation
        generateNewApplication();
      }
      
      async function showPrepareModal(company, position, jobUrl, jd, roleFamily, jobData) {
        console.log('[PrepareModal] Starting:', { company, position, jobUrl: jobUrl?.substring(0, 50), jdLength: jd?.length, roleFamily });
        currentPrepData = { company, position, jobUrl, jd, roleFamily, jobData };
        
        // Show modal with loading state
        document.getElementById('analysisCompanyName').textContent = company;
        document.getElementById('analysisPositionName').textContent = position;
        document.getElementById('prepareLoading').style.display = 'block';
        document.getElementById('prepareResults').style.display = 'none';
        document.getElementById('existingFilesChoice').style.display = 'none';
        document.getElementById('jobAnalysisModal').style.display = 'flex';
        
        // Reset right panel
        document.getElementById('prepCvFilename').textContent = 'Checking...';
        document.getElementById('prepClFilename').textContent = 'Checking...';
        document.getElementById('prepClPreview').textContent = 'Checking for existing files...';
        document.getElementById('btnOpenCv').disabled = true;
        document.getElementById('btnOpenCvFolder').disabled = true;
        document.getElementById('btnOpenCl').disabled = true;
        document.getElementById('btnStartApplication').disabled = true;
        
        try {
          // First check if files already exist
          console.log('[PrepareModal] Checking existing files...');
          const checkRes = await fetch('/check-existing-application', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_title: position, company: company })
          });
          const existingData = await checkRes.json();
          
          if (existingData.exists) {
            console.log('[PrepareModal] Found existing files:', existingData);
            // Show choice UI instead of confirm dialog
            document.getElementById('prepareLoading').style.display = 'none';
            document.getElementById('existingFilesChoice').style.display = 'block';
            document.getElementById('rightPanelDocs').style.opacity = '0.3';
            document.getElementById('rightPanelDocs').style.pointerEvents = 'none';
            
            // Populate info
            document.getElementById('existingFolderInfo').textContent = 'üìÅ Folder: ' + existingData.folder_name;
            document.getElementById('existingCvInfo').textContent = 'üìÑ CV: ' + (existingData.cv_filename || 'Will use Base CV');
            document.getElementById('existingClInfo').textContent = 'üìù Cover Letter: ' + (existingData.cover_letter_filename || 'Not found');
            document.getElementById('existingDateInfo').textContent = 'üìÖ Created: ' + existingData.created_at;
            
            // Store for later use
            window._pendingExistingData = existingData;
            return; // Wait for user choice
          }
          
          // No existing files - proceed with AI generation
          await generateNewApplication();
          
        } catch (err) {
          document.getElementById('prepareLoading').innerHTML = 
            '<div style="color: #ef4444;">‚ùå Error: ' + err.message + '</div>';
        }
      }
      
      // Handler for "Use Existing Files" button
      // Open existing folder
      async function openExistingFolder() {
        const data = window._pendingExistingData;
        if (!data?.folder) return;
        try {
          await fetch(`/open-file/folder?path=${encodeURIComponent(data.folder)}`);
        } catch (e) {
          console.error('Failed to open folder:', e);
        }
      }
      
      // Open existing CV
      async function openExistingCv() {
        const data = window._pendingExistingData;
        if (data?.cv_path) {
          try {
            await fetch(`/open-file/cv?path=${encodeURIComponent(data.cv_path)}`);
          } catch (e) {
            console.error('Failed to open CV:', e);
          }
        } else {
          // Open base CV
          const roleFamily = currentPrepData?.roleFamily || 'product';
          const roleCvMap = {
            'product': 'CV_Anton_Kondakov_Product Manager.docx',
            'tpm_program': 'CV_Anton_Kondakov_TPM.docx',
            'project': 'CV_Anton_Kondakov_Project Manager.docx',
            'other': 'CV_Anton_Kondakov_Product Manager.docx'
          };
          const baseCvPath = '/Users/antonkondakov/Library/Mobile Documents/com~apple~CloudDocs/Dev/AI_projects/Gold CV/' + (roleCvMap[roleFamily] || roleCvMap['product']);
          try {
            await fetch(`/open-file/cv?path=${encodeURIComponent(baseCvPath)}`);
          } catch (e) {
            console.error('Failed to open base CV:', e);
          }
        }
      }
      
      // Open existing cover letter
      async function openExistingCl() {
        const data = window._pendingExistingData;
        if (!data?.cover_letter_path) {
          alert('No cover letter found');
          return;
        }
        try {
          await fetch(`/open-file/cover_letter?path=${encodeURIComponent(data.cover_letter_path)}`);
        } catch (e) {
          console.error('Failed to open cover letter:', e);
        }
      }
      
      function useExistingFiles() {
        const existingData = window._pendingExistingData;
        if (!existingData) return;
        
        document.getElementById('existingFilesChoice').style.display = 'none';
        document.getElementById('prepareResults').style.display = 'block';
        document.getElementById('rightPanelDocs').style.opacity = '1';
        document.getElementById('rightPanelDocs').style.pointerEvents = 'auto';
        displayExistingFiles(existingData);
      }
      
      // Handler for "Regenerate" button
      async function regenerateFiles() {
        document.getElementById('existingFilesChoice').style.display = 'none';
        document.getElementById('rightPanelDocs').style.opacity = '1';
        document.getElementById('rightPanelDocs').style.pointerEvents = 'auto';
        await generateNewApplication();
      }
      
      // Generate new application with AI
      async function generateNewApplication() {
        const { company, position, jobUrl, jd, roleFamily } = currentPrepData || {};
        
        document.getElementById('prepareLoading').style.display = 'block';
        document.getElementById('prepareLoading').innerHTML = `
          <div style="font-size: 24px; margin-bottom: 16px;">‚è≥</div>
          <div style="color: var(--muted);">Analyzing job with AI...</div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 8px;">This may take 10-15 seconds</div>
        `;
        
        try {
          const res = await fetch('/prepare-application', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              job_title: position,
              company: company,
              job_url: jobUrl,
              job_description: jd,
              role_family: roleFamily,
              force_regenerate: true
            })
          });
          
          const data = await res.json();
          prepareResult = data;
          
          if (!data.ok) {
            document.getElementById('prepareLoading').innerHTML = 
              '<div style="color: #ef4444;">‚ùå Error: ' + (data.error || 'Unknown error') + '</div>';
            return;
          }
          
          // Hide loading, show results
          document.getElementById('prepareLoading').style.display = 'none';
          document.getElementById('prepareResults').style.display = 'block';
          
          // Populate results
          displayPrepareResults(data);
          
        } catch (err) {
          document.getElementById('prepareLoading').innerHTML = 
            '<div style="color: #ef4444;">‚ùå Error: ' + err.message + '</div>';
        }
      }
      
      function displayPrepareResults(data) {
        // Match Score
        const scoreEl = document.getElementById('prepMatchScore');
        scoreEl.textContent = data.match_score + '%';
        scoreEl.style.color = data.match_score >= 75 ? '#10b981' : data.match_score >= 60 ? '#f59e0b' : '#ef4444';
        
        // Fit Level
        const fitEl = document.getElementById('prepFitLevel');
        const fitColors = { excellent: '#10b981', good: '#22c55e', moderate: '#f59e0b', low: '#ef4444' };
        fitEl.textContent = (data.fit_level || 'unknown').charAt(0).toUpperCase() + (data.fit_level || '').slice(1);
        fitEl.style.color = fitColors[data.fit_level] || 'var(--text)';
        
        // AI Summary
        document.getElementById('prepSummary').textContent = data.analysis_summary || 'Analysis complete.';
        
        // Matching Experience
        const matchingEl = document.getElementById('prepMatching');
        if (data.matching_experience && data.matching_experience.length > 0) {
          matchingEl.innerHTML = data.matching_experience.map(e => 
            '<div style="margin-bottom: 4px;">‚Ä¢ ' + e + '</div>'
          ).join('');
        } else {
          document.getElementById('prepMatchingSection').style.display = 'none';
        }
        
        // Gaps
        const gapsSection = document.getElementById('prepGapsSection');
        const gapsEl = document.getElementById('prepGaps');
        if (data.gaps && data.gaps.length > 0) {
          gapsSection.style.display = 'block';
          gapsEl.innerHTML = data.gaps.map(g => 
            '<div style="margin-bottom: 4px;">‚Ä¢ ' + g + '</div>'
          ).join('');
        }
        
        // Red Flags
        const redFlagsSection = document.getElementById('prepRedFlagsSection');
        const redFlagsEl = document.getElementById('prepRedFlags');
        if (data.red_flags && data.red_flags.length > 0) {
          redFlagsSection.style.display = 'block';
          redFlagsEl.innerHTML = data.red_flags.map(f => 
            '<div style="margin-bottom: 4px;">‚Ä¢ ' + f + '</div>'
          ).join('');
        }
        
        // CV Decision
        const cvBadge = document.getElementById('prepCvBadge');
        if (data.cv_decision === 'optimize') {
          cvBadge.textContent = 'OPTIMIZED';
          cvBadge.style.background = '#8b5cf6';
          cvBadge.style.color = 'white';
        } else {
          cvBadge.textContent = 'BASE';
          cvBadge.style.background = '#3b82f6';
          cvBadge.style.color = 'white';
        }
        document.getElementById('prepCvReason').textContent = data.cv_reason || '';
        
        // Keywords Added
        if (data.keywords_added && data.keywords_added.length > 0) {
          document.getElementById('prepKeywordsAdded').style.display = 'block';
          document.getElementById('prepKeywordsList').textContent = data.keywords_added.join(', ');
        }
        
        // Right Panel - Documents
        document.getElementById('prepCvFilename').textContent = data.cv_filename || 'No CV';
        document.getElementById('prepClFilename').textContent = data.cover_letter_filename || 'No Cover Letter';
        document.getElementById('prepClPreview').textContent = data.cover_letter_preview || 'No cover letter generated.';
        
        // Enable buttons
        if (data.cv_path) {
          document.getElementById('btnOpenCv').disabled = false;
        }
        if (data.application_folder) {
          document.getElementById('btnOpenCvFolder').disabled = false;
        }
        if (data.cover_letter_path) {
          document.getElementById('btnOpenCl').disabled = false;
        }
        
        // Enable Start Application button
        document.getElementById('btnStartApplication').disabled = false;
      }
      
      function displayExistingFiles(data) {
        // Set prepareResult for openPreparedFile to work
        prepareResult = {
          cv_path: data.cv_path,
          cv_filename: data.cv_filename,
          cover_letter_path: data.cover_letter_path,
          cover_letter_filename: data.cover_letter_filename,
          application_folder: data.folder,
          application_url: currentPrepData?.jobUrl || ''
        };
        
        // If no CV in existing folder, use base CV
        if (!data.cv_path) {
          const roleFamily = currentPrepData?.roleFamily || 'product';
          const roleCvMap = {
            'product': 'CV_Anton_Kondakov_Product Manager.docx',
            'tpm_program': 'CV_Anton_Kondakov_TPM.docx',
            'project': 'CV_Anton_Kondakov_Project Manager.docx',
            'other': 'CV_Anton_Kondakov_Product Manager.docx'
          };
          const baseCvName = roleCvMap[roleFamily] || roleCvMap['product'];
          const baseCvPath = '/Users/antonkondakov/Library/Mobile Documents/com~apple~CloudDocs/Dev/AI_projects/Gold CV/' + baseCvName;
          prepareResult.cv_path = baseCvPath;
          prepareResult.cv_filename = baseCvName + ' (Base)';
        }
        
        // Update left panel with "Using existing" message
        document.getElementById('prepMatchScore').textContent = '--';
        document.getElementById('prepMatchScore').style.color = 'var(--muted)';
        document.getElementById('prepFitLevel').textContent = 'Existing';
        document.getElementById('prepFitLevel').style.color = '#8b5cf6';
        document.getElementById('prepSummary').textContent = '\u2705 Using previously generated application files. Click "Start Application" to proceed or open files to review.';
        
        // Hide analysis sections
        document.getElementById('prepMatchingSection').style.display = 'none';
        document.getElementById('prepGapsSection').style.display = 'none';
        document.getElementById('prepRedFlagsSection').style.display = 'none';
        
        // CV Decision
        const cvBadge = document.getElementById('prepCvBadge');
        cvBadge.textContent = data.cv_path ? 'EXISTING' : 'BASE';
        cvBadge.style.background = data.cv_path ? '#8b5cf6' : '#3b82f6';
        cvBadge.style.color = 'white';
        document.getElementById('prepCvReason').textContent = data.cv_path ? 'Using files from ' + data.created_at : 'Using base CV (no optimized CV found)';
        document.getElementById('prepKeywordsAdded').style.display = 'none';
        
        // Right Panel - Documents
        document.getElementById('prepCvFilename').textContent = prepareResult.cv_filename || 'Not found';
        document.getElementById('prepClFilename').textContent = data.cover_letter_filename || 'Not found';
        document.getElementById('prepClPreview').textContent = data.cover_letter_preview || (data.cover_letter_path ? 'Click "Open Cover Letter" to view.' : 'No cover letter found.');
        
        // Enable buttons
        if (prepareResult.cv_path) {
          document.getElementById('btnOpenCv').disabled = false;
        }
        if (data.folder) {
          document.getElementById('btnOpenCvFolder').disabled = false;
        }
        if (data.cover_letter_path) {
          document.getElementById('btnOpenCl').disabled = false;
        }
        
        // Enable Start Application button
        document.getElementById('btnStartApplication').disabled = false;
      }
      
      async function openPreparedFile(fileType) {
        if (!prepareResult) return;
        
        let path = '';
        if (fileType === 'cv') path = prepareResult.cv_path;
        else if (fileType === 'cover_letter') path = prepareResult.cover_letter_path;
        else if (fileType === 'folder') path = prepareResult.application_folder;
        
        if (!path) {
          alert('File not found');
          return;
        }
        
        try {
          const res = await fetch('/open-file/' + fileType + '?path=' + encodeURIComponent(path));
          const data = await res.json();
          if (!data.ok) {
            alert('Error opening file: ' + data.error);
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
      }
      
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // BULK ACTIONS - Selection & Apply
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      
      let selectedJobs = new Map(); // jobKey -> {url, company, title, ats, status}
      
      function updateBulkActionsBar() {
        const bar = document.getElementById('bulkActionsBar');
        const count = document.getElementById('selectedCount');
        const n = selectedJobs.size;
        
        if (n > 0) {
          bar.style.display = 'flex';
          count.textContent = n + ' selected';
        } else {
          bar.style.display = 'none';
        }
        
        // Update Select All checkbox state
        const selectAll = document.getElementById('selectAllJobs');
        const allCheckboxes = document.querySelectorAll('.jobCheckbox');
        const checkedCount = document.querySelectorAll('.jobCheckbox:checked').length;
        
        if (allCheckboxes.length > 0 && checkedCount === allCheckboxes.length) {
          selectAll.checked = true;
          selectAll.indeterminate = false;
        } else if (checkedCount > 0) {
          selectAll.checked = false;
          selectAll.indeterminate = true;
        } else {
          selectAll.checked = false;
          selectAll.indeterminate = false;
        }
      }
      
      function handleJobCheckboxChange(e) {
        const cb = e.target;
        const jobKey = cb.dataset.jobkey;
        
        if (cb.checked) {
          selectedJobs.set(jobKey, {
            url: cb.dataset.url,
            company: cb.dataset.company,
            title: cb.dataset.title,
            ats: cb.dataset.ats,
            status: cb.dataset.status
          });
        } else {
          selectedJobs.delete(jobKey);
        }
        
        updateBulkActionsBar();
      }
      
      function handleSelectAllChange(e) {
        const checked = e.target.checked;
        const checkboxes = document.querySelectorAll('.jobCheckbox');
        
        checkboxes.forEach(cb => {
          cb.checked = checked;
          const jobKey = cb.dataset.jobkey;
          
          if (checked) {
            selectedJobs.set(jobKey, {
              url: cb.dataset.url,
              company: cb.dataset.company,
              title: cb.dataset.title,
              ats: cb.dataset.ats,
              status: cb.dataset.status
            });
          } else {
            selectedJobs.delete(jobKey);
          }
        });
        
        updateBulkActionsBar();
      }
      
      function clearSelection() {
        selectedJobs.clear();
        document.querySelectorAll('.jobCheckbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllJobs').checked = false;
        updateBulkActionsBar();
      }
      
      async function bulkApply() {
        if (selectedJobs.size === 0) {
          alert('No jobs selected');
          return;
        }
        
        const engine = document.getElementById('fillerEngineSelect').value;
        const jobs = Array.from(selectedJobs.values());
        
        // Filter to supported ATS
        const supportedAts = ['greenhouse', 'lever', 'ashby', 'workday', 'smartrecruiters', 'manual', ''];
        const supportedJobs = jobs.filter(j => supportedAts.includes((j.ats || '').toLowerCase()));
        
        if (supportedJobs.length === 0) {
          alert('No supported ATS jobs selected.');
          return;
        }
        
        // For now, open first job
        const firstJob = supportedJobs[0];
        
        const confirmMsg = `Apply to "${firstJob.company} - ${firstJob.title}" using ${engine.toUpperCase()}?` +
          (supportedJobs.length > 1 ? `\n\n(${supportedJobs.length - 1} more jobs selected - batch mode coming soon)` : '');
        
        if (!confirm(confirmMsg)) return;
        
        try {
          const endpoint = engine === 'v6' ? '/apply/v6' : '/apply/v5';
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              job_url: firstJob.url,
              profile: 'anton_kondakov'
            })
          });
          
          const data = await res.json();
          
          if (data.ok) {
            alert(`üöÄ ${engine.toUpperCase()} Form Filler started!\n\nJob: ${firstJob.company} - ${firstJob.title}\n\nCheck the Terminal window.`);
            clearSelection();
          } else {
            alert('Error: ' + data.error);
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
      }
      
      function bulkOpenUrls() {
        if (selectedJobs.size === 0) {
          alert('No jobs selected');
          return;
        }
        
        const jobs = Array.from(selectedJobs.values());
        
        if (jobs.length > 10) {
          if (!confirm(`Open ${jobs.length} URLs in new tabs?`)) return;
        }
        
        jobs.forEach(j => {
          window.open(j.url, '_blank');
        });
      }
      
      // Initialize bulk actions listeners
      (function initBulkActions() {
        // Select All checkbox
        document.getElementById('selectAllJobs')?.addEventListener('change', handleSelectAllChange);
        
        // Bulk action buttons
        document.getElementById('bulkApplyBtn')?.addEventListener('click', bulkApply);
        document.getElementById('bulkOpenUrlsBtn')?.addEventListener('click', bulkOpenUrls);
        document.getElementById('bulkClearBtn')?.addEventListener('click', clearSelection);
        
        // Prepare button - open prepare modal for first selected
        document.getElementById('bulkPrepareBtn')?.addEventListener('click', () => {
          if (selectedJobs.size === 0) {
            alert('No jobs selected');
            return;
          }
          const first = Array.from(selectedJobs.values())[0];
          showPrepareModal(first.company, first.title, first.url, '', 'product', {});
        });
        
        // Delegate checkbox changes on table
        document.getElementById('jobsTable')?.addEventListener('change', (e) => {
          if (e.target.classList.contains('jobCheckbox')) {
            handleJobCheckboxChange(e);
          }
        });
      })();
      
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      
      async function startApplication() {
        if (!prepareResult) {
          alert('No application data. Please try again.');
          return;
        }
        
        // Get selected engine
        const engineRadio = document.querySelector('input[name="fillerEngine"]:checked');
        const engine = engineRadio ? engineRadio.value : 'v6';
        
        // Save data before closing modal
        const jobUrl = currentPrepData?.jobUrl || prepareResult.application_url || '';
        const company = currentPrepData?.company || '';
        const position = currentPrepData?.position || '';
        const applicationUrl = prepareResult.application_url || jobUrl;
        const cvFilename = prepareResult.cv_filename || 'Ready';
        const clFilename = prepareResult.cover_letter_filename || 'Ready';
        
        // Close modal
        closeAnalysisModal();
        
        // Start form filler with selected engine
        try {
          const endpoint = engine === 'v6' ? '/apply/v6' : '/apply/v5';
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              job_url: applicationUrl,
              profile: 'anton_kondakov'
            })
          });
          
          const data = await res.json();
          
          if (data.ok) {
            alert(`üöÄ ${engine.toUpperCase()} Form Filler started!\n\n` +
              '‚úÖ CV: ' + cvFilename + '\n' +
              '‚úÖ Cover Letter: ' + clFilename + '\n\n' +
              'Check the Terminal window.');
          } else {
            alert('Error starting application: ' + data.error);
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
      }
      
      // Legacy function mapping for compatibility
      function showAnalysisModal(company, position, analysisData, jobData) {
        // Redirect to new prepare modal
        showPrepareModal(
          company, 
          position, 
          jobData.job_url || '', 
          analysisData.jd || '', 
          jobData.role_family || 'product',
          jobData
        );
      }
      
      // === CV Management Functions (Legacy - kept for compatibility) ===
      let availableCvs = [];
      let selectedCvPath = null;
      
      async function loadAvailableCvs() {
        try {
          const res = await fetch('/available-cvs');
          const data = await res.json();
          availableCvs = data.cvs || [];
          
          const select = document.getElementById('analysisCvSelect'); if (!select) return;
          select.innerHTML = '<option value="auto">ü§ñ Auto-select by role</option>';
          
          availableCvs.forEach(cv => {
            const opt = document.createElement('option');
            opt.value = cv.path;
            opt.textContent = cv.name;
            select.appendChild(opt);
          });
        } catch (e) {
          console.error('Failed to load CVs:', e);
        }
      }
      
      function useExistingCv() {
        const select = document.getElementById('analysisCvSelect'); if (!select) return;
        selectedCvPath = select.value === 'auto' ? null : select.value;
        
        const statusEl = document.getElementById('cvOptionStatus');
        if (selectedCvPath) {
          const cvName = availableCvs.find(c => c.path === selectedCvPath)?.name || 'Selected';
          statusEl.innerHTML = '‚úÖ Will use: <strong>' + cvName + '</strong>';
          document.getElementById('analysisCvFile').textContent = cvName;
        } else {
          statusEl.innerHTML = 'ü§ñ CV will be auto-selected based on job role';
        }
        
        // Highlight button
        document.getElementById('btnUseExistingCv').style.background = 'var(--accent)';
        document.getElementById('btnOptimizeCv').style.background = 'transparent';
      }
      
      async function optimizeCvWithAI() {
        if (!currentAnalysisData) return;
        
        const statusEl = document.getElementById('cvOptionStatus');
        const btn = document.getElementById('btnOptimizeCv');
        
        btn.disabled = true;
        btn.textContent = '‚è≥ Optimizing...';
        statusEl.innerHTML = 'üß† Analyzing job and optimizing CV with AI...';
        
        try {
          const { company, position, analysisData, jobData } = currentAnalysisData;
          const jd = analysisData.jd || '';
          const roleFamily = jobData.role_family || 'product';
          
          const res = await fetch('/cv/optimize-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              job_title: position,
              company: company,
              job_description: jd,
              role_family: roleFamily
            })
          });
          
          const data = await res.json();
          
          if (data.ok) {
            selectedCvPath = data.cv_path;
            statusEl.innerHTML = '‚úÖ AI-optimized CV created: <strong>' + data.cv_name + '</strong>';
            document.getElementById('analysisCvFile').textContent = data.cv_name;
            
            // Update keywords display with AI analysis results
            if (data.keywords_added?.length > 0) {
              statusEl.innerHTML += '<br>üîë Keywords added: ' + data.keywords_added.join(', ');
              
              // Update the Keywords to Add section to show "None - covered by AI"
              document.getElementById('analysisKeywords').innerHTML = 
                '<span style="color:#10b981; font-size:12px;">‚úÖ AI added: ' + 
                data.keywords_added.map(k => '<span style="background:#d1fae5; color:#065f46; padding:2px 6px; border-radius:4px; margin:2px;">' + k + '</span>').join('') + 
                '</span>';
            }
            
            // Update Match Score if AI analysis provided it
            if (data.analysis?.technical_skills?.length > 0) {
              // Show AI-found skills as matching keywords
              const aiSkills = data.analysis.technical_skills.slice(0, 10);
              document.getElementById('analysisFoundKeywords').innerHTML = 
                aiSkills.map(k => '<span style="background:#d1fae5; color:#065f46; padding:2px 8px; border-radius:4px; font-size:12px;">' + k + '</span>').join('');
              
              // Update match score to reflect AI optimization
              const scoreEl = document.getElementById('analysisMatchScore');
              scoreEl.textContent = '95%';
              scoreEl.style.color = '#10b981';
              
              // Update response chance
              document.getElementById('analysisResponseChance').textContent = 'High (80-95%)';
              document.getElementById('analysisResponseChance').style.color = '#10b981';
            }
            
            // Highlight button
            document.getElementById('btnOptimizeCv').style.background = '#8b5cf6';
            document.getElementById('btnOptimizeCv').style.color = 'white';
            document.getElementById('btnUseExistingCv').style.background = 'transparent';
          } else {
            statusEl.innerHTML = '‚ùå Error: ' + (data.error || 'Failed to optimize');
          }
        } catch (e) {
          statusEl.innerHTML = '‚ùå Error: ' + e.message;
        } finally {
          btn.disabled = false;
          btn.textContent = 'üß† AI Optimize CV';
        }
      }
      
      function handleCvUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const statusEl = document.getElementById('cvOptionStatus');
        statusEl.innerHTML = 'üìÅ Uploaded: <strong>' + file.name + '</strong> (will be used for this application)';
        document.getElementById('analysisCvFile').textContent = file.name;
        
        // Store file for later use
        window.uploadedCvFile = file;
        selectedCvPath = 'uploaded:' + file.name;
      }
      
      // Load CVs on page load
      loadAvailableCvs();
      
      async function proceedWithApplication() {
        if (!currentAnalysisData) return;
        
        const { company, position, analysisData, jobData } = currentAnalysisData;
        const btn = document.getElementById('analysisProceedBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Creating tailored CV...';
        
        try {
          const jobUrl = jobData.url || jobData.job_url || '';
          const roleFamily = jobData.role_family || 'product';
          const jobKey = jobData.id || '';
          const keywordsToAdd = analysisData.keywords_to_add || [];
          
          // 1. Create tailored CV with injected keywords
          btn.textContent = '‚è≥ Tailoring CV...';
          const tailorRes = await fetch('/cv/tailor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              job_title: position,
              company: company,
              position: position,
              role_family: roleFamily,
              keywords_to_add: keywordsToAdd
            })
          });
          const tailorData = await tailorRes.json();
          const cvPath = tailorData.cv_path || '';
          
          // 2. Generate Cover Letter
          btn.textContent = '‚è≥ Generating Cover Letter...';
          const clRes = await fetch('/generate-cover-letter', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              company, 
              position, 
              job_description: analysisData.jd || '',
              role_family: roleFamily
            })
          });
          const clData = await clRes.json();
          
          // 3. Update status to Ready
          if (jobKey) {
            await fetch('/pipeline/status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ job_id: jobKey, status: 'Ready', folder_path: clData.folder_path || tailorData.folder || '' })
            });
          }
          
          closeAnalysisModal();
          
          // 4. Start auto-fill with V5 (universal form filler)
          btn.textContent = 'üöÄ Opening form...';
          const applyEndpoint = '/apply/v5';
          
          const applyRes = await fetch(applyEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_url: jobUrl, profile: 'anton_tpm' })
          });
          
          const addedKwMsg = keywordsToAdd.length > 0 
            ? '\nüîë Added keywords: ' + keywordsToAdd.join(', ')
            : '';
          
          if (applyRes.ok) {
            alert('üöÄ Application started!\n\n‚úÖ Tailored CV created' + addedKwMsg + '\n‚úÖ Cover Letter generated\n‚è≥ Form filling in progress...\n\nCheck the browser window.');
            // Refresh jobs list
            const filtered = applyFilters(ALL_JOBS);
            renderJobs(filtered);
          } else {
            alert('Prepared successfully!' + addedKwMsg + '\n\nOpen the job URL manually to apply.');
          }
          
        } catch (err) {
          console.error('Apply error:', err);
          alert('Error: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = 'üöÄ Proceed to Apply';
        }
      }

      // === Prepare Result Modal ===
      let currentPrepareFolder = "";
      
      function showPrepareResult(company, position, cvFilename, clData) {
        console.log("showPrepareResult called:", company, position, clData);
        document.getElementById("prepareCompanyName").textContent = company;
        document.getElementById("preparePositionName").textContent = position;
        document.getElementById("prepareCvName").textContent = cvFilename || "Not selected";
        document.getElementById("prepareTemplateName").textContent = clData.template_used || "Generated";
        document.getElementById("prepareMission").textContent = clData.company_mission || "";
        document.getElementById("prepareFolderPath").textContent = clData.folder_path || "";
        currentPrepareFolder = clData.folder_path || "";
        document.getElementById("prepareResultModal").style.display = "flex";
      }
      
      function closePrepareModal() {
        document.getElementById("prepareResultModal").style.display = "none";
      }
      
      async function openPrepareFolder() {
        if (!currentPrepareFolder) return;
        try {
          await fetch("/open-folder", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path: currentPrepareFolder })
          });
        } catch (e) {
          console.error("Failed to open folder:", e);
        }
      }

      async function loadCompanies() {
        try {
          const res = await fetch(`/companies?profile=all&my_roles=${myRolesEnabled}&my_location=${myLocationEnabled}`);
          const data = await res.json();
          COMPANIES_DATA = data.companies || [];
          
          // Update summary
          document.getElementById("summaryCompanies").textContent = data.count || 0;
          document.getElementById("summaryJobs").textContent = data.summary?.total_jobs || 0;
          document.getElementById("summaryNew").textContent = data.summary?.total_new || 0;
          document.getElementById("summaryApplied").textContent = data.summary?.total_applied || 0;
          
          renderCompanies(COMPANIES_DATA);
          updateCompanySortIcons();
          
          // Update header status if we have jobs loaded
          if (ALL_JOBS.length > 0) {
            updateStatus();
          }
        } catch (err) {
          console.error("Failed to load companies:", err);
          document.getElementById("companiesBody").innerHTML = 
            `<tr><td colspan="10" style="text-align:center; padding: 40px; color: #ef4444;">Failed to load companies</td></tr>`;
        }
      }
      
      function sortCompanies(col) {
        if (companiesSortCol === col) {
          companiesSortDir = companiesSortDir === "asc" ? "desc" : "asc";
        } else {
          companiesSortCol = col;
          // Default: desc for numbers and dates, asc for text
          companiesSortDir = ["total_jobs", "jobs_count", "new_count", "applied_count", "last_ok", "last_checked"].includes(col) ? "desc" : "asc";
        }
        
        // Apply filters first, then sort
        const filtered = filterCompanies(COMPANIES_DATA);
        
        const sorted = [...filtered].sort((a, b) => {
          let va = a[col] ?? "";
          let vb = b[col] ?? "";
          
          // Status column (boolean: false=error first, then true=ok, then null=unknown)
          if (col === "last_ok") {
            const order = { false: 2, true: 1, null: 0 };
            const oa = order[String(va)] ?? 0;
            const ob = order[String(vb)] ?? 0;
            return companiesSortDir === "asc" ? oa - ob : ob - oa;
          }
          
          // Date column
          if (col === "last_checked") {
            const da = va ? new Date(va).getTime() : 0;
            const db = vb ? new Date(vb).getTime() : 0;
            return companiesSortDir === "asc" ? da - db : db - da;
          }
          
          // Numeric columns
          if (typeof va === "number" && typeof vb === "number") {
            return companiesSortDir === "asc" ? va - vb : vb - va;
          }
          
          // String columns
          va = String(va).toLowerCase();
          vb = String(vb).toLowerCase();
          if (va < vb) return companiesSortDir === "asc" ? -1 : 1;
          if (va > vb) return companiesSortDir === "asc" ? 1 : -1;
          return 0;
        });
        
        updateCompanySortIcons();
        renderCompanies(sorted);
      }
      
      function updateCompanySortIcons() {
        const cols = ["company", "industry", "ats", "total_jobs", "jobs_count", "new_count", "applied_count", "last_ok", "last_checked"];
        cols.forEach(c => {
          const icon = document.getElementById(`sortIcon-c-${c}`);
          if (icon) {
            if (c === companiesSortCol) {
              icon.textContent = companiesSortDir === "asc" ? "‚ñ≤" : "‚ñº";
            } else {
              icon.textContent = "‚¨ç";
            }
          }
        });
      }
      
      function renderCompanies(companies) {
        const tbody = document.getElementById("companiesBody");
        
        if (!companies.length) {
          tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding: 40px; color: var(--muted);">No companies found</td></tr>`;
          return;
        }
        
        const now = new Date();
        
        tbody.innerHTML = companies.map(c => {
          const statusIcon = c.last_ok === true ? '‚úÖ' : 
                            c.last_ok === false ? '‚ùå' : 
                            c.last_ok === 'disabled' ? '‚è∏Ô∏è' : '‚è≥';
          const statusClass = c.last_ok === true ? 'status-ok' : 
                              c.last_ok === false ? 'status-error' : 
                              c.last_ok === 'disabled' ? 'status-disabled' : 'status-unknown';
          const statusTitle = c.last_ok === true ? 'OK' :
                              c.last_ok === false ? c.last_error : 
                              c.last_ok === 'disabled' ? `Disabled: ${c.last_error}` : 'Not checked yet - click Refresh';
          const errorTip = ` title="${statusTitle}"`;
          
          const jobsBadgeClass = c.jobs_count > 0 ? 'jobs-badge' : 'jobs-badge zero';
          const totalBadgeClass = c.total_jobs > 0 ? 'jobs-badge' : 'jobs-badge zero';
          
          // Format last_checked date
          const updatedStr = c.last_checked ? formatDateWithAge(c.last_checked) : '‚Äî';
          
          // Check if recently updated (within 10 minutes)
          let recentlyUpdated = false;
          let rowStyle = '';
          if (c.last_checked) {
            const checkedDate = new Date(c.last_checked);
            const diffMins = (now - checkedDate) / 60000;
            if (diffMins < 10) {
              recentlyUpdated = true;
              rowStyle = 'background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, transparent 100%); border-left: 3px solid #22c55e;';
            }
          }
          const recentBadge = recentlyUpdated ? '<span style="background: #22c55e; color: white; font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">JUST NOW</span>' : '';
          
          return `
            <tr class="company-row" data-company="${c.company}" data-id="${c.id || ''}" style="${rowStyle}">
              <td><strong>${c.company}</strong>${recentBadge}</td>
              <td style="color: var(--muted); font-size: 12px;">${c.industry || c.tags?.join(', ') || ''}</td>
              <td><span class="ats-badge">${c.ats}</span></td>
              <td><span class="${totalBadgeClass}">${c.total_jobs || 0}</span></td>
              <td><span class="${jobsBadgeClass}">${c.jobs_count}</span></td>
              <td>${c.new_count || 0}</td>
              <td>${c.applied_count || 0}</td>
              <td class="${statusClass}"${errorTip}>${statusIcon}</td>
              <td style="font-size: 11px; color: var(--muted);">${updatedStr}</td>
              <td><button class="refresh-company-btn" data-id="${c.id || c.company}" data-company="${c.company}" data-total="${c.total_jobs || 0}" title="Refresh this company" style="background: none; border: none; cursor: pointer; font-size: 14px; padding: 4px;">üîÑ</button></td>
            </tr>
          `;
        }).join('');
        
        // Add click handlers for company rows
        tbody.querySelectorAll(".company-row").forEach(row => {
          row.addEventListener("click", (e) => {
            // Don't trigger if clicking on refresh button
            if (e.target.classList.contains('refresh-company-btn')) return;
            const company = row.dataset.company;
            showJobsForCompany(company);
          });
        });
        
        // Add click handlers for refresh buttons
        tbody.querySelectorAll(".refresh-company-btn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const companyId = btn.dataset.id;
            const companyName = btn.dataset.company;
            const row = btn.closest('tr');
            
            // Disable button and show loading
            btn.disabled = true;
            btn.style.minWidth = '60px';
            btn.textContent = '‚è≥ 0';
            
            try {
              // Use streaming endpoint for real-time progress
              const eventSource = new EventSource(`/companies/${encodeURIComponent(companyId)}/refresh/stream`);
              let lastJobsCount = 0;
              
              eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'start') {
                  btn.textContent = `‚è≥ 0`;
                } else if (data.type === 'progress') {
                  lastJobsCount = data.jobs || 0;
                  btn.textContent = `‚è≥ ${lastJobsCount}`;
                } else if (data.type === 'done') {
                  eventSource.close();
                  
                  // Show final jobs count
                  btn.textContent = `‚úÖ ${data.jobs}`;
                  btn.style.color = '#22c55e';
                  
                  // Update status cell (8th)
                  const statusCell = row.querySelector('td:nth-child(8)');
                  if (statusCell) {
                    statusCell.innerHTML = `<span class="status-ok" title="OK">‚úÖ</span>`;
                  }
                  
                  // Update "Updated" cell (9th) with current time
                  const updatedCell = row.querySelector('td:nth-child(9)');
                  if (updatedCell) {
                    updatedCell.textContent = formatDateWithAge(new Date().toISOString());
                  }
                  
                  // Update Total cell (4th)
                  const totalCell = row.querySelector('td:nth-child(4)');
                  if (totalCell) {
                    const badgeClass = data.jobs > 0 ? 'jobs-badge' : 'jobs-badge zero';
                    totalCell.innerHTML = `<span class="${badgeClass}">${data.jobs}</span>`;
                  }
                  
                  // Reset button after delay, then reload
                  setTimeout(() => {
                    btn.textContent = 'üîÑ';
                    btn.style.color = '';
                    btn.style.minWidth = '';
                    btn.disabled = false;
                    loadCompanies();  // Reload to update pipeline stats
                  }, 1500);
                  
                } else if (data.type === 'error') {
                  eventSource.close();
                  btn.textContent = '‚ùå';
                  btn.style.color = '#ef4444';
                  console.error('Refresh error:', data.error);
                  setTimeout(() => {
                    btn.textContent = 'üîÑ';
                    btn.style.color = '';
                    btn.style.minWidth = '';
                    btn.disabled = false;
                  }, 2000);
                }
              };
              
              eventSource.onerror = (err) => {
                eventSource.close();
                // If we got jobs, treat as success
                if (lastJobsCount > 0) {
                  btn.textContent = `‚úÖ ${lastJobsCount}`;
                  btn.style.color = '#22c55e';
                  setTimeout(() => {
                    btn.textContent = 'üîÑ';
                    btn.style.color = '';
                    btn.style.minWidth = '';
                    btn.disabled = false;
                    loadCompanies();
                  }, 1500);
                } else {
                  btn.textContent = '‚ùå';
                  btn.style.color = '#ef4444';
                  setTimeout(() => {
                    btn.textContent = 'üîÑ';
                    btn.style.color = '';
                    btn.style.minWidth = '';
                    btn.disabled = false;
                  }, 2000);
                }
              };
              
            } catch (err) {
              console.error('Refresh error:', err);
              btn.textContent = '‚ùå';
              btn.style.color = '#ef4444';
              setTimeout(() => {
                btn.textContent = 'üîÑ';
                btn.style.color = '';
                btn.style.minWidth = '';
                btn.disabled = false;
              }, 2000);
            }
          });
        });
      }
      
      function showJobsForCompany(company) {
        // Set company filter in Pipeline table
        document.getElementById("pipelineFilterCompany").value = company;
        pipelineFilters.company = company;
        
        // Switch to Jobs tab
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelector('[data-tab="jobs"]').classList.add("active");
        
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        document.getElementById("tab-jobs").classList.add("active");
        
        // If jobs already loaded, filter. Otherwise load from cache.
        if (ALL_JOBS_RAW.length > 0) {
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
        } else {
          loadJobsFromCache();
        }
      }
      
      // Filter jobs to only relevant role categories (primary + adjacent)
      // BUT always include manually added jobs (source: onboard)
      function filterRelevantRoles(jobs) {
        const relevantCategories = ['primary', 'adjacent'];
        return jobs.filter(j => 
          j.source === 'onboard' || relevantCategories.includes(j.role_category)
        );
      }
      
      async function backgroundRefresh() {
        if (isRefreshing) return;
        
        // Check if daemon is locked by another machine
        try {
          const statusRes = await fetch("/daemon/status");
          const status = await statusRes.json();
          if (status.locked_by) {
            alert(`‚ö†Ô∏è Daemon is locked by another machine:\n\n${status.locked_by}\n\nWait for it to finish or disable daemon there first.`);
            return;
          }
        } catch (e) {
          console.error("Failed to check daemon status", e);
        }
        
        isRefreshing = true;
        
        const btn = document.getElementById("refreshBtn");
        btn.disabled = true;
        btn.textContent = "‚è≥ Updating...";
        
        const modal = document.getElementById("refreshModal");
        const progressFill = document.getElementById("refreshProgressFill");
        const progressText = document.getElementById("refreshProgressText");
        const refreshSummary = document.getElementById("refreshSummary");
        const closeBtn = document.getElementById("closeRefreshModal");
        
        modal.style.display = "block";
        document.body.style.paddingTop = "50px";
        progressFill.style.width = "0%";
        progressText.textContent = "Starting...";
        refreshSummary.style.display = "none";
        closeBtn.style.display = "none";
        
        let stats = { ok: 0, error: 0, totalJobs: 0, total: 0 };
        let errors = [];
        let completed = false;
        
        const hideProgressBar = () => {
          modal.style.display = "none";
          document.body.style.paddingTop = "0";
        };
        
        try {
          const eventSource = new EventSource("/refresh/stream?profile=all");
          
          eventSource.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === "start") {
              stats.total = data.total;
              progressText.textContent = `0 / ${data.total} companies`;
            } 
            else if (data.type === "loading") {
              const percent = Math.round(((data.index + 1) / data.total) * 100);
              progressFill.style.width = percent + "%";
              progressText.textContent = `${data.index + 1} / ${data.total}: ${data.company}`;
            }
            else if (data.type === "ok") {
              stats.ok++;
              stats.totalJobs += data.jobs;
            }
            else if (data.type === "error") {
              stats.error++;
              errors.push(data.company);
            }
            else if (data.type === "complete") {
              completed = true;
              eventSource.close();
              
              progressFill.style.width = "100%";
              progressFill.style.background = "#22c55e";
              progressText.textContent = `‚úÖ Done! ${stats.ok} companies, ${data.total_jobs} jobs`;
              
              if (stats.error > 0) {
                refreshSummary.innerHTML = `<span style="color: #ef4444;">${stats.error} errors: ${errors.slice(0,3).join(", ")}${errors.length > 3 ? "..." : ""}</span>`;
                refreshSummary.style.display = "block";
              }
              
              await reloadAfterRefresh();
              
              btn.textContent = "‚úÖ Done";
              btn.disabled = false;
              isRefreshing = false;
              
              // Auto-hide after 3 seconds
              setTimeout(() => {
                hideProgressBar();
                btn.textContent = "üîÑ Refresh from ATS";
              }, 3000);
            }
          };
          
          eventSource.onerror = async (err) => {
            eventSource.close();
            
            // If we processed all companies, treat as success
            if (stats.ok > 0 && stats.ok >= stats.total - 1) {
              progressFill.style.width = "100%";
              progressFill.style.background = "#22c55e";
              progressText.textContent = `‚úÖ Done! ${stats.ok} companies, ${stats.totalJobs} jobs`;
              
              await reloadAfterRefresh();
              
              btn.textContent = "‚úÖ Done";
              setTimeout(() => {
                hideProgressBar();
                btn.textContent = "üîÑ Refresh from ATS";
              }, 3000);
            } else if (stats.ok > 0) {
              // Partial success
              progressText.textContent = `‚ö†Ô∏è Partial: ${stats.ok}/${stats.total} companies, ${stats.totalJobs} jobs`;
              closeBtn.style.display = "inline-block";
              await reloadAfterRefresh();
              btn.textContent = "üîÑ Refresh from ATS";
            } else {
              progressText.textContent = "‚ùå Connection error";
              closeBtn.style.display = "inline-block";
              btn.textContent = "üîÑ Refresh from ATS";
            }
            
            btn.disabled = false;
            isRefreshing = false;
          };
          
        } catch (err) {
          console.error("Refresh failed:", err);
          progressText.textContent = "‚ùå Error: " + err.message;
          closeBtn.style.display = "inline-block";
          btn.textContent = "üîÑ Refresh from ATS";
          btn.disabled = false;
          isRefreshing = false;
        }
      }
      
      // Update status cell for a specific company row
      function updateCompanyRowStatus(companyName, icon, tooltip) {
        const row = document.querySelector(`.company-row[data-company="${companyName}"]`);
        if (row) {
          const statusCell = row.querySelector('td:last-child');
          if (statusCell) {
            statusCell.innerHTML = `<span title="${tooltip}">${icon}</span>`;
          }
        }
      }
      
      // Update total jobs cell for a specific company row
      function updateCompanyRowTotal(companyName, total) {
        const row = document.querySelector(`.company-row[data-company="${companyName}"]`);
        if (row) {
          const totalCell = row.querySelector('td:nth-child(4)');
          if (totalCell) {
            const badgeClass = total > 0 ? 'jobs-badge' : 'jobs-badge zero';
            totalCell.innerHTML = `<span class="${badgeClass}">${total}</span>`;
          }
        }
      }
      
      // Mark all companies with a status
      function updateAllCompaniesStatus(icon, tooltip) {
        document.querySelectorAll('.company-row').forEach(row => {
          const statusCell = row.querySelector('td:last-child');
          if (statusCell) {
            statusCell.innerHTML = `<span title="${tooltip}">${icon}</span>`;
          }
        });
      }
      
      // Switch to Companies tab
      function switchToCompaniesTab() {
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-btn-companies').classList.add('active');
        document.getElementById('tab-companies').classList.add('active');
      }
      
      // Helper to reload data after streaming refresh
      async function reloadAfterRefresh() {
        // Reload stats
        const statsRes = await fetch("/stats");
        if (statsRes.ok) {
          CACHED_STATS = await statsRes.json();
          updateStaleWarning();
        }
        
        // Reload pipeline jobs
        const pipelineRes = await fetch("/pipeline/all");
        const pipelineData = await pipelineRes.json();
        ALL_JOBS_RAW = enrichJobsLocationNorm(pipelineData.jobs || []);
        ALL_JOBS = myRolesEnabled ? filterRelevantRoles(ALL_JOBS_RAW) : ALL_JOBS_RAW;
        
        // Re-render if on Jobs tab
        const jobsTabActive = document.getElementById("tab-jobs").classList.contains("active");
        if (jobsTabActive) {
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
          updateStatus(filtered);
        } else {
          updateStatus(null);
        }
        
        // Reload companies stats
        await loadCompanies();
        setLoading(false, "Loaded");
      }
      
      // Close refresh modal
      document.getElementById("closeRefreshModal").addEventListener("click", () => {
        document.getElementById("refreshModal").style.display = "none";
        document.body.style.paddingTop = "0";
      });
      
      // Refresh button - parses fresh from ATS
      document.getElementById("refreshBtn").addEventListener("click", backgroundRefresh);
      
      function applyMyLocationFilter() {
        if (myLocationEnabled) {
          // Apply My Location settings
          selectedStates = [...MY_LOCATION_STATES];
          includeUS = true;
          includeNonUS = false;
          includeRemoteUSA = true;
        } else {
          // Show everything
          selectedStates = [];
          includeUS = true;
          includeNonUS = true;
          includeRemoteUSA = true;
        }
        
        // Update UI checkboxes
        document.getElementById("locationCategoryFilter").value = locationCategory;
        
        
        
        // Update states UI
        syncStateButton();
      }
      
      // Load environment info
      async function loadEnv() {
        try {
          const res = await fetch("/env");
          const data = await res.json();
          const env = data.env || "PROD";
          const badge = document.getElementById("envBadge");
          badge.textContent = env;
          badge.classList.add(env.toLowerCase());
          if (env === "DEV") {
            document.body.classList.add("env-dev");
            document.title = "[DEV] Job Tracker";
            // Show Sync to PROD button only in DEV
            document.getElementById("syncToProdBtn").style.display = "inline-block";
          }
        } catch (e) {
          console.error("Failed to load env:", e);
        }
      }
      
      // Load data on page load
      loadEnv();
      
      // Company column filter event listeners
      document.getElementById("filterCompany").addEventListener("input", (e) => {
        companyFilters.company = e.target.value;
        applyCompanyFilters();
      });
      document.getElementById("filterIndustry").addEventListener("input", (e) => {
        companyFilters.industry = e.target.value;
        applyCompanyFilters();
      });
      document.getElementById("filterAts").addEventListener("change", (e) => {
        companyFilters.ats = e.target.value;
        applyCompanyFilters();
      });
      document.getElementById("filterJobsMin").addEventListener("input", (e) => {
        companyFilters.jobsMin = parseInt(e.target.value) || 0;
        applyCompanyFilters();
      });
      document.getElementById("filterStatus").addEventListener("change", (e) => {
        companyFilters.status = e.target.value;
        applyCompanyFilters();
      });
      
      // Pipeline column filter event listeners
      function applyPipelineColumnFilters() {
        pipelinePage = 1; // Reset to first page on filter change
        if (ALL_JOBS.length > 0) {
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
        }
      }
      
      document.getElementById("pipelineFilterCompany").addEventListener("input", (e) => {
        pipelineFilters.company = e.target.value;
        applyPipelineColumnFilters();
      });
      document.getElementById("pipelineFilterIndustry")?.addEventListener("input", (e) => {
        pipelineFilters.industry = e.target.value;
        applyPipelineColumnFilters();
      });
      document.getElementById("pipelineFilterTitle").addEventListener("input", (e) => {
        pipelineFilters.title = e.target.value;
        applyPipelineColumnFilters();
      });
      document.getElementById("pipelineFilterLocation").addEventListener("input", (e) => {
        pipelineFilters.location = e.target.value;
        applyPipelineColumnFilters();
      });
      
      document.getElementById("pipelineFilterJobId")?.addEventListener("input", (e) => {
        pipelineFilters.jobId = e.target.value;
        applyPipelineColumnFilters();
      });

      document.getElementById("pipelineFilterAts")?.addEventListener("change", (e) => {
        pipelineFilters.ats = e.target.value;
        applyPipelineColumnFilters();
      });
      
      document.getElementById("pipelineFilterUpdated")?.addEventListener("input", (e) => {
        pipelineFilters.updated = e.target.value;
        applyPipelineColumnFilters();
      });
      
      document.getElementById("pipelineFilterFolder")?.addEventListener("change", (e) => {
        pipelineFilters.folder = e.target.value;
        applyPipelineColumnFilters();
      });
      
      // Review column filter event listeners
      function applyReviewColumnFilters() {
        // Triggers server-side filtering via loadReviewJobs
        // But we also filter client-side for instant feedback
        if (currentReviewJobs.length > 0) {
          const filtered = currentReviewJobs.filter(j => {
            if (reviewFilters.company && !(j.company || "").toLowerCase().includes(reviewFilters.company.toLowerCase())) return false;
            if (reviewFilters.title && !(j.title || "").toLowerCase().includes(reviewFilters.title.toLowerCase())) return false;
            if (reviewFilters.location && !(j.location || "").toLowerCase().includes(reviewFilters.location.toLowerCase())) return false;
            return true;
          });
          renderReviewJobs(filtered);
        }
      }
      
      document.getElementById("reviewFilterCompany").addEventListener("input", (e) => {
        reviewFilters.company = e.target.value;
        applyReviewColumnFilters();
      });
      document.getElementById("reviewFilterTitle").addEventListener("input", (e) => {
        reviewFilters.title = e.target.value;
        applyReviewColumnFilters();
      });
      document.getElementById("reviewFilterLocation").addEventListener("input", (e) => {
        reviewFilters.location = e.target.value;
        applyReviewColumnFilters();
      });
      
      // Restore active tab from localStorage
      const savedTab = localStorage.getItem('activeTab');
      if (savedTab) {
        const tabBtn = document.querySelector(`.tab-btn[data-tab="${savedTab}"]`);
        if (tabBtn) {
          document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
          tabBtn.classList.add("active");
          document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
          document.getElementById(`tab-${savedTab}`).classList.add("active");
        }
      }
      
      loadCompanies();
      loadStatsByDate();
      loadJobsFromCache();  // Load jobs for header stats
      
      // Pagination event listeners
      document.getElementById("paginationPrev").addEventListener("click", () => {
        if (pipelinePage > 1) {
          pipelinePage--;
          renderJobs(pipelineFilteredJobs);
        }
      });
      
      document.getElementById("paginationNext").addEventListener("click", () => {
        const totalPages = Math.ceil(pipelineFilteredJobs.length / pipelinePageSize);
        if (pipelinePage < totalPages) {
          pipelinePage++;
          renderJobs(pipelineFilteredJobs);
        }
      });
      
      document.getElementById("paginationSize").addEventListener("change", (e) => {
        pipelinePageSize = parseInt(e.target.value);
        pipelinePage = 1; // Reset to first page
        renderJobs(pipelineFilteredJobs);
      });

      // Quick Filter Buttons
      document.querySelectorAll(".quick-filter-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          // Update active state
          document.querySelectorAll(".quick-filter-btn").forEach(b => {
            b.style.background = "var(--panel2)";
            b.style.color = "var(--text)";
            b.classList.remove("active");
          });
          btn.style.background = "var(--accent)";
          btn.style.color = "white";
          btn.classList.add("active");
          
          // Set filter
          activeQuickFilter = btn.dataset.filter;
          
          // Apply filters and re-render
          pipelinePage = 1;
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
          updateStatus(filtered);
        });
      });
      
      // Date Range Filter
      document.getElementById("dateRangeFilter")?.addEventListener("change", (e) => {
        dateRangeDays = e.target.value;
        pipelinePage = 1;
        const filtered = applyFilters(ALL_JOBS);
        renderJobs(filtered);
        updateStatus(filtered);
      });
      
      // Global Search Filter
      let searchTimeout = null;
      document.getElementById("globalSearchFilter")?.addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          globalSearchText = e.target.value;
          pipelinePage = 1;
          const filtered = applyFilters(ALL_JOBS);
          renderJobs(filtered);
          updateStatus(filtered);
        }, 300); // Debounce 300ms
      });
      
      // ATS Quick Filter
      document.getElementById("pipelineFilterAtsQuick")?.addEventListener("change", () => {
        pipelinePage = 1;
        const filtered = applyFilters(ALL_JOBS);
        renderJobs(filtered);
        updateStatus(filtered);
      });
      
      // Clear all filters button
      document.getElementById("clearFiltersBtn").addEventListener("click", () => {
        // Reset Quick Filter to "new-week"
        activeQuickFilter = "new-week";
        document.querySelectorAll(".quick-filter-btn").forEach(b => {
          b.style.background = b.dataset.filter === "new-week" ? "var(--accent)" : "var(--panel2)";
          b.style.color = b.dataset.filter === "new-week" ? "white" : "var(--text)";
        });
        
        // Reset Date Range
        dateRangeDays = 14;
        document.getElementById("dateRangeFilter").value = "14";
        
        // Reset Global Search
        globalSearchText = "";
        document.getElementById("globalSearchFilter").value = "";
        
        // Reset ATS
        document.getElementById("pipelineFilterAtsQuick").value = "";
        
        // Reset all column filters in table
        document.querySelectorAll("#jobsTable .column-filter").forEach(el => {
          if (el.tagName === "SELECT") el.value = el.id === "pipelineFilterStatus" ? "all" : "";
          else if (el.tagName === "INPUT") el.value = "";
        });
        
        // Reset location category to US
        locationCategory = "us";
        document.getElementById("locationCategoryFilter").value = "us";
        
        // Reset state multi-select
        selectedStates = [];
        updateStateButtonText();
        
        // Reset sort
        currentSortColumn = null;
        currentSortDirection = "asc";
        document.querySelectorAll(".sortIcon").forEach(icon => icon.textContent = "\u2B0D");
        
        // Reset pipelineFilters object
        Object.keys(pipelineFilters).forEach(k => pipelineFilters[k] = "");
        
        // Re-apply filters
        pipelinePage = 1;
        const filtered = applyFilters(ALL_JOBS);
        renderJobs(filtered);
        updateStatus(filtered);
      });

      // ==================== ANSWERS TAB ====================
      let answerLibrary = {};
      
      async function loadAnswerLibrary() {
        try {
          const resp = await fetch('/answers');
          answerLibrary = await resp.json();
          renderAnswers();
        } catch (e) {
          console.error('Failed to load answers:', e);
        }
      }
      
      function renderAnswers() {
        // Personal Info
        const personalDiv = document.getElementById('personalInfo');
        const personal = answerLibrary.personal || {};
        personalDiv.innerHTML = Object.entries(personal).map(([key, value]) => `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--panel); border-radius:6px;">
            <div>
              <div style="font-size:11px; color:var(--muted); text-transform:uppercase;">${key.replace(/_/g, ' ')}</div>
              <div style="font-size:13px;">${value}</div>
            </div>
            <button class="ghost copy-btn" data-value="${String(value).replace(/"/g, '&quot;')}" style="padding:4px 8px; font-size:11px;">Copy</button>
          </div>
        `).join('');
        
        // Demographics
        const demoDiv = document.getElementById('demographicsInfo');
        const demographics = answerLibrary.demographics || {};
        demoDiv.innerHTML = Object.entries(demographics).map(([key, value]) => `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--panel); border-radius:6px;">
            <div>
              <div style="font-size:11px; color:var(--muted); text-transform:uppercase;">${key.replace(/_/g, ' ')}</div>
              <div style="font-size:13px;">${value}</div>
            </div>
            <button class="ghost copy-btn" data-value="${String(value).replace(/"/g, '&quot;')}" style="padding:4px 8px; font-size:11px;">Copy</button>
          </div>
        `).join('');
        
        // Education
        const eduDiv = document.getElementById('educationInfo');
        const education = answerLibrary.education || [];
        eduDiv.innerHTML = education.map((edu, i) => `
          <div style="padding:12px; background:var(--panel); border-radius:8px; margin-bottom:12px;">
            <div style="font-weight:600; color:var(--accent);">${edu.school}</div>
            <div style="font-size:13px;">${edu.degree} - ${edu.discipline}</div>
            <div style="font-size:12px; color:var(--muted);">${edu.start_month} ${edu.start_year} - ${edu.end_month} ${edu.end_year}</div>
          </div>
        `).join('');
        
        // Employment
        const empDiv = document.getElementById('employmentInfo');
        const employment = answerLibrary.employment || [];
        empDiv.innerHTML = employment.map((emp, i) => `
          <div style="padding:12px; background:var(--panel); border-radius:8px; margin-bottom:12px;">
            <div style="font-weight:600; color:var(--accent);">${emp.company}</div>
            <div style="font-size:13px;">${emp.title}</div>
            <div style="font-size:12px; color:var(--muted);">${emp.start_month} ${emp.start_year} - ${emp.current ? 'Present' : emp.end_month + ' ' + emp.end_year}</div>
          </div>
        `).join('');
        
        // Answers
        const answersDiv = document.getElementById('answersList');
        const answers = answerLibrary.answers || {};
        answersDiv.innerHTML = Object.entries(answers).map(([key, data]) => `
          <div class="answer-item" style="margin-bottom:16px; padding:12px; background:var(--panel); border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <div style="font-weight:600; color:var(--accent); margin-bottom:8px;">${data.question || key}</div>
              <button class="ghost copy-btn" data-value="${String(data.answer || '').replace(/"/g, '&quot;')}" style="padding:4px 8px; font-size:11px;">Copy</button>
            </div>
            <div style="font-size:13px; line-height:1.5; color:var(--text);">${data.answer || ''}</div>
            ${data.note ? `<div style="font-size:11px; color:var(--muted); margin-top:8px; font-style:italic;">Note: ${data.note}</div>` : ''}
          </div>
        `).join('');
        
        // Add copy handlers
        document.querySelectorAll('#tab-answers .copy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const value = btn.dataset.value;
            navigator.clipboard.writeText(value).then(() => {
              const orig = btn.textContent;
              btn.textContent = 'Copied!';
              btn.style.background = 'var(--accent)';
              btn.style.color = 'white';
              setTimeout(() => {
                btn.textContent = orig;
                btn.style.background = '';
                btn.style.color = '';
              }, 1500);
            });
          });
        });
      }
      
      // Cover Letter Modal
      const clModal = document.getElementById('coverLetterModal');
      document.getElementById('clCancel').addEventListener('click', () => {
        clModal.style.display = 'none';
      });
      clModal.addEventListener('click', (e) => {
        if (e.target === clModal) clModal.style.display = 'none';
      });
      
      let currentClFolder = '';
      
      document.getElementById('clGenerate').addEventListener('click', async () => {
        const company = document.getElementById('clCompany').value || '[Company]';
        const position = document.getElementById('clPosition').value || '[Position]';
        const description = document.getElementById('clDescription').value;
        const roleFamily = document.getElementById('clRoleFamily').value;
        
        document.getElementById('clGenerate').textContent = '‚è≥ Generating...';
        document.getElementById('clGenerate').disabled = true;
        
        try {
          const resp = await fetch('/generate-cover-letter', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({company, position, job_description: description, role_family: roleFamily})
          });
          const data = await resp.json();
          
          if (data.ok) {
            document.getElementById('clOutput').textContent = data.cover_letter;
            document.getElementById('clTemplateName').textContent = data.template_used || 'Generated';
            document.getElementById('clFolderName').textContent = data.folder_path ? data.folder_path.split('/').pop() : '';
            document.getElementById('clMission').textContent = data.company_mission || '';
            currentClFolder = data.folder_path || '';
            document.getElementById('clResult').style.display = 'block';
          } else {
            alert('Error: ' + (data.error || 'Failed to generate'));
          }
        } catch (e) {
          alert('Error: ' + e.message);
        } finally {
          document.getElementById('clGenerate').textContent = 'üöÄ Generate';
          document.getElementById('clGenerate').disabled = false;
        }
      });
      
      document.getElementById('clOpenFolder').addEventListener('click', async () => {
        if (!currentClFolder) return;
        try {
          await fetch('/open-folder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({path: currentClFolder})
          });
        } catch (e) {
          console.error('Failed to open folder:', e);
        }
      });
      
      document.getElementById('clCopy').addEventListener('click', () => {
        const text = document.getElementById('clOutput').textContent;
        navigator.clipboard.writeText(text).then(() => {
          document.getElementById('clCopy').textContent = '‚úÖ Copied!';
          setTimeout(() => {
            document.getElementById('clCopy').textContent = 'üìã Copy Text';
          }, 1500);
        });
      });
      
      // Add Job Modal
      const addJobModal = document.getElementById("addJobModal");
      const addJobBtn = document.getElementById("addJobBtn");
      const addJobCancel = document.getElementById("addJobCancel");
      const addJobSubmit = document.getElementById("addJobSubmit");
      const addJobUrl = document.getElementById("addJobUrl");
      const addJobStatus = document.getElementById("addJobStatus");
      
      addJobBtn.addEventListener("click", () => {
        addJobModal.style.display = "flex";
        addJobUrl.value = "";
        addJobStatus.style.display = "none";
        addJobUrl.focus();
      });
      
      addJobCancel.addEventListener("click", () => {
        addJobModal.style.display = "none";
      });
      
      addJobModal.addEventListener("click", (e) => {
        if (e.target === addJobModal) {
          addJobModal.style.display = "none";
        }
      });
      
      addJobSubmit.addEventListener("click", async () => {
        const url = addJobUrl.value.trim();
        if (!url) {
          addJobStatus.style.display = "block";
          addJobStatus.style.background = "rgba(255,100,100,0.2)";
          addJobStatus.textContent = "Please enter a job URL";
          return;
        }
        
        addJobSubmit.disabled = true;
        addJobSubmit.textContent = "Searching...";
        addJobStatus.style.display = "block";
        addJobStatus.style.background = "rgba(100,150,255,0.2)";
        addJobStatus.textContent = "Checking if job exists in database...";
        
        try {
          // Step 1: Search for existing job
          const searchRes = await fetch(`/job/find-by-url?url=${encodeURIComponent(url)}`);
          const searchData = await searchRes.json();
          
          if (searchData.ok && searchData.found) {
            // Job exists - show it with Open button
            const job = searchData.job;
            const jobId = job.id || job.ats_job_id;
            addJobStatus.style.background = "rgba(100,200,100,0.2)";
            addJobStatus.innerHTML = `
              <strong>‚úÖ Found in database:</strong><br>
              <span style="font-size: 14px;">${job.title || 'Unknown'}</span><br>
              <span style="color: #888;">${job.company || 'Unknown'} ‚Ä¢ ${job.location || ''}</span><br>
              <div style="margin-top: 8px;">
                <button id="showInTableBtn"
                        style="padding: 4px 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                  Show in Table ‚Üí
                </button>
                <button onclick="document.getElementById('addJobModal').style.display='none'" 
                        style="padding: 4px 12px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  Close
                </button>
              </div>
            `;
            // Add click handler for Show in Table
            document.getElementById('showInTableBtn').onclick = () => {
              document.getElementById('addJobModal').style.display = 'none';
              // Find and highlight row in table
              const atsJobId = job.ats_job_id || '';
              const jobId = job.id || '';
              const rows = document.querySelectorAll('#jobsTable tbody tr');
              for (const row of rows) {
                if ((atsJobId && row.dataset.atsJobId === atsJobId) || 
                    (jobId && row.dataset.jobId === jobId)) {
                  // Scroll to row
                  row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  // Highlight row
                  row.style.transition = 'background 0.3s';
                  row.style.background = 'rgba(100,200,100,0.3)';
                  setTimeout(() => { row.style.background = ''; }, 3000);
                  break;
                }
              }
            };
            addJobSubmit.disabled = false;
            addJobSubmit.textContent = "Add Job";
            return;
          }
          
          // Step 2: Job not found - add it
          addJobStatus.textContent = "Job not found, adding to pipeline...";
          addJobSubmit.textContent = "Adding...";
          
          const response = await fetch("/onboard", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url: url })
          });
          
          const data = await response.json();
          
          if (data.ok) {
            addJobStatus.style.background = "rgba(100,200,100,0.2)";
            addJobStatus.innerHTML = `<strong>‚úÖ Added:</strong> ${data.job?.title || 'Unknown'} at ${data.job?.company || 'Unknown'}`;
            // Reload jobs
            setTimeout(() => {
              addJobModal.style.display = "none";
              loadJobsFromCache(true);  // Force reload to show new job
            }, 1500);
          } else {
            addJobStatus.style.background = "rgba(255,100,100,0.2)";
            addJobStatus.textContent = `Error: ${data.message || 'Failed to add job'}`;
          }
        } catch (err) {
          addJobStatus.style.background = "rgba(255,100,100,0.2)";
          addJobStatus.textContent = `Error: ${err.message}`;
        } finally {
          addJobSubmit.disabled = false;
          addJobSubmit.textContent = "Add Job";
        }
      });
      
      // Enter key to submit
      addJobUrl.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          addJobSubmit.click();
        }
      });

      // Add Company Modal
      const modal = document.getElementById("addCompanyModal");
      
      document.getElementById("addCompanyBtn").addEventListener("click", () => {
        modal.classList.add("open");
        document.getElementById("newCompanyName").focus();
      });

      // Sync to PROD button (DEV only)
      document.getElementById("syncToProdBtn").addEventListener("click", async () => {
        const btn = document.getElementById("syncToProdBtn");
        btn.disabled = true;
        btn.textContent = "üîÑ Syncing...";
        
        try {
          const res = await fetch("/sync-to-prod", { method: "POST" });
          const data = await res.json();
          
          if (data.ok) {
            alert(`‚úÖ Sync complete!\n\nCompanies: +${data.companies.added} (total: ${data.companies.total})\nJobs: +${data.jobs.added} (total: ${data.jobs.total})`);
          } else {
            alert(`‚ùå Sync failed: ${data.error}`);
          }
        } catch (e) {
          alert(`‚ùå Sync error: ${e.message}`);
        } finally {
          btn.disabled = false;
          btn.textContent = "üîÑ Sync to PROD";
        }
      });
      
      document.getElementById("cancelAddCompany").addEventListener("click", () => {
        modal.classList.remove("open");
        clearAddCompanyForm();
      });
      
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.remove("open");
          clearAddCompanyForm();
        }
      });
      
      function clearAddCompanyForm() {
        document.getElementById("newCompanyName").value = "";
        document.getElementById("newCompanyUrl").value = "";
        document.getElementById("newCompanyIndustry").value = "";
        document.getElementById("newCompanyAts").value = "greenhouse";
      }
      
      document.getElementById("confirmAddCompany").addEventListener("click", async () => {
        const name = document.getElementById("newCompanyName").value.trim();
        const ats = document.getElementById("newCompanyAts").value;
        const board_url = document.getElementById("newCompanyUrl").value.trim();
        const industry = document.getElementById("newCompanyIndustry").value.trim();
        
        if (!name || !board_url) {
          alert("Please fill in Company Name and Board URL");
          return;
        }
        
        const btn = document.getElementById("confirmAddCompany");
        btn.disabled = true;
        btn.textContent = "Adding...";
        
        try {
          const res = await fetch("/companies", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, ats, board_url, industry, tags: [] })
          });
          const data = await res.json();
          
          if (data.status === "ok") {
            modal.classList.remove("open");
            clearAddCompanyForm();
            await loadCompanies();
          } else {
            alert(data.error || "Failed to add company");
          }
        } catch (err) {
          console.error(err);
          alert("Failed to add company");
        } finally {
          btn.disabled = false;
          btn.textContent = "Add";
        }
      });
    </script>
  </body>
</html>
