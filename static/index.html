<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Job Tracker</title>
    <style>
      :root {
        --bg: #0b0f17;
        --panel: #111827;
        --panel2: #0f172a;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: rgba(255, 255, 255, 0.1);
        --accent: #60a5fa;
        --danger: #ef4444;
        --ok: #22c55e;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Arial;
        background: var(--bg);
        color: var(--text);
      }
      header {
        padding: 18px 18px 10px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          transparent
        );
      }
      h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }
      .sub {
        margin-top: 6px;
        color: var(--muted);
        font-size: 12px;
      }
      .wrap {
        padding: 14px 18px 24px;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 12px;
        align-items: end;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      select,
      input,
      button {
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 10px;
        font-size: 13px;
        outline: none;
      }
      input {
        min-width: 210px;
      }
      select {
        min-width: 160px;
      }
      button {
        cursor: pointer;
      }
      button.primary {
        background: rgba(96, 165, 250, 0.15);
        border-color: rgba(96, 165, 250, 0.35);
      }
      button.primary:hover {
        background: rgba(96, 165, 250, 0.22);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .pill {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
        padding: 8px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--muted);
        display: inline-block;
      }
      .dot.ok {
        background: var(--ok);
      }
      .dot.bad {
        background: var(--danger);
      }

      .tableWrap {
        margin-top: 14px;
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        background: var(--panel2);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: rgba(255, 255, 255, 0.04);
      }
      th,
      td {
        padding: 10px 10px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        vertical-align: top;
      }
      th {
        text-align: left;
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }
      tr:hover td {
        background: rgba(255, 255, 255, 0.02);
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .tabBtn {
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
      }
      .tabBtn.active {
        background: rgba(96, 165, 250, 0.18);
        border-color: rgba(96, 165, 250, 0.45);
      }
      .view {
        display: none;
      }
      .view.active {
        display: block;
      }

      /* Status select in table */
      .statusSel {
        min-width: 130px;
      }
      .updatedCell {
        line-height: 1.25;
        white-space: nowrap;
      }
      .updatedCell .t {
        color: var(--muted);
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Job Tracker</h1>
      <div class="sub">
        <span id="jobsCount">Not loaded yet</span>
      </div>
      <div class="tabs">
        <button id="tabJobs" class="tabBtn active" type="button">Jobs</button>
        <button id="tabCompanies" class="tabBtn" type="button">
          Companies
        </button>
      </div>
    </header>

    <div class="wrap">
      <div id="jobsView" class="view active">
        <div class="controls">
          <label>
            Profile
            <select id="profileFilter">
              <option value="all">All companies</option>
              <option value="bigtech">BigTech</option>
              <option value="fintech">Fintech</option>
              <option value="core_pm">Core PM</option>
              <option value="core_product">Core Product</option>
            </select>
          </label>

          <label>
            ATS
            <select id="atsFilter">
              <option value="all">All</option>
              <option value="greenhouse">Greenhouse</option>
              <option value="lever">Lever</option>
              <option value="smartrecruiters">SmartRecruiters</option>
            </select>
          </label>

          <label>
            Geo priority
            <select id="geoMode">
              <option value="nc_priority" selected>
                NC/Raleigh + Neighbor + Remote USA
              </option>
              <option value="local_only">Local only (Raleigh area)</option>
              <option value="neighbor_only">Neighbor states only</option>
              <option value="remote_usa">Remote USA only</option>
              <option value="all">All locations</option>
            </select>
          </label>

          <label>
            Role
            <select id="roleFilter">
              <option value="all">All</option>
              <option value="product">Product</option>
              <option value="program">Program</option>
              <option value="project">Project</option>
            </select>
          </label>

          <label>
            Location
            <select id="locationFilter">
              <option value="all">All</option>
              <option value="us">US</option>
              <option value="nonus">Non-US</option>
            </select>
          </label>

          <label>
            Company contains
            <input id="companyFilter" placeholder="e.g., fidelity" />
          </label>

          <label>
            Search (title/location/company)
            <input
              id="searchFilter"
              placeholder="e.g., TPM, product owner, Raleigh"
            />
          </label>

          <button id="loadBtn" class="primary" type="button">Load jobs</button>
          <span class="pill"
            ><span class="dot" id="loadDot"></span
            ><span id="loadText">Idle</span></span
          >
        </div>

        <div class="tableWrap">
          <table id="jobsTable">
            <thead>
              <tr>
                <th style="width: 150px">Company</th>
                <th>Title</th>
                <th style="width: 280px">Location</th>
                <th style="width: 120px">Updated</th>
                <th style="width: 120px">ATS</th>
                <th style="width: 150px">Application</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="muted" style="margin-top: 10px">
          Tip: Load jobs once, then filters apply instantly.
        </div>
      </div>

      <div id="companiesView" class="view">
        <div class="muted">
          Companies view is unchanged in Iteration 1 (we only implemented Job
          status + date/time formatting).
        </div>
      </div>
    </div>

    <script>
      let ALL_JOBS = [];
      let LAST_LOADED_AT = null;

      const STATUS_OPTIONS = ["New", "Applied", "Answered", "Rejected"];

      function escapeHtml(s) {
        return (s || "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      function escapeAttr(s) {
        return (s || "").replace(/"/g, "&quot;");
      }

      function setLoading(isLoading, text) {
        const btn = document.getElementById("loadBtn");
        const dot = document.getElementById("loadDot");
        const label = document.getElementById("loadText");

        btn.disabled = isLoading;
        label.textContent = text;

        dot.classList.remove("ok", "bad");
        if (isLoading) dot.classList.add("bad");
        if (!isLoading && text === "Loaded") dot.classList.add("ok");
        if (!isLoading && text === "Error") dot.classList.add("bad");
      }

      function formatUpdatedTwoLines(iso) {
        // show: YYYY-MM-DD and HH (no minutes) as requested
        if (!iso) return { date: "", hour: "" };
        try {
          const d = new Date(iso);
          if (isNaN(d.getTime())) return { date: iso.slice(0, 10), hour: "" };
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, "0");
          const dd = String(d.getDate()).padStart(2, "0");
          const hh = String(d.getHours()).padStart(2, "0");
          return { date: `${yyyy}-${mm}-${dd}`, hour: `${hh}` };
        } catch (e) {
          return { date: iso.slice(0, 10), hour: "" };
        }
      }

      async function postJobStatus(job, status) {
        const jobUrl = job.job_url || job.url || "";
        if (!jobUrl) return;

        const payload = {
          job_url: jobUrl,
          status,
          company: job.company || "",
          title: job.title || "",
        };

        const res = await fetch("/job_status", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
      }

      function renderJobs(jobs) {
        const tbody = document.querySelector("#jobsTable tbody");
        tbody.innerHTML = "";

        for (const job of jobs) {
          const url = job.job_url || job.url || "#";
          const status = job.application_status || "New";
          const upd = formatUpdatedTwoLines(job.updated_at || "");
          const updatedTitle = job.updated_at || "";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(job.company || "")}</td>
            <td><a href="${escapeAttr(
              url
            )}" target="_blank" rel="noopener">${escapeHtml(
            job.title || ""
          )}</a></td>
            <td>${escapeHtml(job.location || "")}</td>
            <td class="updatedCell" title="${escapeAttr(updatedTitle)}">
              <div>${escapeHtml(upd.date)}</div>
              <div class="t">${escapeHtml(upd.hour)}</div>
            </td>
            <td>${escapeHtml(job.ats || "")}</td>
            <td>
              <select class="statusSel">
                ${STATUS_OPTIONS.map(
                  (opt) =>
                    `<option value="${opt}" ${
                      opt === status ? "selected" : ""
                    }>${opt}</option>`
                ).join("")}
              </select>
            </td>
          `;

          const sel = tr.querySelector("select");
          sel.addEventListener("change", async (e) => {
            const newStatus = e.target.value;
            try {
              await postJobStatus(job, newStatus);
              job.application_status = newStatus; // update in-memory
            } catch (err) {
              console.error(err);
              alert("Failed to update status. Check server logs.");
              e.target.value = job.application_status || "New";
            }
          });

          tbody.appendChild(tr);
        }

        const statusSpan = document.getElementById("jobsCount");
        const baseText = LAST_LOADED_AT
          ? `Loaded: ${ALL_JOBS.length} jobs at ${LAST_LOADED_AT}`
          : "Not loaded yet";
        statusSpan.textContent = baseText;
      }

      async function loadJobsOnce() {
        const profile = document.getElementById("profileFilter").value;
        const ats = document.getElementById("atsFilter").value;
        const geoMode = document.getElementById("geoMode").value;

        setLoading(true, "Loadingâ€¦");
        try {
          const url = `/jobs?profile=${encodeURIComponent(
            profile
          )}&ats_filter=${encodeURIComponent(
            ats
          )}&role_filter=all&location_filter=all&geo_mode=${encodeURIComponent(
            geoMode
          )}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          ALL_JOBS = data.jobs || [];
          LAST_LOADED_AT = new Date().toLocaleString();

          renderJobs(ALL_JOBS);
          setLoading(false, "Loaded");
        } catch (e) {
          console.error(e);
          ALL_JOBS = [];
          LAST_LOADED_AT = null;
          renderJobs([]);
          setLoading(false, "Error");
          alert(
            "Failed to load jobs. Check terminal logs (uvicorn) and /jobs endpoint."
          );
        }
      }

      // Tabs
      function activateTab(which) {
        const jobsBtn = document.getElementById("tabJobs");
        const compBtn = document.getElementById("tabCompanies");
        const jobsView = document.getElementById("jobsView");
        const compView = document.getElementById("companiesView");

        if (which === "companies") {
          jobsBtn.classList.remove("active");
          compBtn.classList.add("active");
          jobsView.classList.remove("active");
          compView.classList.add("active");
        } else {
          compBtn.classList.remove("active");
          jobsBtn.classList.add("active");
          compView.classList.remove("active");
          jobsView.classList.add("active");
        }
      }

      document
        .getElementById("loadBtn")
        .addEventListener("click", loadJobsOnce);
      document
        .getElementById("tabJobs")
        .addEventListener("click", () => activateTab("jobs"));
      document
        .getElementById("tabCompanies")
        .addEventListener("click", () => activateTab("companies"));
    </script>
  </body>
</html>
